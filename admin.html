<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>プライオリティパス管理画面（NFC対応）</title>
<style>
body { font-family: "Segoe UI", sans-serif; padding: 15px; background: #fefbd8; max-width: 900px; margin: auto; color: #333; }
h1, h2 { text-align: center; color: #444; }
.table-container { overflow-x: auto; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); background: white; border-radius: 6px; }
table { width: 100%; border-collapse: collapse; min-width: 600px; }
th, td { border: 1px solid #ddd; padding: 10px 8px; text-align: center; vertical-align: middle; font-size: 14px; }
th { background-color: #f0e68c; color: #333; font-weight: 600; }
tr:nth-child(even) { background-color: #fafafa; }
button { padding: 6px 10px; font-size: 0.9rem; cursor: pointer; border: none; border-radius: 4px; transition: background-color 0.3s ease; margin: 2px 0; width: 100%; max-width: 120px; }
.btn-delete { background-color: #e74c3c; color: white; }
.btn-delete:hover { background-color: #c0392b; }
.btn-toggle-used { background-color: #3498db; color: white; }
.btn-toggle-used:hover { background-color: #2980b9; }
.status-used { color: green; font-weight: bold; }
.status-unused { color: red; font-weight: bold; }
.status-expired { color: darkorange; font-weight: bold; }
#deleteAllBtn { background-color: #d32f2f; color: white; margin: 20px auto 0 auto; display: block; max-width: 180px; font-weight: bold; box-shadow: 0 4px 10px rgba(211, 47, 47, 0.4); transition: background-color 0.3s ease; }
#deleteAllBtn:hover { background-color: #9b1d1d; }
#loginDiv { max-width: 400px; margin:auto; padding:20px; background:#fff; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
#loginDiv input { width:100%; padding:10px; margin:8px 0; box-sizing:border-box; }
#loginDiv button { width:100%; padding:10px; background:#007bff; color:white; border:none; border-radius:5px; font-size:16px; cursor:pointer; margin-top:5px; }
#loginDiv button:hover { background:#0056b3; }
#errorMsg { color:red; margin-top:10px; text-align:center; }
#mainContent { display:none; }
#logoutBtn { margin-top:10px; padding:8px 16px; background:#e74c3c; color:white; border:none; border-radius:5px; cursor:pointer; }
#logoutBtn:hover { background:#c0392b; }
#accessLogs { border:1px solid #ccc; background:#fff; padding:10px; max-height:300px; overflow-y:auto; color:black; font-size:0.85rem; margin-top:20px; }
#nfcAuthDiv { display:none; max-width:400px; margin:auto; padding:20px; background:#fff; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center; color:red; }
@media (max-width: 600px) { body { padding: 10px 8px; } th, td { font-size: 12px; padding: 8px 6px; } button { font-size: 0.85rem; max-width: 100px; } #deleteAllBtn { max-width: 100%; margin-top: 15px; } }
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, orderBy, onSnapshot, doc, deleteDoc, updateDoc, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebase初期化
const firebaseConfig = {
  apiKey: "AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
  authDomain: "fastpass-system.firebaseapp.com",
  projectId: "fastpass-system"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const allowedAdmins = [
  { id: "Sakoty", password: "3214" },
  { id: "seseguchi914", password: "0914" }
];

const loginDiv = document.getElementById("loginDiv");
const mainContent = document.getElementById("mainContent");
const errorMsg = document.getElementById("errorMsg");
const logsDiv = document.getElementById("accessLogs");

// NFC認証用表示
const nfcAuthDiv = document.createElement("div");
nfcAuthDiv.id = "nfcAuthDiv";
nfcAuthDiv.textContent = "カードをかざしてください...";
document.body.appendChild(nfcAuthDiv);

// ログアクセス関数
async function logAccess(adminId, action, page){
  try { await addDoc(collection(db,"accessLogs"),{ timestamp:new Date(), adminId, action, page }); }
  catch(err){ console.error("ログ記録エラー:",err); }
}

// ログイン処理
window.addEventListener("DOMContentLoaded", ()=>{
  const storedId = localStorage.getItem("adminId");
  const storedPass = localStorage.getItem("adminPass");
  if(storedId && storedPass && allowedAdmins.some(a=>a.id===storedId && a.password===storedPass)){
    loginDiv.style.display = "none";
    mainContent.style.display = "block";
    startApp();
  }
});

// パスワードログイン
document.getElementById("loginForm").onsubmit = e => {
  e.preventDefault();
  const inputId = document.getElementById("adminId").value.trim();
  const inputPass = document.getElementById("adminPass").value;
  if(allowedAdmins.some(a => a.id === inputId && a.password === inputPass)){
    localStorage.setItem("adminId", inputId);
    localStorage.setItem("adminPass", inputPass);
    loginDiv.style.display = "none";
    mainContent.style.display = "block";
    errorMsg.textContent = "";
    startApp();
  } else { errorMsg.textContent = "IDまたはパスワードが違います"; }
};

// NFCログインボタン追加
const nfcLoginBtn = document.createElement("button");
nfcLoginBtn.textContent = "NFCカードでログイン";
loginDiv.appendChild(nfcLoginBtn);

nfcLoginBtn.onclick = ()=>{ initNFC(true); };

// Socket.IO経由でNFC認証
function initNFC(isLogin=false, callback=null){
  const script=document.createElement("script");
  script.src="https://cdn.socket.io/4.7.1/socket.io.min.js";
  script.onload=()=>{
    const socket=io("http://localhost:3000");
    socket.on("nfc-auth", data=>{
      if(data.success){
        if(isLogin){
          localStorage.setItem("adminId","NFC:"+data.uid);
          loginDiv.style.display="none";
          mainContent.style.display="block";
          startApp();
          logAccess("NFC:"+data.uid,"NFCログイン","login");
        } else if(callback) callback(true);
      }
      if(data.removed && !isLogin && callback) callback(false);
    });
  };
  document.body.appendChild(script);
}

function startApp(){
  const logoutBtn = document.getElementById("logoutBtn");
  logoutBtn.onclick = ()=>{ localStorage.removeItem("adminId"); localStorage.removeItem("adminPass"); loginDiv.style.display="block"; mainContent.style.display="none"; };

  const passesRef = collection(db, "passes");
  const q = query(passesRef, orderBy("createdAt","desc"));

  function renderPasses(docs){
    const tbody = document.getElementById("passesTableBody");
    tbody.innerHTML="";
    docs.forEach(docSnap=>{
      const data = docSnap.data(); const id = docSnap.id;
      const expired = false; // 必要に応じて判定
      let usedStatusText="", usedStatusClass="";
      if(expired){ usedStatusText="期限切れ"; usedStatusClass="status-expired"; }
      else if(data.used){ usedStatusText="使用済み"; usedStatusClass="status-used"; }
      else { usedStatusText="未使用"; usedStatusClass="status-unused"; }

      const tr = document.createElement("tr");
      tr.innerHTML=`
        <td>${data.id||"-"}</td>
        <td>${data.name||"-"}</td>
        <td>${data.numPeople||"-"}</td>
        <td>${data.time||"-"}</td>
        <td>${data.type||"-"}</td>
        <td class="${usedStatusClass}">${usedStatusText}</td>
        <td>
          <button class="btn-toggle-used">${data.used ? "未使用に戻す":"使用済みにする"}</button><br>
          <button class="btn-delete">削除</button>
        </td>
      `;

      // 使用済み切替
      tr.querySelector(".btn-toggle-used").onclick = async()=>{
        await updateDoc(doc(db,"passes",id),{used:!data.used});
        await logAccess(localStorage.getItem("adminId"),`使用済み切替: ${data.id}`,"admin");
      };

      // 削除（NFC認証必須）
      tr.querySelector(".btn-delete").onclick = ()=>{
        nfcAuthDiv.style.display="block";
        initNFC(false, async (success)=>{
          if(success){
            await deleteDoc(doc(db,"passes",id));
            nfcAuthDiv.style.display="none";
            await logAccess(localStorage.getItem("adminId"),`削除: ${data.id}`,"admin");
            alert("削除しました");
          } else {
            nfcAuthDiv.textContent="NFC認証失敗";
            setTimeout(()=>{ nfcAuthDiv.style.display="none"; nfcAuthDiv.textContent="カードをかざしてください..."; },2000);
          }
        });
      };

      tbody.appendChild(tr);
    });
  }

  onSnapshot(q, snapshot=>{ renderPasses(snapshot.docs); });

  document.getElementById("deleteAllBtn").onclick = ()=>{
    nfcAuthDiv.style.display="block";
    initNFC(false, async (success)=>{
      if(success){
        const snapshot = await getDocs(passesRef);
        await Promise.all(snapshot.docs.map(d=>deleteDoc(doc(db,"passes",d.id))));
        await logAccess(localStorage.getItem("adminId"),"全件削除","admin");
        nfcAuthDiv.style.display="none";
        alert("全件削除しました");
      } else {
        nfcAuthDiv.textContent="NFC認証失敗";
        setTimeout(()=>{ nfcAuthDiv.style.display="none"; nfcAuthDiv.textContent="カードをかざしてください..."; },2000);
      }
    });
  };

  // リアルタイム操作ログ
  const logsRef = collection(db, "accessLogs");
  const logsQuery = query(logsRef, orderBy("timestamp", "desc"));
  onSnapshot(logsQuery, snapshot => {
    logsDiv.innerHTML = "";
    snapshot.forEach(docSnap=>{
      const data = docSnap.data();
      const timeStr = data.timestamp?.toDate()?.toLocaleString() || "-";
      const logLine = document.createElement("div");
      logLine.textContent = `${timeStr} | ${data.adminId || "-"} | ${data.page || "-"} | ${data.action}`;
      logsDiv.appendChild(logLine);
    });
  });
}
</script>
</head>
<body>
<div id="loginDiv">
  <h1>管理者ログイン</h1>
  <form id="loginForm">
    <input type="text" id="adminId" placeholder="管理者ID">
    <input type="password" id="adminPass" placeholder="パスワード">
    <button type="submit">ログイン</button>
    <div id="errorMsg"></div>
  </form>
</div>

<div id="mainContent">
  <h1>プライオリティパス管理画面</h1>
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>発券ID</th>
          <th>名前</th>
          <th>人数</th>
          <th>案内時間</th>
          <th>種別</th>
          <th>状態</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="passesTableBody"></tbody>
    </table>
  </div>
  <button id="deleteAllBtn">すべてのプライオリティパスを一括削除</button>
  <h2>操作ログ</h2>
  <div id="accessLogs"></div>
  <button id="logoutBtn">ログアウト</button>
</div>
</body>
</html>
