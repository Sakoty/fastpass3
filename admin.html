<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>FastPass ç®¡ç†ç”»é¢</title>

<style>
body{
    font-family:sans-serif;
    background:#111;
    color:white;
    padding:20px;
}

.hidden{
    display:none;
}

.panel{
    background:#222;
    padding:20px;
    margin-bottom:20px;
    border-radius:10px;
}

button{
    padding:10px;
    background:#00c3ff;
    border:none;
    color:white;
    cursor:pointer;
}
</style>
</head>

<body>

<h1>ğŸ« FastPass ç®¡ç†ç”»é¢</h1>

<div id="loginArea">
    <button id="loginBtn">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
</div>

<div id="adminArea" class="hidden">

<div class="panel">
<h2>æ–°ã—ã„ãƒ‘ã‚¹ä½œæˆ</h2>

<input id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
<input id="maxUses" type="number" placeholder="æœ€å¤§äººæ•°">
<input id="expire" type="datetime-local">

<button onclick="createPassword()">ä½œæˆ</button>
</div>

<div class="panel">
<h2>ç¾åœ¨ã®ãƒ‘ã‚¹ä¸€è¦§</h2>
<div id="list"></div>
</div>

</div>

<script type="module">

// =====================
// Firebaseèª­ã¿è¾¼ã¿
// =====================
import { initializeApp }
from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";

import {
getFirestore,
collection,
addDoc,
getDocs,
updateDoc,
doc,
getDoc,
Timestamp
}
from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

import {
getAuth,
GoogleAuthProvider,
signInWithPopup,
onAuthStateChanged
}
from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";


// =====================
// Firebaseè¨­å®š
// =====================
const firebaseConfig = {
  // â†ã‚ãªãŸã®è¨­å®š
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const provider = new GoogleAuthProvider();

const loginBtn = document.getElementById("loginBtn");
const adminArea = document.getElementById("adminArea");
const loginArea = document.getElementById("loginArea");
const listDiv = document.getElementById("list");


// =====================
// ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
// =====================
loginBtn.onclick = async ()=>{
    await signInWithPopup(auth,provider);
};


// =====================
// ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç›£è¦–
// =====================
onAuthStateChanged(auth, async(user)=>{

    if(!user){
        adminArea.classList.add("hidden");
        loginArea.classList.remove("hidden");
        return;
    }

    // ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯
    const adminRef = doc(db,"admins",user.uid);
    const adminSnap = await getDoc(adminRef);

    if(!adminSnap.exists()){
        alert("ç®¡ç†è€…æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“");
        adminArea.classList.add("hidden");
        return;
    }

    // ç®¡ç†è€…OK
    loginArea.classList.add("hidden");
    adminArea.classList.remove("hidden");

    loadPasswords();
});


// =====================
// ãƒ‘ã‚¹ä½œæˆ
// =====================
window.createPassword = async ()=>{

    const password =
        document.getElementById("password").value;

    const maxUses =
        Number(document.getElementById("maxUses").value);

    const expire =
        new Date(document.getElementById("expire").value);

    await addDoc(collection(db,"passwords"),{
        password,
        enabled:true,
        maxUses,
        usedCount:0,
        expireAt:Timestamp.fromDate(expire),
        createdAt:Timestamp.now()
    });

    loadPasswords();
};


// =====================
// ä¸€è¦§è¡¨ç¤º
// =====================
async function loadPasswords(){

    listDiv.innerHTML="";

    const snap = await getDocs(collection(db,"passwords"));

    snap.forEach(d=>{

        const data = d.data();

        const div=document.createElement("div");

        div.innerHTML=`
        ${data.password}
        | ${data.enabled?"æœ‰åŠ¹":"ç„¡åŠ¹"}
        | ä½¿ç”¨ ${data.usedCount}/${data.maxUses}
        <button onclick="toggle('${d.id}',${data.enabled})">
        ${data.enabled?"åœæ­¢":"æœ‰åŠ¹åŒ–"}
        </button>
        `;

        listDiv.appendChild(div);
    });
}


// =====================
// æœ‰åŠ¹åˆ‡æ›¿
// =====================
window.toggle = async(id,current)=>{

    await updateDoc(doc(db,"passwords",id),{
        enabled:!current
    });

    loadPasswords();
};

</script>

</body>
</html>
