<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ファストパス管理（NFC削除対応フル版）</title>
<style>
body{font-family:"Segoe UI",sans-serif;padding:15px;background:#f5f7fa;}
h1{text-align:center;}
.table-container{overflow-x:auto;margin-top:20px;background:white;padding:10px;border-radius:8px;}
table{width:100%;border-collapse:collapse;}
th,td{border:1px solid #ccc;padding:8px;text-align:center;}
button{padding:6px 12px;margin:2px;border:none;border-radius:5px;cursor:pointer;}
.btn-delete{background:#e74c3c;color:white;}
.btn-toggle{background:#3498db;color:white;}
.btn-delete-all{background:#c0392b;color:white;margin-top:10px;}
.status-used{color:green;font-weight:bold;}
.status-unused{color:red;font-weight:bold;}
#loginDiv,#nfcAuthDiv{max-width:400px;margin:auto;padding:20px;background:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);}
#loginDiv input,#nfcAuthDiv input{width:100%;padding:10px;margin:8px 0;box-sizing:border-box;}
#loginDiv button,#nfcAuthDiv button{width:100%;padding:10px;background:#007bff;color:white;border:none;border-radius:5px;font-size:16px;cursor:pointer;}
#errorMsg,#nfcMsg{text-align:center;color:red;}
</style>
</head>
<body>

<div id="loginDiv">
  <h1>管理者ログイン</h1>
  <button id="cardLoginBtn">カードでログイン</button>
  <button id="passLoginBtn">パスワードでログイン</button>
  <div id="passForm" style="display:none;">
    <input type="text" id="adminId" placeholder="管理者ID">
    <input type="password" id="adminPass" placeholder="パスワード">
    <button id="loginSubmit">ログイン</button>
    <div id="errorMsg"></div>
  </div>
</div>

<div id="mainContent" style="display:none;">
  <h1>ファストパス管理画面</h1>
  <div class="table-container">
    <table>
      <thead>
        <tr><th>ID</th><th>名前</th><th>人数</th><th>時間</th><th>状態</th><th>操作</th></tr>
      </thead>
      <tbody id="passesTable"></tbody>
    </table>
    <button class="btn-delete-all" id="deleteAllBtn">全件削除</button>
  </div>
  <button id="logoutBtn" style="margin-top:10px;">ログアウト</button>
</div>

<div id="nfcAuthDiv" style="display:none;">
  <h2>削除用NFCカード認証</h2>
  <p>カードをかざしてください...</p>
  <div id="nfcMsg"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, deleteDoc, doc, updateDoc, onSnapshot, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebase初期化
const firebaseConfig = { apiKey:"AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y", authDomain:"fastpass-system.firebaseapp.com", projectId:"fastpass-system" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// 管理者リスト
const allowedAdmins = [
  {id:"Sakoty", password:"3214"},
  {id:"seseguchi914", password:"0914"}
];

// DOM
const loginDiv=document.getElementById("loginDiv");
const passForm=document.getElementById("passForm");
const mainContent=document.getElementById("mainContent");
const errorMsg=document.getElementById("errorMsg");
const passesTable=document.getElementById("passesTable");
const nfcAuthDiv=document.getElementById("nfcAuthDiv");
const nfcMsg=document.getElementById("nfcMsg");

// ログイン
document.getElementById("passLoginBtn").onclick = ()=> passForm.style.display="block";
document.getElementById("loginSubmit").onclick = ()=>{
  const id=document.getElementById("adminId").value.trim();
  const pass=document.getElementById("adminPass").value.trim();
  if(allowedAdmins.some(a=>a.id===id && a.password===pass)) loginSuccess(id);
  else errorMsg.textContent="IDまたはパスワードが違います";
};

// NFCログイン
document.getElementById("cardLoginBtn").onclick = ()=>{ initNFC(true); };

// Socket.IO経由でNFC認証
function initNFC(isLogin=false, callback=null){
  const script=document.createElement("script");
  script.src="https://cdn.socket.io/4.7.1/socket.io.min.js";
  script.onload=()=>{
    const socket=io("http://localhost:3000");
    socket.on("nfc-auth", data=>{
      if(data.success){
        if(isLogin) loginSuccess("NFC:"+data.uid);
        else if(callback) callback(true);
      }
      if(data.removed && !isLogin && callback) callback(false);
    });
  };
  document.body.appendChild(script);
}

// ログイン成功
function loginSuccess(adminId){
  loginDiv.style.display="none";
  mainContent.style.display="block";
  localStorage.setItem("adminId", adminId);
  logAccess(adminId,"ログイン成功");
  loadPasses();
}

// ログアウト
document.getElementById("logoutBtn").onclick = ()=>{
  logAccess(localStorage.getItem("adminId")||"不明","ログアウト");
  localStorage.removeItem("adminId");
  loginDiv.style.display="block";
  mainContent.style.display="none";
};

// パス一覧取得
async function loadPasses(){
  const q=collection(db,"passes");
  onSnapshot(q,snap=>{
    passesTable.innerHTML="";
    snap.forEach(docSnap=>{
      const data=docSnap.data();
      const tr=document.createElement("tr");
      const status=data.used?"使用済み":"未使用";
      tr.innerHTML=`
        <td>${data.id||"-"}</td>
        <td>${data.name||"-"}</td>
        <td>${data.numPeople||"-"}</td>
        <td>${data.start||"-"}〜${data.end||"-"}</td>
        <td class="status-${data.used?"used":"unused"}">${status}</td>
        <td>
          <button class="btn-toggle">${data.used?"未使用に戻す":"使用済みにする"}</button>
          <button class="btn-delete">削除</button>
        </td>
      `;
      // 使用済み切替
      tr.querySelector(".btn-toggle").onclick = async ()=>{
        await updateDoc(doc(db,"passes",docSnap.id),{used:!data.used});
        logAccess(localStorage.getItem("adminId"),`使用済み切替: ${data.id}`);
      };
      // 削除（NFC認証必須）
      tr.querySelector(".btn-delete").onclick = ()=>{
        nfcAuthDiv.style.display="block";
        initNFC(false, async (success)=>{
          if(success){
            await deleteDoc(doc(db,"passes",docSnap.id));
            logAccess(localStorage.getItem("adminId"),`削除: ${data.id}`);
            nfcAuthDiv.style.display="none";
            nfcMsg.textContent="";
            alert(`パス ${data.id} を削除しました`);
          }else{
            nfcMsg.textContent="認証失敗";
            setTimeout(()=>{ nfcAuthDiv.style.display="none"; nfcMsg.textContent=""; },2000);
          }
        });
      };
      passesTable.appendChild(tr);
    });
  });
}

// 全件削除（NFC認証必須）
document.getElementById("deleteAllBtn").onclick = ()=>{
  if(!confirm("本当に全件削除しますか？")) return;
  nfcAuthDiv.style.display="block";
  initNFC(false, async (success)=>{
    if(success){
      const snap=await getDocs(collection(db,"passes"));
      for(const d of snap.docs){ await deleteDoc(doc(db,"passes",d.id)); }
      logAccess(localStorage.getItem("adminId"),`全件削除`);
      nfcAuthDiv.style.display="none";
      nfcMsg.textContent="";
      alert("全件削除しました");
    }else{
      nfcMsg.textContent="認証失敗";
      setTimeout(()=>{ nfcAuthDiv.style.display="none"; nfcMsg.textContent=""; },2000);
    }
  });
};

// アクセスログ記録
async function logAccess(adminId,action){
  await addDoc(collection(db,"accessLogs"),{adminId,action,createdAt:serverTimestamp()});
}
</script>

</body>
</html>
