<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>発券ページ</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    label { display: block; margin: 10px 0 5px; }
    input, button { width: 100%; padding: 10px; margin-bottom: 15px; font-size: 16px; }
    .ticket { border: 2px dashed #333; padding: 20px; text-align: center; }
    @media (max-width: 500px) {
      body { padding: 10px; font-size: 14px; }
      input, button { font-size: 14px; }
    }
  </style>
</head>
<body>
  <h1>整理券 発行ページ</h1>
  <label for="name">お名前</label>
  <input type="text" id="name" placeholder="例：山田 太郎"/>

  <label for="count">人数</label>
  <input type="number" id="count" min="1" value="1"/>

  <button id="issueBtn">整理券を発行</button>

  <div class="ticket" id="ticketArea" style="display:none;">
    <h2>整理番号: <span id="ticketId"></span></h2>
    <p>お名前: <span id="ticketName"></span></p>
    <p>人数: <span id="ticketCount"></span></p>
    <p>ご案内時間: <span id="guideTime"></span></p>
    <canvas id="qrcode"></canvas>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, getDocs, setDoc, doc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import QRCode from "https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
      authDomain: "fastpass-system.firebaseapp.com",
      projectId: "fastpass-system",
      storageBucket: "fastpass-system.appspot.com",
      messagingSenderId: "858745521872",
      appId: "1:858745521872:web:29289b673855097e1200d5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const issueBtn = document.getElementById("issueBtn");
    const nameInput = document.getElementById("name");
    const countInput = document.getElementById("count");

    issueBtn.addEventListener("click", async () => {
      const name = nameInput.value.trim();
      const count = parseInt(countInput.value, 10);
      if (!name || count <= 0) {
        alert("名前と人数を正しく入力してください");
        return;
      }

      const snapshot = await getDocs(collection(db, "tickets"));
      const ticketNumber = snapshot.size + 1;
      const ticketId = "SB" + String(ticketNumber).padStart(3, "0");

      // 案内時間を決定（9:00開始、1枚あたり5分刻み）
      const interval = 5;
      const baseHour = 9;
      const baseMinute = 0;
      const totalMinutes = baseHour * 60 + baseMinute + (ticketNumber - 1) * interval;
      const startHour = Math.floor(totalMinutes / 60);
      const startMin = totalMinutes % 60;
      const endHour = Math.floor((totalMinutes + interval) / 60);
      const endMin = (totalMinutes + interval) % 60;
      const guideTime = `${String(startHour).padStart(2, '0')}:${String(startMin).padStart(2, '0')}〜${String(endHour).padStart(2, '0')}:${String(endMin).padStart(2, '0')} にお越しください`;

      const ticketData = {
        id: ticketId,
        name,
        count,
        status: "valid",
        createdAt: new Date(),
        guideTime: guideTime
      };

      await setDoc(doc(db, "tickets", ticketId), ticketData);

      // 表示
      document.getElementById("ticketId").textContent = ticketId;
      document.getElementById("ticketName").textContent = name;
      document.getElementById("ticketCount").textContent = count;
      document.getElementById("guideTime").textContent = guideTime;
      document.getElementById("ticketArea").style.display = "block";

      const url = `https://fastpass3.vercel.app/scan.html?id=${ticketId}`;
      QRCode.toCanvas(document.getElementById("qrcode"), url, { width: 200 }, function (error) {
        if (error) console.error(error);
      });
    });
  </script>
</body>
</html>
