<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ファストパス発券ページ</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Nunito', sans-serif;
      background: linear-gradient(to bottom right, #d0eefd, #ffffff);
      margin: 0;
      padding: 1rem;
      color: #333;
    }

    .container {
      max-width: 500px;
      margin: auto;
      padding: 2rem;
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    h1 {
      text-align: center;
      color: #0077cc;
    }

    label {
      display: block;
      margin-top: 1rem;
    }

    input, select {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-top: 0.4rem;
    }

    button {
      width: 100%;
      padding: 0.8rem;
      margin-top: 1.5rem;
      background-color: #0077cc;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover {
      background-color: #005fa3;
    }

    #qrcode {
      text-align: center;
      margin-top: 2rem;
    }

    .info {
      text-align: center;
      margin-top: 1rem;
      font-size: 1.1rem;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ファストパス発券</h1>
    <label for="name">名前</label>
    <input type="text" id="name" placeholder="例：山田 太郎">

    <label for="count">人数</label>
    <input type="number" id="count" min="1" max="10">

    <button onclick="issueFastPass()">ファストパスを発券</button>

    <div id="qrcode"></div>
    <div class="info" id="info"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
      authDomain: "fastpass-system.firebaseapp.com",
      projectId: "fastpass-system",
      storageBucket: "fastpass-system.appspot.com",
      messagingSenderId: "858745521872",
      appId: "1:858745521872:web:29289b673855097e1200d5",
      measurementId: "G-SLPKMCNY53"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function issueFastPass() {
      const name = document.getElementById('name').value;
      const count = parseInt(document.getElementById('count').value);
      if (!name || !count) return alert("名前と人数を入力してください。");

      const settingDoc = await db.collection("setting").doc("config").get();
      const setting = settingDoc.data();
      if (!setting || !setting.enabled) return alert("現在、発券は停止中です。");

      const now = new Date();
      const start = new Date();
      start.setHours(setting.startHour, 0, 0, 0);
      const end = new Date();
      end.setHours(setting.endHour, 0, 0, 0);

      if (now < start || now > end) return alert("現在、発券可能時間外です。");

      const snap = await db.collection("fastpass").orderBy("createdAt", "desc").limit(1).get();
      let lastId = 0;
      if (!snap.empty) {
        const last = snap.docs[0].data();
        lastId = parseInt(last.id.replace("FP", "")) || 0;
      }
      const newId = `FP${String(lastId + 1).padStart(3, '0')}`;

      const minutes = Math.ceil(now.getMinutes() / 10) * 10;
      now.setMinutes(minutes);
      now.setSeconds(0);
      now.setMilliseconds(0);
      const time = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

      const data = {
        id: newId,
        name,
        count,
        time,
        used: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      await db.collection("fastpass").doc(newId).set(data);

      document.getElementById("info").innerText = `ID: ${newId}\n案内時間: ${time}`;
      QRCode.toCanvas(document.createElement("canvas"), newId, function (err, canvas) {
        if (!err) {
          document.getElementById("qrcode").innerHTML = "";
          document.getElementById("qrcode").appendChild(canvas);
        }
      });
    }
  </script>
</body>

</html>
