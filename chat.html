<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>チャット</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f0f0f0; }
    #app { display: flex; flex-direction: column; height: 100vh; }
    header { background: #4CAF50; color: white; padding: 10px; text-align: center; }
    #roomList, #chatArea { padding: 10px; overflow-y: auto; }
    #roomList { height: 30vh; background: white; }
    #chatArea { flex: 1; background: #e9e9e9; }
    .message { margin: 5px 0; padding: 5px; background: white; border-radius: 5px; }
    .message.mention { background: #ffffcc; }
    footer { display: flex; flex-direction: column; padding: 10px; background: white; }
    input, button { padding: 10px; margin: 5px 0; font-size: 1em; }
    #messages { max-height: 60vh; overflow-y: auto; }
    img.chat-image { max-width: 100%; max-height: 200px; border-radius: 8px; margin-top: 5px; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, setDoc, getDoc, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
      authDomain: "fastpass-system.firebaseapp.com",
      projectId: "fastpass-system",
      storageBucket: "fastpass-system.appspot.com",
      messagingSenderId: "858745521872",
      appId: "1:858745521872:web:29289b673855097e1200d5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentRoom = null;
    let userName = localStorage.getItem("chatUserName") || "";

    window.onload = () => {
      if (!userName) {
        userName = prompt("あなたの名前を入力してください");
        localStorage.setItem("chatUserName", userName);
      }
      listRooms();
    };

    async function listRooms() {
      const roomList = document.getElementById("roomList");
      roomList.innerHTML = "<h3>ルーム一覧</h3>";
      const roomsRef = collection(db, "rooms");
      const q = query(roomsRef, orderBy("lastMessageAt", "desc"));
      const snap = await getDocs(q);
      snap.forEach(docSnap => {
        const div = document.createElement("div");
        div.textContent = docSnap.id;
        div.style.cursor = "pointer";
        div.onclick = () => joinRoom(docSnap.id);
        roomList.appendChild(div);
      });
    }

    async function createRoom() {
      const name = prompt("ルーム名を入力してください");
      if (!name) return;
      await setDoc(doc(db, "rooms", name), { lastMessageAt: serverTimestamp() });
      joinRoom(name);
    }

    async function joinRoom(roomName) {
      currentRoom = roomName;
      document.getElementById("chatArea").innerHTML = `<h3>${roomName} のチャット</h3><div id="messages"></div>`;
      const messagesRef = collection(db, "rooms", roomName, "messages");
      const q = query(messagesRef, orderBy("createdAt"));

      onSnapshot(q, snapshot => {
        const messagesDiv = document.getElementById("messages");
        messagesDiv.innerHTML = "";
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const div = document.createElement("div");
          div.className = "message" + (data.text.includes("@" + userName) ? " mention" : "");
          div.innerHTML = `<b>${data.name}</b>: ${data.text}`;
          if (data.imageURL) {
            div.innerHTML += `<br><img src="${data.imageURL}" class="chat-image" />`;
          }
          if (!data.readUsers?.includes(userName)) {
            updateDoc(docSnap.ref, { readUsers: [...(data.readUsers || []), userName] });
          }
          messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    }

    async function sendMessage() {
      const text = document.getElementById("messageInput").value.trim();
      const imageInput = document.getElementById("imageInput");
      if (!text && !imageInput.files[0]) return;

      let imageURL = null;
      if (imageInput.files[0]) {
        const file = imageInput.files[0];
        const fileRef = ref(storage, `uploads/${currentRoom}/${Date.now()}_${file.name}`);
        await uploadBytes(fileRef, file);
        imageURL = await getDownloadURL(fileRef);
      }

      await addDoc(collection(db, "rooms", currentRoom, "messages"), {
        name: userName,
        text,
        imageURL,
        createdAt: serverTimestamp(),
        readUsers: [userName]
      });

      await updateDoc(doc(db, "rooms", currentRoom), {
        lastMessageAt: serverTimestamp()
      });

      document.getElementById("messageInput").value = "";
      imageInput.value = "";
    }
  </script>
</head>
<body>
  <div id="app">
    <header>
      <h1>業務チャット</h1>
      <button onclick="createRoom()">＋ルーム作成</button>
    </header>
    <div id="roomList"></div>
    <div id="chatArea"></div>
    <footer>
      <input type="text" id="messageInput" placeholder="メッセージまたは @名前" />
      <input type="file" id="imageInput" accept="image/*" />
      <button onclick="sendMessage()">送信</button>
    </footer>
  </div>
</body>
</html>
