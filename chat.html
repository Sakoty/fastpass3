<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ê•≠Âãô„ÉÅ„É£„ÉÉ„ÉàÔºà„É™„Ç¢„ÇØ„Ç∑„Éß„É≥ÂØæÂøúÔºâ</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: sans-serif; background-color: #f0f0f0; }
    #app { display: flex; flex-direction: column; height: 100vh; }

    @media (min-width: 600px) {
      #app { flex-direction: row; }
      aside#roomList { width: 260px; }
      #chatSection { flex: 1; }
    }

    aside#roomList {
      background: #fff;
      border-right: 1px solid #ccc;
      padding: 10px;
      overflow-y: auto;
    }
    aside#roomList h2 { margin: 0 0 8px; font-size: 1rem; }
    .room-actions {
      display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px;
    }
    .room-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px; border-radius: 4px; cursor: pointer;
    }
    .room-item:hover { background: #eee; }
    .room-delete-btn {
      background: #e74c3c; color: #fff; border: none; border-radius: 4px; cursor: pointer;
      padding: 2px 6px; font-size: 0.75rem;
    }

    #chatSection {
      display: flex; flex-direction: column; flex: 1; min-width: 0;
    }
    header {
      background: #4CAF50; color: white; padding: 10px;
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;
    }
    header h1 { margin: 0; font-size: 1.1rem; }
    #currentRoomName { font-weight: 600; }

    main#chatArea {
      flex: 1; padding: 10px; overflow-y: auto; background: #e9e9e9;
    }
    .message {
      margin-bottom: 10px; padding: 8px; background: white; border-radius: 6px; word-break: break-word;
    }
    .message.mention { background: #ffffcc; }
    .msg-meta { font-size: 0.75rem; color: #888; margin-bottom: 2px; }
    .chat-image { max-width: 100%; max-height: 200px; border-radius: 8px; margin-top: 5px; }

    .reactions {
      margin-top: 5px; display: flex; align-items: center; flex-wrap: wrap; gap: 4px;
    }
    .reaction-button {
      font-size: 1.1rem; cursor: pointer; user-select: none; opacity: .6;
    }
    .reaction-button.active { opacity: 1; font-weight: bold; }
    .reaction-count { font-size: .85rem; margin-right: 6px; }

    footer {
      background: #fff; padding: 10px; display: flex; gap: 5px; flex-wrap: wrap;
    }
    footer input[type=text], footer input[type=file] {
      flex: 1 1 100%; padding: 8px; font-size: 1rem;
    }
    footer button {
      flex: 1 1 48%; padding: 10px; font-size: 1rem; cursor: pointer;
    }
    @media (min-width: 600px) {
      footer input[type=text], footer input[type=file], footer button { flex: 1; }
    }
  </style>
</head>
<body>
  <div id="app">
    <aside id="roomList">
      <h2>„É´„Éº„É†</h2>
      <div class="room-actions">
        <button id="createRoomBtn">Ôºã„É´„Éº„É†‰ΩúÊàê</button>
        <button id="deleteRoomBtn">üóë „É´„Éº„É†ÂâäÈô§</button>
      </div>
      <div id="roomItems"></div>
    </aside>

    <div id="chatSection">
      <header>
        <h1>Ê•≠Âãô„ÉÅ„É£„ÉÉ„Éà</h1>
        <span id="currentRoomName">ÔºàÊú™ÂÖ•ÂÆ§Ôºâ</span>
      </header>
      <main id="chatArea"></main>
      <footer>
        <input type="text" id="messageInput" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„Åæ„Åü„ÅØ @ÂêçÂâç" />
        <input type="file" id="imageInput" accept="image/*" />
        <button id="sendBtn">ÈÄÅ‰ø°</button>
      </footer>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp,
      doc, updateDoc, setDoc, getDocs, getDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // ------------------ Firebase ------------------
    const firebaseConfig = {
      apiKey: "AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
      authDomain: "fastpass-system.firebaseapp.com",
      projectId: "fastpass-system",
      storageBucket: "fastpass-system.appspot.com",
      messagingSenderId: "858745521872",
      appId: "1:858745521872:web:29289b673855097e1200d5"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ------------------ State ------------------
    let currentRoom = null;
    let userName = localStorage.getItem('chat_display_name') || '';
    let messagesUnsub = null;

    // ------------------ DOM refs ------------------
    const roomItemsEl = document.getElementById('roomItems');
    const createRoomBtn = document.getElementById('createRoomBtn');
    const deleteRoomBtn = document.getElementById('deleteRoomBtn');
    const currentRoomNameEl = document.getElementById('currentRoomName');
    const chatArea = document.getElementById('chatArea');
    const sendBtn = document.getElementById('sendBtn');
    const messageInput = document.getElementById('messageInput');
    const imageInput = document.getElementById('imageInput');

    // ------------------ Init ------------------
    window.addEventListener('DOMContentLoaded', init);
    async function init() {
      if (!userName) {
        userName = prompt('„ÅÇ„Å™„Åü„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        if (userName) localStorage.setItem('chat_display_name', userName);
      }
      createRoomBtn.addEventListener('click', createRoom);
      deleteRoomBtn.addEventListener('click', deleteRoom);
      sendBtn.addEventListener('click', sendMessage);
      await listRooms();
    }

    // ------------------ Rooms ------------------
    async function listRooms() {
      roomItemsEl.innerHTML = '';
      const roomsRef = collection(db, 'rooms');
      const q = query(roomsRef, orderBy('lastMessageAt', 'desc'));
      const snap = await getDocs(q);
      snap.forEach(docSnap => {
        const div = document.createElement('div');
        div.className = 'room-item';
        const span = document.createElement('span');
        span.textContent = docSnap.id;
        span.style.flex = '1';
        span.onclick = async () => {
          const data = (await getDoc(docSnap.ref)).data();
          if (data?.password) {
            const input = prompt('„Åì„ÅÆ„É´„Éº„É†„ÅØ„Éë„Çπ„ÉØ„Éº„Éâ„Åß‰øùË≠∑„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            if (input !== data.password) {
              alert('„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„Åô');
              return;
            }
          }
          joinRoom(docSnap.id);
        };
        // ÂÄãÂà•ÂâäÈô§„Éú„Çø„É≥Ôºà‰ªªÊÑè„ÉªÂøÖË¶Å„Å™„Çâ‰Ωø„ÅÜÔºâ
        const del = document.createElement('button');
        del.textContent = 'ÂâäÈô§';
        del.className = 'room-delete-btn';
        del.onclick = async (e) => {
          e.stopPropagation();
          if (confirm(`„É´„Éº„É†„Äå${docSnap.id}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
            await deleteRoomByName(docSnap.id);
            if (currentRoom === docSnap.id) {
              currentRoom = null;
              currentRoomNameEl.textContent = 'ÔºàÊú™ÂÖ•ÂÆ§Ôºâ';
              chatArea.innerHTML = '';
            }
            await listRooms();
          }
        };
        div.appendChild(span);
        div.appendChild(del);
        roomItemsEl.appendChild(div);
      });
    }

    async function createRoom() {
      const name = prompt('„É´„Éº„É†Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
      if (!name) return;
      const password = prompt('„Åì„ÅÆ„É´„Éº„É†„Å´„Éë„Çπ„ÉØ„Éº„Éâ„ÇíË®≠ÂÆö„Åó„Åæ„Åô„ÅãÔºüÔºàÁ©∫Ê¨Ñ„Åß„Çπ„Ç≠„ÉÉ„ÉóÔºâ');
      await setDoc(doc(db, 'rooms', name), {
        lastMessageAt: serverTimestamp(),
        password: password || ''
      });
      await listRooms();
      joinRoom(name);
    }

    async function deleteRoom() {
      if (!currentRoom) return alert('„É´„Éº„É†„Å´ÂÖ•ÂÆ§„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
      if (!confirm(`„É´„Éº„É†„Äå${currentRoom}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;
      await deleteRoomByName(currentRoom);
      currentRoom = null;
      currentRoomNameEl.textContent = 'ÔºàÊú™ÂÖ•ÂÆ§Ôºâ';
      chatArea.innerHTML = '';
      await listRooms();
    }

    async function deleteRoomByName(roomName) {
      // „É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖà„Å´ÂâäÈô§
      const msgsSnap = await getDocs(collection(db, 'rooms', roomName, 'messages'));
      for (const m of msgsSnap.docs) {
        await deleteDoc(m.ref);
      }
      await deleteDoc(doc(db, 'rooms', roomName));
    }

    // ------------------ Chat ------------------
    async function joinRoom(roomName) {
      currentRoom = roomName;
      currentRoomNameEl.textContent = `„É´„Éº„É†: ${roomName}`;
      if (messagesUnsub) messagesUnsub();
      chatArea.innerHTML = '';

      const messagesRef = collection(db, 'rooms', roomName, 'messages');
      const q = query(messagesRef, orderBy('createdAt'));

      messagesUnsub = onSnapshot(q, (snapshot) => {
        chatArea.innerHTML = '';
        snapshot.forEach((d) => {
          const data = d.data();
          const div = document.createElement('div');
          div.className = 'message' + (data.text?.includes('@' + userName) ? ' mention' : '');

          // meta & body
          const meta = document.createElement('div');
          meta.className = 'msg-meta';
          const createdAt = data.createdAt?.toDate?.() ? data.createdAt.toDate() : null;
          meta.textContent = `${escapeHTML(data.name || '-')}${createdAt ? ' „Éª ' + formatDate(createdAt) : ''}`;
          div.appendChild(meta);

          const body = document.createElement('div');
          body.innerHTML = escapeHTML(data.text || '');
          div.appendChild(body);

          if (data.imageURL) {
            const img = document.createElement('img');
            img.src = data.imageURL;
            img.className = 'chat-image';
            div.appendChild(img);
          }

          // Êó¢Ë™≠
          if (!data.readUsers?.includes(userName)) {
          updateDoc(doc(db, 'rooms', roomName, 'messages', d.id), {
              readUsers: [...(data.readUsers || []), userName]
            });
          }

          // --- Reactions ---
          const reactionsObj = data.reactions || {}; // {"üëç": ["A", "B"], ...}
          const reactionDiv = document.createElement('div');
          reactionDiv.className = 'reactions';
          const emojis = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üéâ'];
          emojis.forEach((emoji) => {
            const btn = document.createElement('span');
            btn.textContent = emoji;
            const list = reactionsObj[emoji] || [];
            const reacted = list.includes(userName);
            btn.className = 'reaction-button' + (reacted ? ' active' : '');
            btn.onclick = async () => {
              const newReactions = { ...reactionsObj };
              const currentList = newReactions[emoji] ? [...newReactions[emoji]] : [];
              const idx = currentList.indexOf(userName);
              if (idx >= 0) {
                currentList.splice(idx, 1); // remove
                if (currentList.length === 0) {
                  delete newReactions[emoji];
                } else {
                  newReactions[emoji] = currentList;
                }
              } else {
                currentList.push(userName);
                newReactions[emoji] = currentList;
              }
              await updateDoc(doc(db, 'rooms', roomName, 'messages', d.id), {
                reactions: newReactions
              });
            };
            reactionDiv.appendChild(btn);

            const count = document.createElement('span');
            count.className = 'reaction-count';
            const c = list.length;
            count.textContent = c > 0 ? ` ${c}` : '';
            reactionDiv.appendChild(count);
          });
          div.appendChild(reactionDiv);

          chatArea.appendChild(div);
        });
        chatArea.scrollTop = chatArea.scrollHeight;
      });
    }

    async function sendMessage() {
      if (!currentRoom) {
        alert('„É´„Éº„É†„Å´ÂÖ•ÂÆ§„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }
      const text = messageInput.value.trim();
      const file = imageInput.files[0];
      if (!text && !file) return;

      let imageURL = null;
      if (file) {
        const fileRef = ref(storage, `uploads/${currentRoom}/${Date.now()}_${file.name}`);
        await uploadBytes(fileRef, file);
        imageURL = await getDownloadURL(fileRef);
      }

      await addDoc(collection(db, 'rooms', currentRoom, 'messages'), {
        name: userName,
        text,
        imageURL,
        createdAt: serverTimestamp(),
        readUsers: [userName],
        reactions: {}
      });

      await updateDoc(doc(db, 'rooms', currentRoom), {
        lastMessageAt: serverTimestamp()
      });

      messageInput.value = '';
      imageInput.value = '';
    }

    // ------------------ Utils ------------------
    function escapeHTML(str = '') {
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
    function pad(n){ return n.toString().padStart(2, '0'); }
    function formatDate(d){ return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
  </script>
</body>
</html>
