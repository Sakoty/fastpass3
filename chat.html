<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ê•≠Âãô„ÉÅ„É£„ÉÉ„Éà</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: sans-serif; background-color: #f0f0f0; }
    #app { display: flex; height: 100vh; }
    aside#roomList {
      width: 240px;
      background: #fff;
      border-right: 1px solid #ccc;
      padding: 10px;
      overflow-y: auto;
    }
    aside#roomList h2 { margin-top: 0; }
    .room-item {
      padding: 8px;
      margin-bottom: 4px;
      cursor: pointer;
      border-radius: 4px;
    }
    .room-item:hover { background: #eee; }
    #chatSection {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    header {
      background: #4CAF50;
      color: white;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    header h1 { margin: 0; font-size: 1.1rem; }
    #currentRoomName { font-weight: 600; }
    main#chatArea {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #e9e9e9;
    }
    .message {
      margin-bottom: 10px;
      padding: 8px;
      background: white;
      border-radius: 6px;
      position: relative;
      word-break: break-word;
    }
    .message.mention {
      background: #ffffcc;
    }
    .message img.chat-image {
      max-width: 100%;
      max-height: 200px;
      margin-top: 5px;
      border-radius: 8px;
    }
    .reactions {
      margin-top: 5px;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 4px;
    }
    .reaction-button {
      font-size: 1.1rem;
      margin-right: 2px;
      cursor: pointer;
      user-select: none;
    }
    footer {
      background: #fff;
      padding: 10px;
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
    footer input[type=text], footer input[type=file] {
      flex: 1;
      padding: 8px;
      font-size: 1rem;
      min-width: 120px;
    }
    footer button {
      padding: 10px;
      font-size: 1rem;
    }
    @media (max-width: 768px) {
      #app { flex-direction: column; }
      aside#roomList { width: 100%; height: 160px; border-right: none; border-bottom: 1px solid #ccc; }
      #chatSection { height: calc(100vh - 160px); }
    }
  </style>
</head>
<body>
  <div id="app">
    <aside id="roomList">
      <h2>„É´„Éº„É†</h2>
      <div style="margin-bottom:8px; display:flex; gap:6px;">
        <button id="createRoomBtn">Ôºã„É´„Éº„É†‰ΩúÊàê</button>
      </div>
      <div id="roomItems"></div>
    </aside>

    <div id="chatSection">
      <header>
        <h1>Ê•≠Âãô„ÉÅ„É£„ÉÉ„Éà</h1>
        <span id="currentRoomName">ÔºàÊú™ÂÖ•ÂÆ§Ôºâ</span>
      </header>
      <main id="chatArea"></main>
      <footer>
        <input type="text" id="messageInput" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„Åæ„Åü„ÅØ @ÂêçÂâç" />
        <input type="file" id="imageInput" accept="image/*" />
        <button id="sendBtn">ÈÄÅ‰ø°</button>
      </footer>
    </div>
  </div>

  <script type="module">
    // ----------------------
    // Imports
    // ----------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp,
      doc, updateDoc, setDoc, getDocs, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // ----------------------
    // Firebase Config
    // ----------------------
    const firebaseConfig = {
      apiKey: "AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
      authDomain: "fastpass-system.firebaseapp.com",
      projectId: "fastpass-system",
      storageBucket: "fastpass-system.appspot.com",
      messagingSenderId: "858745521872",
      appId: "1:858745521872:web:29289b673855097e1200d5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ----------------------
    // State
    // ----------------------
    let currentRoom = null;
    let userName = localStorage.getItem("chatUserName") || "";
    let messagesUnsub = null;

    // ----------------------
    // DOM refs
    // ----------------------
    const roomItemsEl = document.getElementById('roomItems');
    const createRoomBtn = document.getElementById('createRoomBtn');
    const currentRoomNameEl = document.getElementById('currentRoomName');
    const chatArea = document.getElementById('chatArea');
    const sendBtn = document.getElementById('sendBtn');
    const messageInput = document.getElementById('messageInput');
    const imageInput = document.getElementById('imageInput');

    // ----------------------
    // Init
    // ----------------------
    window.addEventListener('DOMContentLoaded', init);

    async function init() {
      // ÂêçÂâç‰øùÊåÅ
      if (!userName) {
        userName = prompt('„ÅÇ„Å™„Åü„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        if (userName) localStorage.setItem('chatUserName', userName);
      }

      // „Ç§„Éô„É≥„ÉàÁôªÈå≤Ôºà„Åì„Åì„Åå createRoom „ÅåÊú™ÂÆöÁæ©„Å´„Å™„Çã„ÅÆ„ÇíÈò≤„Åê„Éù„Ç§„É≥„ÉàÔºâ
      createRoomBtn.addEventListener('click', createRoom);
      sendBtn.addEventListener('click', sendMessage);

      // „É´„Éº„É†‰∏ÄË¶ßË≥ºË™≠
      await listRooms();

      // --- Á∞°Êòì„ÉÜ„Çπ„ÉàÔºàÊúÄ‰ΩéÈôê„ÅÆÂ≠òÂú®Á¢∫Ë™çÔºâ ---
      try {
        console.assert(typeof createRoom === 'function', 'createRoom „ÅåÂÆöÁæ©„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
        console.assert(typeof sendMessage === 'function', 'sendMessage „ÅåÂÆöÁæ©„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
        console.assert(createRoomBtn instanceof HTMLElement, 'createRoomBtn „ÅåÂèñÂæó„Åß„Åç„Å¶„ÅÑ„Åæ„Åõ„Çì');
      } catch (e) {
        console.warn('Á∞°Êòì„ÉÜ„Çπ„ÉàÂ§±Êïó: ', e);
      }
    }

    // ----------------------
    // Rooms
    // ----------------------
    async function listRooms() {
      roomItemsEl.innerHTML = '';
      const roomsRef = collection(db, 'rooms');
      const q = query(roomsRef, orderBy('lastMessageAt', 'desc'));
      const snap = await getDocs(q);
      snap.forEach(docSnap => {
        const div = document.createElement('div');
        div.className = 'room-item';
        div.textContent = docSnap.id;
        div.addEventListener('click', async () => {
          const roomData = (await getDoc(docSnap.ref)).data();
          if (roomData && roomData.password) {
            const input = prompt('„Åì„ÅÆ„É´„Éº„É†„ÅØ„Éë„Çπ„ÉØ„Éº„Éâ„Åß‰øùË≠∑„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            if (input !== roomData.password) {
              alert('„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„Åô');
              return;
            }
          }
          joinRoom(docSnap.id);
        });
        roomItemsEl.appendChild(div);
      });
    }

    async function createRoom() {
      const name = prompt('„É´„Éº„É†Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
      if (!name) return;
      const password = prompt('„Åì„ÅÆ„É´„Éº„É†„Å´„Éë„Çπ„ÉØ„Éº„Éâ„ÇíË®≠ÂÆö„Åó„Åæ„Åô„ÅãÔºüÔºàÁ©∫Ê¨Ñ„Åß„Çπ„Ç≠„ÉÉ„ÉóÔºâ');
      await setDoc(doc(db, 'rooms', name), {
        lastMessageAt: serverTimestamp(),
        password: password || ''
      });
      joinRoom(name);
    }

    // ----------------------
    // Chat / Messages
    // ----------------------
    async function joinRoom(roomName) {
      currentRoom = roomName;
      currentRoomNameEl.textContent = `„É´„Éº„É†: ${roomName}`;

      // Êó¢Â≠òË≥ºË™≠„ÇíËß£Èô§
      if (messagesUnsub) messagesUnsub();
      chatArea.innerHTML = '';

      const messagesRef = collection(db, 'rooms', roomName, 'messages');
      const q = query(messagesRef, orderBy('createdAt'));

      messagesUnsub = onSnapshot(q, snapshot => {
        chatArea.innerHTML = '';
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const div = document.createElement('div');
          div.className = 'message' + (data.text?.includes('@' + userName) ? ' mention' : '');
          div.innerHTML = `<b>${escapeHTML(data.name || '')}</b>: ${escapeHTML(data.text || '')}`;

          if (data.imageURL) {
            const img = document.createElement('img');
            img.src = data.imageURL;
            img.className = 'chat-image';
            div.appendChild(document.createElement('br'));
            div.appendChild(img);
          }

          // Êó¢Ë™≠
          if (!data.readUsers?.includes(userName)) {
            updateDoc(docSnap.ref, { readUsers: [...(data.readUsers || []), userName] });
          }

          // „É™„Ç¢„ÇØ„Ç∑„Éß„É≥
          const reactionDiv = document.createElement('div');
          reactionDiv.className = 'reactions';
          ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üéâ'].forEach(emoji => {
          const btn = document.createElement('span');
            btn.textContent = emoji;
            btn.className = 'reaction-button';
            btn.onclick = async () => {
              const reactions = data.reactions || {};
              reactions[emoji] = (reactions[emoji] || 0) + 1;
              await updateDoc(docSnap.ref, { reactions });
            };
            reactionDiv.appendChild(btn);
            if (data.reactions?.[emoji]) {
              const count = document.createElement('span');
              count.textContent = ` ${data.reactions[emoji]}`;
              reactionDiv.appendChild(count);
            }
          });
          div.appendChild(reactionDiv);

          chatArea.appendChild(div);
        });
        chatArea.scrollTop = chatArea.scrollHeight;
      });
    }

    async function sendMessage() {
      if (!currentRoom) {
        alert('„É´„Éº„É†„Å´ÂÖ•ÂÆ§„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }
      const text = messageInput.value.trim();
      const file = imageInput.files[0];
      if (!text && !file) return;

      let imageURL = null;
      if (file) {
        const fileRef = ref(storage, `uploads/${currentRoom}/${Date.now()}_${file.name}`);
        await uploadBytes(fileRef, file);
        imageURL = await getDownloadURL(fileRef);
      }

      await addDoc(collection(db, 'rooms', currentRoom, 'messages'), {
        name: userName,
        text,
        imageURL,
        createdAt: serverTimestamp(),
        readUsers: [userName],
        reactions: {}
      });

      await updateDoc(doc(db, 'rooms', currentRoom), {
        lastMessageAt: serverTimestamp()
      });

      messageInput.value = '';
      imageInput.value = '';
    }

    // ----------------------
    // utils
    // ----------------------
    function escapeHTML(str = '') {
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
  </script>
</body>
</html>
