<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ファストパス設定＋ログ（管理者/NFC対応版）</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#007bff">
<style>
body { font-family:"Segoe UI",sans-serif; background:#f5f7fa; margin:0; padding:0; }
.container { max-width:600px; margin:auto; padding:10px; }
h1 { text-align:center; margin-bottom:5px; }
#clock { text-align:center; font-weight:bold; color:#555; margin-bottom:10px; }
.status-badge { display:inline-block; padding:5px 12px; border-radius:15px; font-weight:bold; font-size:0.9rem; margin-top:5px; }
.active { background-color:#28a745; color:white; }
.inactive { background-color:#dc3545; color:white; }
.card { background:white; border-radius:10px; padding:15px; margin-top:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
label { font-weight:bold; display:block; margin-top:10px; font-size:0.9rem; }
input { width:100%; padding:8px; margin-top:4px; border-radius:5px; border:1px solid #ccc; font-size:1rem; box-sizing:border-box; }
button { padding:14px; margin:5px 0; border:none; border-radius:8px; font-weight:bold; cursor:pointer; width:100%; font-size:1rem; }
button.primary { background:#007bff; color:white; }
button.success { background:#28a745; color:white; }
button.danger { background:#dc3545; color:white; }
.time-slot-group { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
@media(max-width:500px){ .time-slot-group { grid-template-columns:1fr; } }
.tabs { display:flex; justify-content:space-around; margin-bottom:10px; flex-wrap:wrap; }
.tab { flex:1; padding:14px; text-align:center; cursor:pointer; background:#ddd; border-radius:8px 8px 0 0; font-weight:bold; margin-bottom:2px; }
.tab.active { background:#007bff; color:white; }
.tab-content { display:none; }
.tab-content.active { display:block; }
table { width:100%; border-collapse: collapse; margin-top:10px; }
th, td { border:1px solid #ccc; padding:6px 8px; text-align:center; color:black; } 
#loginDiv { max-width:400px; margin:auto; padding:20px; background:#fff; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
#loginDiv input, #loginDiv button { width:100%; padding:10px; margin:8px 0; box-sizing:border-box; }
#errorMsg { color:red; margin-top:10px; text-align:center; }
#nfcStatus { text-align:center; font-weight:bold; margin:10px 0; }
</style>
</head>
<body>

<!-- 管理者ログイン -->
<div id="loginDiv">
  <h1>管理者ログイン</h1>
  <div>
    <label><input type="radio" name="authMethod" value="password" checked> パスワード認証</label>
    <label><input type="radio" name="authMethod" value="nfc"> NFCカード認証</label>
  </div>

  <!-- パスワードフォーム -->
  <form id="passwordForm">
    <input type="text" id="adminId" placeholder="管理者ID" required />
    <input type="password" id="adminPass" placeholder="パスワード" required />
    <button type="submit">ログイン</button>
    <div id="errorMsg"></div>
  </form>

  <!-- NFCフォーム -->
  <div id="nfcDiv" style="display:none;">
    <p>カードをかざしてください</p>
    <div id="nfcStatus">NFC待機中...</div>
  </div>
</div>

<!-- メインコンテンツ -->
<div class="container" id="mainContent" style="display:none;">
  <h1>ファストパス設定</h1>
  <div id="clock"></div>
  <div class="tabs">
    <div class="tab active" data-tab="controlTab">発券制御</div>
    <div class="tab" data-tab="timeTab">時間帯設定</div>
    <div class="tab" data-tab="specialTab">特別パス発券</div>
    <div class="tab" data-tab="logTab">アクセスログ</div>
  </div>

  <!-- 発券制御 -->
  <div class="tab-content active" id="controlTab">
    <div style="text-align:center;">
      <span id="statusBadge" class="status-badge inactive">停止中</span>
    </div>
    <div class="card">
      <button id="startBtn" class="success">発券開始</button>
      <button id="stopBtn" class="danger">発券停止</button>
      <button id="logoutBtn" class="danger">ログアウト</button>
    </div>
  </div>

  <!-- 時間帯設定 -->
  <div class="tab-content" id="timeTab">
    <div class="card">
      <form id="setTimeSlots">
        <div>
          <label>1枠目</label>
          <div class="time-slot-group"><input type="time" id="start1" /><input type="time" id="end1" /></div>
          <div class="time-slot-group"><input type="number" id="interval1" value="10" min="1" placeholder="間隔(分)" /><input type="number" id="limit1" value="1" min="1" placeholder="上限人数" /></div>
        </div>
        <div>
          <label>2枠目</label>
          <div class="time-slot-group"><input type="time" id="start2" /><input type="time" id="end2" /></div>
          <div class="time-slot-group"><input type="number" id="interval2" value="10" min="1" placeholder="間隔(分)" /><input type="number" id="limit2" value="1" min="1" placeholder="上限人数" /></div>
        </div>
        <div>
          <label>3枠目</label>
          <div class="time-slot-group"><input type="time" id="start3" /><input type="time" id="end3" /></div>
          <div class="time-slot-group"><input type="number" id="interval3" value="10" min="1" placeholder="間隔(分)" /><input type="number" id="limit3" value="1" min="1" placeholder="上限人数" /></div>
        </div>
        <button type="submit" class="primary">時間設定を保存</button>
      </form>
    </div>
  </div>

  <!-- 特別パス発券 -->
  <div class="tab-content" id="specialTab">
    <div class="card">
      <form id="specialForm">
        <input type="text" id="specialName" placeholder="名前" required />
        <input type="number" id="specialPeople" placeholder="人数" min="1" required />
        <div class="time-slot-group"><input type="time" id="specialStartTime" required /><input type="time" id="specialEndTime" required /></div>
        <button type="submit" class="success">特別パス発行</button>
      </form>
    </div>
  </div>

  <!-- アクセスログ -->
  <div class="tab-content" id="logTab">
    <div id="logAuthDiv">
      <h2>アクセスログ閲覧認証</h2>
      <form id="logAuthForm">
        <input type="password" id="logPass" placeholder="パスワードを入力" required />
        <button type="submit">認証</button>
        <div id="logAuthMsg"></div>
      </form>
    </div>
    <div class="card" id="logContent" style="display:none;">
      <button id="clearLogsBtn" class="danger">全削除</button>
      <table>
        <thead><tr><th>管理者ID/ユーザー</th><th>操作</th><th>日時</th></tr></thead>
        <tbody id="logTable"></tbody>
      </table>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, addDoc, collection, serverTimestamp, onSnapshot, query, orderBy, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
  authDomain: "fastpass-system.firebaseapp.com",
  projectId: "fastpass-system",
  storageBucket: "fastpass-system.appspot.com",
  messagingSenderId: "858745521872",
  appId: "1:858745521872:web:29289b673855097e1200d5"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// 管理者設定
const allowedAdmins = [
  { id:"Sakoty", password:"3214" },
  { id:"seseguchi914", password:"0914" }
];

const loginDiv = document.getElementById("loginDiv");
const mainContent = document.getElementById("mainContent");
const errorMsg = document.getElementById("errorMsg");
const passwordForm = document.getElementById("passwordForm");
const nfcDiv = document.getElementById("nfcDiv");
const nfcStatus = document.getElementById("nfcStatus");

// ログイン方式切替
document.querySelectorAll("input[name='authMethod']").forEach(radio=>{
  radio.addEventListener("change", ()=>{
    if(radio.value==="nfc" && radio.checked){
      passwordForm.style.display="none";
      nfcDiv.style.display="block";
      startNFC();
    } else {
      passwordForm.style.display="block";
      nfcDiv.style.display="none";
    }
  });
});

// パスワード認証
passwordForm.onsubmit = e=>{
  e.preventDefault();
  const id = document.getElementById("adminId").value.trim();
  const pass = document.getElementById("adminPass").value.trim();
  if(allowedAdmins.some(a=>a.id===id && a.password===pass)){
    loginDiv.style.display="none";
    mainContent.style.display="block";
    logAccess(id,"ログイン成功");
    initTabs(); updateStatusDisplay(); loadTimeSlots();
  } else { errorMsg.textContent="IDまたはパスワードが違います"; logAccess(id,"ログイン失敗"); }
};

// NFC認証
let nfcReader;
async function startNFC(){
  if(!("NDEFReader" in window)){
    nfcStatus.textContent="このブラウザはNFC非対応";
    return;
  }
  try{
    nfcReader = new NDEFReader();
    await nfcReader.scan();
    nfcStatus.textContent="カードをかざしてください";

    const adminUIDsCol = collection(db,"adminUIDs");
    onSnapshot(adminUIDsCol,snap=>{
      window.adminUIDs = snap.docs.map(d=>d.data().uid);
    });

    nfcReader.onreading = e=>{
      const uid = e.serialNumber || "unknown";
      if(window.adminUIDs?.includes(uid)){
        nfcStatus.textContent="認証成功: "+uid;
        loginDiv.style.display="none";
        mainContent.style.display="block";
        logAccess(uid,"NFCログイン成功");
        initTabs(); updateStatusDisplay(); loadTimeSlots();
      } else {
        nfcStatus.textContent="未認証UID: "+uid;
      }
    };
    nfcReader.onreadingerror = ()=>{ nfcStatus.textContent="NFC読み取りエラー"; }
  }catch(err){ nfcStatus.textContent="NFCスキャン失敗: "+err; }
}

// 時計
setInterval(()=>{
  const now=new Date();
  document.getElementById("clock").textContent = now.toLocaleDateString()+" "+now.toLocaleTimeString();
},1000);

// タブ切替
function initTabs(){
  const tabs = document.querySelectorAll(".tab");
  const contents = document.querySelectorAll(".tab-content");
  tabs.forEach(tab=>{
    tab.addEventListener("click", ()=>{
      tabs.forEach(t=>t.classList.remove("active"));
      contents.forEach(c=>c.classList.remove("active"));
      tab.classList.add("active");
      document.getElementById(tab.dataset.tab).classList.add("active");
    });
  });
}

// 発券制御
let issuing=false;
document.getElementById("startBtn").onclick = ()=>{
  issuing=true; updateStatusDisplay(); logAccess("admin","発券開始");
};
document.getElementById("stopBtn").onclick = ()=>{
  issuing=false; updateStatusDisplay(); logAccess("admin","発券停止");
};
document.getElementById("logoutBtn").onclick = ()=>{ location.reload(); };

function updateStatusDisplay(){
  const badge=document.getElementById("statusBadge");
  if(issuing){ badge.textContent="発券中"; badge.className="status-badge active"; }
  else{ badge.textContent="停止中"; badge.className="status-badge inactive"; }
}

// 時間帯設定
const timeForm = document.getElementById("setTimeSlots");
timeForm.onsubmit = async e=>{
  e.preventDefault();
  for(let i=1;i<=3;i++){
    const start=document.getElementById(`start${i}`).value;
    const end=document.getElementById(`end${i}`).value;
    const interval=document.getElementById(`interval${i}`).value;
    const limit=document.getElementById(`limit${i}`).value;
    await setDoc(doc(db,"settings/timeSlots",`slot${i}`),{start,end,interval,limit});
  }
  alert("時間帯設定保存完了");
  logAccess("admin","時間帯設定変更");
};

async function loadTimeSlots(){
  for(let i=1;i<=3;i++){
    const docRef=doc(db,"settings/timeSlots",`slot${i}`);
    const docSnap=await getDoc(docRef);
    if(docSnap.exists()){
      const data=docSnap.data();
      document.getElementById(`start${i}`).value=data.start||"";
      document.getElementById(`end${i}`).value=data.end||"";
      document.getElementById(`interval${i}`).value=data.interval||10;
      document.getElementById(`limit${i}`).value=data.limit||1;
    }
  }
}

// 特別パス発券
document.getElementById("specialForm").onsubmit=async e=>{
  e.preventDefault();
  const name=document.getElementById("specialName").value.trim();
  const people=document.getElementById("specialPeople").value;
  const start=document.getElementById("specialStartTime").value;
  const end=document.getElementById("specialEndTime").value;
  await addDoc(collection(db,"passes"),{name,people,start,end,special:true,timestamp:serverTimestamp()});
  alert("特別パス発券完了");
  logAccess("admin",`特別パス発券:${name} ${people}人`);
  e.target.reset();
};

// アクセスログ
async function logAccess(user,action){
  await addDoc(collection(db,"logs"),{user,action,timestamp:serverTimestamp()});
}

const logForm=document.getElementById("logAuthForm");
const logAuthMsg=document.getElementById("logAuthMsg");
const logContent=document.getElementById("logContent");
const logTable=document.getElementById("logTable");
logForm.onsubmit=async e=>{
  e.preventDefault();
  const pass=document.getElementById("logPass").value;
  if(pass==="3214"){ // 簡易ログ認証
    logAuthMsg.textContent="";
    logContent.style.display="block";
    loadLogs();
  } else { logAuthMsg.textContent="パスワード違います"; }
};
async function loadLogs(){
  logTable.innerHTML="";
  const q=query(collection(db,"logs"),orderBy("timestamp","desc"));
  const snap=await getDocs(q);
  snap.forEach(doc=>{
    const d=doc.data();
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${d.user}</td><td>${d.action}</td><td>${d.timestamp?.toDate().toLocaleString()||""}</td>`;
    logTable.appendChild(tr);
  });
}

document.getElementById("clearLogsBtn").onclick=async ()=>{
  const snap=await getDocs(collection(db,"logs"));
  snap.forEach(async docu=>{ await deleteDoc(doc(db,"logs",docu.id)); });
  logTable.innerHTML="";
};
</script>
</body>
</html>
