<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ファストパス設定</title>
<style>
  body { font-family: "Segoe UI", sans-serif; max-width: 600px; margin: auto; padding: 15px; background: #f5f7fa; }
  h1 { text-align: center; margin-bottom: 5px; }
  #clock { text-align: center; font-weight: bold; color: #555; margin-bottom: 10px; }
  .status-badge { display: inline-block; padding: 5px 12px; border-radius: 15px; font-weight: bold; font-size: 0.9rem; margin-top: 5px; }
  .active { background-color: #28a745; color: white; }
  .inactive { background-color: #dc3545; color: white; }
  .card { background: white; border-radius: 10px; padding: 15px; margin-top: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  label { font-weight: bold; display: block; margin-top: 10px; font-size: 0.9rem; }
  input { width: 100%; padding: 8px; margin-top: 4px; border-radius: 5px; border: 1px solid #ccc; font-size: 1rem; box-sizing: border-box; }
  button { width: 100%; padding: 12px; margin-top: 12px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; }
  button.primary { background-color: #007bff; color: white; }
  button.danger { background-color: #dc3545; color: white; }
  button.success { background-color: #28a745; color: white; }
  .time-slot-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  @media (max-width: 500px) { .time-slot-group { grid-template-columns: 1fr; } }

  /* ログイン用 */
  #loginDiv { max-width: 400px; margin:auto; padding:20px; background:#fff; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
  #loginDiv input { width:100%; padding:10px; margin:8px 0; box-sizing:border-box; }
  #loginDiv button { width:100%; padding:10px; background:#007bff; color:white; border:none; border-radius:5px; font-size:16px; cursor:pointer; }
  #loginDiv button:hover { background:#0056b3; }
  #errorMsg { color:red; margin-top:10px; text-align:center; }
  #mainContent { display:none; }

  /* ログ表示 */
  #logCard { display:none; margin-top:15px; }
  #logList { max-height:200px; overflow:auto; border:1px solid #ccc; padding:8px; border-radius:5px; background:white; }
  #logList div { border-bottom:1px solid #eee; padding:4px 0; font-size:0.9rem; }
</style>
</head>
<body>

<!-- ログイン画面 -->
<div id="loginDiv">
  <h1>管理者ログイン</h1>
  <form id="loginForm">
    <input type="text" id="adminId" placeholder="管理者ID" required />
    <input type="password" id="adminPass" placeholder="パスワード" required />
    <button type="submit">ログイン</button>
    <div id="errorMsg"></div>
  </form>
</div>

<!-- 設定画面 -->
<div id="mainContent">
  <h1>ファストパス設定</h1>
  <div id="clock"></div>
  <div style="text-align:center;">
    <span id="statusBadge" class="status-badge inactive">停止中</span>
  </div>

  <div class="card">
    <h2>発券制御</h2>
    <button id="startBtn" class="success">発券開始</button>
    <button id="stopBtn" class="danger">発券停止</button>
    <button id="logoutBtn" class="danger" style="margin-top:10px;">ログアウト</button>
  </div>

  <div class="card">
    <h2>案内時間帯設定</h2>
    <form id="setTimeSlots">
      <div>
        <label>1枠目</label>
        <div class="time-slot-group">
          <input type="time" id="start1" placeholder="開始" />
          <input type="time" id="end1" placeholder="終了" />
        </div>
        <div class="time-slot-group">
          <input type="number" id="interval1" value="10" placeholder="間隔(分)" min="1" />
          <input type="number" id="limit1" value="1" placeholder="上限人数" min="1" />
        </div>
      </div>
      <div>
        <label>2枠目</label>
        <div class="time-slot-group">
          <input type="time" id="start2" placeholder="開始" />
          <input type="time" id="end2" placeholder="終了" />
        </div>
        <div class="time-slot-group">
          <input type="number" id="interval2" value="10" placeholder="間隔(分)" min="1" />
          <input type="number" id="limit2" value="1" placeholder="上限人数" min="1" />
        </div>
      </div>
      <div>
        <label>3枠目</label>
        <div class="time-slot-group">
          <input type="time" id="start3" placeholder="開始" />
          <input type="time" id="end3" placeholder="終了" />
        </div>
        <div class="time-slot-group">
          <input type="number" id="interval3" value="10" placeholder="間隔(分)" min="1" />
          <input type="number" id="limit3" value="1" placeholder="上限人数" min="1" />
        </div>
      </div>
      <button type="submit" class="primary">時間設定を保存</button>
    </form>
  </div>

  <div class="card">
    <h2>特別ファストパス発券</h2>
    <form id="specialForm">
      <input type="text" id="specialName" placeholder="名前" required />
      <input type="number" id="specialPeople" placeholder="人数" min="1" required />
      <div class="time-slot-group">
        <input type="time" id="specialStartTime" placeholder="開始時間" required />
        <input type="time" id="specialEndTime" placeholder="終了時間" required />
      </div>
      <button type="submit" class="success">特別パス発行</button>
    </form>
  </div>

  <!-- ログ表示 -->
  <div class="card" id="logCard">
    <h2>ログイン履歴</h2>
    <button id="refreshLogs" class="primary">更新</button>
    <button id="clearLogs" class="danger">消去</button>
    <div id="logList"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, addDoc, collection, serverTimestamp, getDocs, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

// Firebase設定
const firebaseConfig = {
 apiKey: "AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
 authDomain: "fastpass-system.firebaseapp.com",
 projectId: "fastpass-system",
 storageBucket: "fastpass-system.appspot.com",
 messagingSenderId: "858745521872",
 appId: "1:858745521872:web:29289b673855097e1200d5"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// 管理者ID・パスワード
const allowedAdmins = [
  { id: "Sakoty", password: "3214" },
  { id: "seseguchi914", password: "0914" },
  { id: "2", password: "1928mickeymouse" },
  { id: "3", password: "1928mickeymouse" },
  { id: "4", password: "1928mickeymouse" }
];

const loginDiv = document.getElementById("loginDiv");
const mainContent = document.getElementById("mainContent");
const errorMsg = document.getElementById("errorMsg");
const loginForm = document.getElementById("loginForm");
const logoutBtn = document.getElementById("logoutBtn");
const logCard = document.getElementById("logCard");
const logList = document.getElementById("logList");
const refreshLogs = document.getElementById("refreshLogs");
const clearLogs = document.getElementById("clearLogs");

// ログイン状態確認
function checkLogin(){
  const storedId = localStorage.getItem("adminId");
  const storedPass = localStorage.getItem("adminPass");
  if(storedId && storedPass && allowedAdmins.some(a=>a.id===storedId && a.password===storedPass)){
    loginDiv.style.display="none";
    mainContent.style.display="block";
    logCard.style.display="block";
  }
}
checkLogin();

// ログ記録
async function recordLog(id,status){
  await addDoc(collection(db,"logs"),{
    adminId:id,
    status:status,
    timestamp:serverTimestamp()
  });
}

// ログイン処理
loginForm.onsubmit = async e => {
  e.preventDefault();
  const inputId = document.getElementById("adminId").value.trim();
  const inputPass = document.getElementById("adminPass").value;
  if(allowedAdmins.some(a=>a.id===inputId && a.password===inputPass)){
    localStorage.setItem("adminId", inputId);
    localStorage.setItem("adminPass", inputPass);
    loginDiv.style.display="none";
    mainContent.style.display="block";
    logCard.style.display="block";
    errorMsg.textContent="";
    await recordLog(inputId,"success");
  } else {
    errorMsg.textContent="IDまたはパスワードが違います";
    await recordLog(inputId,"failure");
  }
};

// ログアウト処理
logoutBtn.onclick = ()=> {
  localStorage.removeItem("adminId");
  localStorage.removeItem("adminPass");
  loginDiv.style.display="block";
  mainContent.style.display="none";
  logCard.style.display="none";
};

// 時計
function startClock() {
  setInterval(() => {
    const now = new Date();
    document.getElementById("clock").textContent =
      now.toLocaleDateString() + " " + now.toLocaleTimeString();
  }, 1000);
}
startClock();

// 発券ステータス
async function setIssueStatus(status){ await setDoc(doc(db,"settings","issueStatus"),{enabled:status}); updateStatusDisplay(); }
async function updateStatusDisplay(){
  const snap = await getDoc(doc(db,"settings","issueStatus"));
  const badge = document.getElementById("statusBadge");
  if(snap.exists() && snap.data().enabled){
    badge.textContent="発券中"; badge.className="status-badge active";
  } else { badge.textContent="停止中"; badge.className="status-badge inactive"; }
}
updateStatusDisplay();
document.getElementById("startBtn").onclick = async ()=>{ await setIssueStatus(true); };
document.getElementById("stopBtn").onclick = async ()=>{ await setIssueStatus(false); };

// 時刻操作ユーティリティ
function pad2(num){return num.toString().padStart(2,"0");}
function addMinutes(time, mins){let [h,m]=time.split(":").map(Number); m+=mins; while(m>=60){m-=60; h+=1;} while(h>=24){h-=24;} return `${pad2(h)}:${pad2(m)}`;}
function generateSlots(start,end,interval){const result=[];let current=start; while(current<end){const next=addMinutes(current,interval); if(next>end) break; result.push(current+"〜"+next); current=next;} return result;}

// 時間帯設定
document.getElementById("setTimeSlots").onsubmit = async e=>{
  e.preventDefault();
  const slots=[]; const limits=[];
  for(let i=1;i<=3;i++){
    const start=document.getElementById(`start${i}`).value;
    const end=document.getElementById(`end${i}`).value;
    const limit=parseInt(document.getElementById(`limit${i}`).value);
    const interval=parseInt(document.getElementById(`interval${i}`).value||"10");
    if(start && end && start<end && limit>0 && interval>0){
      const generated=generateSlots(start,end,interval);
      slots.push(...generated);
      limits.push(...Array(generated.length).fill(limit));
    }
  }
  if(!slots.length){ alert("最低1つの時間枠を入力してください。"); return; }
  try{ await setDoc(doc(db,"settings","timeSlots"),{slots,limits}); alert("時間枠を保存しました。"); }
  catch(e){ alert("保存に失敗しました: "+e.message); }
};

// 特別パス発券
document.getElementById("specialForm").onsubmit = async e=>{
  e.preventDefault();
  const name=document.getElementById("specialName").value.trim();
  const num=parseInt(document.getElementById("specialPeople").value);
  const start=document.getElementById("specialStartTime").value;
  const end=document.getElementById("specialEndTime").value;
  if(!name||isNaN(num)||num<1||!start||!end||start>=end){ alert("正しく入力してください。"); return; }
  const id="FP"+Math.floor(Math.random()*1000).toString().padStart(3,"0");
  const time=`${start}〜${end}`;
  try{ await addDoc(collection(db,"passes"),{id,number:-1,name,numPeople:num,time,used:false,createdAt:serverTimestamp(),special:true}); alert("特別パスを発行しました: "+id); document.getElementById("specialForm").reset(); }
  catch(e){ alert("発行に失敗しました: "+e.message); }
};

// 設定読み込み
async function loadTimeSlots(){
  try{
    const timeSlotSnap=await getDoc(doc(db,"settings","timeSlots"));
    if(timeSlotSnap.exists()){
      const data=timeSlotSnap.data();
      const slots=data.slots||[]; const limits=data.limits||[];
      let index=0;
      for(let i=1;i<=3;i++){
        if(index<slots.length){
          const firstSlot=slots[index].split("〜")[0];
          let j=index+1; while(j<slots.length && limits[j]===limits[index]) j++;
          const lastSlotEnd=slots[j-1].split("〜")[1];
          document.getElementById(`start${i}`).value=firstSlot;
          document.getElementById(`end${i}`).value=lastSlotEnd;
          if(index+1<slots.length){
            const [h1,m1]=firstSlot.split(":").map(Number);
            const [h2,m2]=slots[index+1].split("〜")[0].split(":").map(Number);
            const intervalMin=(h2*60+m2)-(h1*60+m1);
            document.getElementById(`interval${i}`).value=intervalMin>0?intervalMin:10;
          } else { document.getElementById(`interval${i}`).value=10; }
          document.getElementById(`limit${i}`).value=limits[index]||1;
          index=j;
        }
      }
    }
  } catch(err){ console.error("設定読み込みエラー:", err); }
}
loadTimeSlots();

// ログ操作
async function loadLogs(){
  logList.innerHTML="読み込み中...";
  try{
    const snap = await getDocs(collection(db,"logs"));
    if(snap.empty){ logList.innerHTML="ログなし"; return; }
    logList.innerHTML="";
    snap.forEach(docSnap=>{
      const data = docSnap.data();
      const time = data.timestamp?.toDate().toLocaleString() || "";
      const status = data.status==="success"?"✅ 成功":"❌ 失敗";
      logList.innerHTML += `<div>${time} - ID: ${data.adminId} - ${status}</div>`;
    });
  } catch(e){ logList.innerHTML="読み込み失敗"; console.error(e); }
}

refreshLogs.onclick = loadLogs;

clearLogs.onclick = async ()=>{
  if(!confirm("ログをすべて消去しますか？")) return;
  try{
    const snap = await getDocs(collection(db,"logs"));
    for(const docSnap of snap.docs){ await deleteDoc(doc(db,"logs",docSnap.id)); }
    alert("ログを消去しました");
    loadLogs();
  } catch(e){ alert("削除失敗: "+e.message); }
};

</script>
</body>
</html>
