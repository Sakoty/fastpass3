<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ファストパス設定</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
  <h2>案内可能時間帯の設定（最大3つ）</h2>
  <div id="ranges">
    <div><input type="time" id="start1"> ～ <input type="time" id="end1"></div>
    <div><input type="time" id="start2"> ～ <input type="time" id="end2"></div>
    <div><input type="time" id="start3"> ～ <input type="time" id="end3"></div>
  </div>
  <button onclick="saveSettings()">保存</button>

  <h2>特別ファストパス発行</h2>
  <input type="text" id="specialName" placeholder="名前">
  <input type="number" id="specialCount" placeholder="人数">
  <input type="time" id="specialTime">
  <button onclick="issueSpecial()">特別発券</button>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
      authDomain: "fastpass-system.firebaseapp.com",
      projectId: "fastpass-system",
      storageBucket: "fastpass-system.firebasestorage.app",
      messagingSenderId: "858745521872",
      appId: "1:858745521872:web:29289b673855097e1200d5",
      measurementId: "G-SLPKMCNY53"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function saveSettings() {
      const timeRanges = [];
      for (let i = 1; i <= 3; i++) {
        const start = document.getElementById(`start${i}`).value;
        const end = document.getElementById(`end${i}`).value;
        if (start && end) timeRanges.push(`${start}-${end}`);
      }

      await db.collection("settings").doc("timeConfig").set({ timeRanges });
      alert("設定を保存しました。");
    }

    async function issueSpecial() {
      const name = document.getElementById("specialName").value;
      const count = parseInt(document.getElementById("specialCount").value);
      const time = document.getElementById("specialTime").value;

      if (!name || isNaN(count) || !time) {
        alert("すべての項目を正しく入力してください。");
        return;
      }

      const snapshot = await db.collection("fastpasses").orderBy("createdAt", "desc").limit(1).get();
      let lastNumber = 0;
      if (!snapshot.empty) {
        const lastId = snapshot.docs[0].data().id;
        lastNumber = parseInt(lastId.replace("FP", ""));
      }
      const newId = "FP" + String(lastNumber + 1).padStart(3, '0');

      await db.collection("fastpasses").doc(newId).set({
        id: newId,
        name: name,
        count: count,
        used: false,
        time: time,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      alert(`${newId} を特別発券しました。`);
    }
  </script>
</body>
</html>
