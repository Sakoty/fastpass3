<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ファストパス・スキャン</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 1rem;
      text-align: center;
      background: #f5f5f5;
    }
    video {
      width: 100%;
      max-width: 480px;
      border: 2px solid #333;
      border-radius: 12px;
    }
    .result {
      margin-top: 1rem;
      font-size: 1.2rem;
      font-weight: bold;
    }
    .result.error {
      color: red;
    }
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    .modal-content {
      background: #fff;
      padding: 1rem 2rem;
      border-radius: 12px;
      max-width: 90%;
      text-align: center;
    }
    .modal-content button {
      margin: 0.5rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <h1>ファストパス・スキャン</h1>
  <video id="video" autoplay playsinline></video>
  <div class="result" id="result"></div>

  <div class="modal" id="modal">
    <div class="modal-content">
      <p id="modal-text">このファストパスを使用済みにしますか？</p>
      <button id="confirm">使用済みにする</button>
      <button id="cancel">キャンセル</button>
    </div>
  </div>

  <audio id="sound" src="success.mp3" preload="auto"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
      authDomain: "fastpass-system.firebaseapp.com",
      projectId: "fastpass-system",
      storageBucket: "fastpass-system.appspot.com",
      messagingSenderId: "858745521872",
      appId: "1:858745521872:web:29289b673855097e1200d5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const video = document.getElementById("video");
    const result = document.getElementById("result");
    const modal = document.getElementById("modal");
    const confirmBtn = document.getElementById("confirm");
    const cancelBtn = document.getElementById("cancel");
    const sound = document.getElementById("sound");

    let isReading = false;
    let pendingDoc = null;
    let pendingCode = "";

    function showResult(text, isError = false) {
      result.textContent = text;
      result.className = "result" + (isError ? " error" : "");
    }

    function showModal(text) {
      document.getElementById("modal-text").textContent = text;
      modal.style.display = "flex";
    }

    confirmBtn.onclick = async () => {
      if (pendingDoc) {
        await updateDoc(doc(db, "passes", pendingDoc.id), { used: true });
        showResult(`プライオリティパス ${pendingCode} を使用済みにしました`);
        sound.currentTime = 0;
        sound.play().catch(err => console.warn("音声エラー:", err));
      }
      modal.style.display = "none";
      setTimeout(() => { isReading = false }, 3000);
    };

    cancelBtn.onclick = () => {
      modal.style.display = "none";
      showResult("キャンセルしました", true);
      setTimeout(() => { isReading = false }, 3000);
    };

    async function handleScan(code) {
      if (isReading) return;
      isReading = true;

      const passesRef = collection(db, "passes");
      const q = query(passesRef, where("id", "==", code));
      const snapshot = await getDocs(q);

      if (snapshot.empty) {
        showResult("該当するプライオリティパスが見つかりません", true);
        setTimeout(() => { isReading = false }, 3000);
        return;
      }

      const docSnap = snapshot.docs[0];
      const data = docSnap.data();

      const now = new Date();
      const validUntil = data.validUntil?.toDate?.() || new Date(data.validUntil);

      if (data.used) {
        showResult("このファストパスはすでに使用済みです", true);
        setTimeout(() => { isReading = false }, 3000);
      } else if (validUntil < now) {
        showResult("このファストパスの有効期限は切れています", true);
        setTimeout(() => { isReading = false }, 3000);
      } else {
        pendingDoc = docSnap;
        pendingCode = code;
        showModal(`ファストパス ${code} を使用済みにしますか？`);
      }
    }

    function startCamera() {
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => {
          video.srcObject = stream;
          const track = stream.getVideoTracks()[0];
          const imageCapture = new ImageCapture(track);
          const scanLoop = async () => {
            if (!isReading) {
              try {
                const bitmap = await imageCapture.grabFrame();
                const canvas = document.createElement("canvas");
                canvas.width = bitmap.width;
                canvas.height = bitmap.height;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(bitmap, 0, 0);

                const codeReader = new ZXing.BrowserQRCodeReader();
                const luminanceSource = new ZXing.BitmapLuminanceSource(canvas);
                const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
                const result = codeReader.decode(binaryBitmap);
                if (result) {
                  handleScan(result.getText());
                }
              } catch (e) {
                // スキャン失敗は無視してループ継続
              }
            }
            requestAnimationFrame(scanLoop);
          };
          scanLoop();
        })
        .catch(err => {
          showResult("カメラの使用が許可されていません", true);
          console.error(err);
        });
    }

    // ZXing ライブラリ読み込み
    const script = document.createElement("script");
    script.src = "https://unpkg.com/@zxing/library@latest";
    script.onload = startCamera;
    document.body.appendChild(script);
  </script>
</body>
</html>
