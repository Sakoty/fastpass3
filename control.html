<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ファストパス管理（NFC対応・統合版）</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#007bff">
<style>
:root { --primary:#007bff; --success:#28a745; --danger:#dc3545; --bg:#f5f7fa; --text:#333; }
*{box-sizing:border-box} body { font-family:"Segoe UI", sans-serif; background:var(--bg); margin:0; color:var(--text); }
.container { max-width:980px; margin:auto; padding:14px; }
h1 { text-align:center; margin:10px 0 4px; }
#clock { text-align:center; font-weight:600; color:#555; margin-bottom:10px; }
.status-badge { display:inline-block; padding:6px 14px; border-radius:16px; font-weight:700; font-size:0.95rem; margin-top:6px; }
.active { background-color:var(--success); color:white; }
.inactive { background-color:var(--danger); color:white; }
.card { background:white; border-radius:12px; padding:16px; margin-top:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
label { font-weight:600; display:block; margin-top:10px; font-size:0.9rem; }
input, select { width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid #ccc; font-size:1rem; }
button { padding:12px; margin:6px 0; border:none; border-radius:10px; font-weight:700; cursor:pointer; width:100%; font-size:1rem; }
button.primary { background:var(--primary); color:white; }
button.success { background:var(--success); color:white; }
button.danger { background:var(--danger); color:white; }
.row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
@media(max-width:640px){ .row { grid-template-columns:1fr; } }
.tabs { display:flex; gap:6px; flex-wrap:wrap; margin:10px 0; }
.tab { flex:1; padding:12px; text-align:center; cursor:pointer; background:#e7e9ee; border-radius:10px; font-weight:700; }
.tab.active-tab { background:var(--primary); color:#fff; }
.tab-content { display:none; }
.tab-content.active { display:block; }
table { width:100%; border-collapse: collapse; margin-top:10px; background:white; border-radius:10px; overflow:hidden; }
th, td { border:1px solid #e5e7eb; padding:10px; text-align:center; color:#111; font-size:0.95rem; }
th { background:#f0f3ff; }
.badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:0.8rem; font-weight:700; }
.used { color:#0a7b26; }
.unused { color:#b91c1c; }
.expired { color:#b45309; }
#loginDiv { max-width:420px; margin:30px auto; padding:20px; background:#fff; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,0.12); }
#loginDiv input { width:100%; padding:10px; margin:8px 0; }
#loginDiv button { margin-top:6px; }
#errorMsg, #logAuthMsg { color:#e11d48; margin-top:10px; text-align:center; font-weight:700; }
#nfcPrompt { display:none; text-align:center; color:#e11d48; font-weight:700; }
.inline { display:inline-flex; gap:8px; align-items:center; }
.w-auto { width:auto; }
</style>
</head>
<body>

<!-- ログイン画面 -->
<div id="loginDiv">
  <h1>管理者ログイン</h1>
  <input type="text" id="adminId" placeholder="管理者ID" />
  <input type="password" id="adminPass" placeholder="パスワード" />
  <button id="loginSubmit" class="primary">パスワードでログイン</button>
  <button id="cardLoginBtn" class="success">NFCカードでログイン</button>
  <div id="errorMsg"></div>
  <div id="nfcPrompt">カードをかざしてください…</div>
</div>

<!-- 管理コンテンツ -->
<div class="container" id="mainContent" style="display:none;">
<h1>ファストパス管理</h1>
<div id="clock"></div>
<div style="text-align:center;">
  <span id="statusBadge" class="status-badge inactive">停止中</span>
</div>

<div class="tabs">
  <div class="tab active-tab" data-tab="controlTab">発券制御</div>
  <div class="tab" data-tab="timeTab">時間帯設定</div>
  <div class="tab" data-tab="specialTab">特別パス発券</div>
  <div class="tab" data-tab="passesTab">パス一覧</div>
  <div class="tab" data-tab="logTab">アクセスログ</div>
</div>

<!-- 発券制御 -->
<div class="tab-content active" id="controlTab">
  <div class="card">
    <div class="row">
      <button id="startBtn" class="success">発券開始</button>
      <button id="stopBtn" class="danger">発券停止</button>
    </div>
    <button id="logoutBtn" class="danger">ログアウト</button>
  </div>
</div>

<!-- 時間帯設定 -->
<div class="tab-content" id="timeTab">
  <div class="card">
    <form id="setTimeSlots">
      <p style="margin:0 0 6px;">開始・終了、間隔(分)・上限人数を各枠で設定</p>
      <div class="row">
        <div>
          <label>1枠目</label>
          <div class="row"><input type="time" id="start1"><input type="time" id="end1"></div>
          <div class="row"><input type="number" id="interval1" value="10" min="1" placeholder="間隔(分)"><input type="number" id="limit1" value="1" min="1" placeholder="上限人数"></div>
        </div>
        <div>
          <label>2枠目</label>
          <div class="row"><input type="time" id="start2"><input type="time" id="end2"></div>
          <div class="row"><input type="number" id="interval2" value="10" min="1" placeholder="間隔(分)"><input type="number" id="limit2" value="1" min="1" placeholder="上限人数"></div>
        </div>
      </div>
      <div class="row">
        <div>
          <label>3枠目</label>
          <div class="row"><input type="time" id="start3"><input type="time" id="end3"></div>
          <div class="row"><input type="number" id="interval3" value="10" min="1" placeholder="間隔(分)"><input type="number" id="limit3" value="1" min="1" placeholder="上限人数"></div>
        </div>
        <div>
          <label>既存設定の読み込み</label>
          <button type="button" id="reloadTimeBtn" class="w-auto primary">読み込み</button>
        </div>
      </div>
      <button type="submit" class="primary">時間設定を保存</button>
    </form>
  </div>
</div>

<!-- 特別パス発券 -->
<div class="tab-content" id="specialTab">
  <div class="card">
    <form id="specialForm">
      <div class="row">
        <input type="text" id="specialName" placeholder="名前" required>
        <input type="number" id="specialPeople" placeholder="人数" min="1" required>
      </div>
      <div class="row">
        <input type="time" id="specialStartTime" required>
        <input type="time" id="specialEndTime" required>
      </div>
      <button type="submit" class="success">特別パス発券</button>
    </form>
  </div>
</div>

<!-- パス一覧 -->
<div class="tab-content" id="passesTab">
  <div class="card">
    <button id="deleteAllBtn" class="danger w-auto">全削除</button>
    <table id="passesTable">
      <thead>
        <tr><th>ID</th><th>名前</th><th>人数</th><th>案内時間</th><th>種別</th><th>状態</th><th>操作</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- アクセスログ -->
<div class="tab-content" id="logTab">
  <div class="card">
    <div id="logAuthMsg"></div>
    <table id="logTable" style="display:none;">
      <thead><tr><th>日時</th><th>操作</th><th>管理者</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, addDoc, collection, serverTimestamp, getDoc, query, orderBy, onSnapshot, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
  authDomain: "fastpass-system.firebaseapp.com",
  projectId: "fastpass-system",
  storageBucket: "fastpass-system.appspot.com",
  messagingSenderId: "858745521872",
  appId: "1:858745521872:web:29289b673855097e1200d5"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const allowedAdmins = [
  {id:"Sakoty", password:"3214"},
  {id:"seseguchi914", password:"0914"}
];

const loginDiv = document.getElementById("loginDiv");
const mainContent = document.getElementById("mainContent");
const errorMsg = document.getElementById("errorMsg");
const nfcPrompt = document.getElementById("nfcPrompt");

// NFC認証ヘルパー
let nfcAuthResolve = null;
function requireNFCAuth(actionDesc='操作'){
  return new Promise((resolve,reject)=>{
    nfcAuthResolve = resolve;
    nfcPrompt.style.display='block';
    nfcPrompt.textContent = `${actionDesc}のためカードをかざしてください…`;
    loadSocketIfNeeded(()=>initNFC());
  });
}

function initNFC(isLogin=false){
  try{
    const socket = io('http://localhost:3000');
    if(isLogin) nfcPrompt.style.display='block';

    socket.on('adminAuthenticated', (data)=>{
      nfcPrompt.style.display='none';
      if(isLogin) loginSuccess('NFC:' + (data?.uid || 'unknown'));
      if(nfcAuthResolve){ nfcAuthResolve(true); nfcAuthResolve=null; }
    });
    socket.on('adminAuthFailed', (data)=>{
      nfcPrompt.style.display='none';
      errorMsg.textContent='カード認証に失敗しました';
      if(nfcAuthResolve){ nfcAuthResolve(false); nfcAuthResolve=null; }
    });
    socket.on('connect_error', ()=>{
      nfcPrompt.textContent='NFCサーバに接続できません';
      setTimeout(()=>{ nfcPrompt.style.display='none'; },1800);
      if(nfcAuthResolve){ nfcAuthResolve(false); nfcAuthResolve=null; }
    });
  } catch(e){
    console.error('NFC初期化失敗', e);
    if(nfcAuthResolve){ nfcAuthResolve(false); nfcAuthResolve=null; }
  }
}

// ログイン処理
document.getElementById('loginSubmit').onclick = () => {
  const id = document.getElementById('adminId').value.trim();
  const pass = document.getElementById('adminPass').value.trim();
  if(allowedAdmins.some(a=>a.id===id && a.password===pass)){
    loginSuccess(id);
  } else errorMsg.textContent = 'IDまたはパスワードが違います';
};
document.getElementById('cardLoginBtn').onclick = () => loadSocketIfNeeded(()=>initNFC(true));

function loginSuccess(adminId){
  localStorage.setItem('adminId', adminId);
  loginDiv.style.display='none';
  mainContent.style.display='block';
  logAccess(adminId,'ログイン成功','login');
  updateStatusDisplay();
  loadTimeSlots();
  startPassesListener();
  startLogListener();
}

// タブ切替
document.querySelectorAll('.tab').forEach(tab=>{
  tab.onclick = ()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active-tab'));
    document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));
    tab.classList.add('active-tab');
    document.getElementById(tab.dataset.tab).classList.add('active');
  };
});

// 時計表示
function updateClock(){ document.getElementById('clock').textContent=new Date().toLocaleTimeString(); }
setInterval(updateClock,1000); updateClock();

// 状態表示
function updateStatusDisplay(){
  const badge=document.getElementById('statusBadge');
  getDoc(doc(db,'settings','issueStatus')).then(d=>{
    if(d.exists() && d.data().active){ badge.textContent='発券中'; badge.className='status-badge active'; }
    else { badge.textContent='停止中'; badge.className='status-badge inactive'; }
  });
}

// 発券開始・停止
document.getElementById('startBtn').onclick = ()=>{
  requireNFCAuth('発券開始').then(ok=>{
    if(ok){ setDoc(doc(db,'settings','issueStatus'),{active:true},{merge:true}); updateStatusDisplay(); }
  });
};
document.getElementById('stopBtn').onclick = ()=>{
  requireNFCAuth('発券停止').then(ok=>{
    if(ok){ setDoc(doc(db,'settings','issueStatus'),{active:false},{merge:true}); updateStatusDisplay(); }
  });
};

// ログアウト
document.getElementById('logoutBtn').onclick = ()=>{ localStorage.removeItem('adminId'); location.reload(); };

// 時間帯設定
document.getElementById('setTimeSlots').onsubmit = async e=>{
  e.preventDefault();
  const slots=[];
  for(let i=1;i<=3;i++){
    const start=document.getElementById('start'+i).value;
    const end=document.getElementById('end'+i).value;
    const interval=parseInt(document.getElementById('interval'+i).value)||10;
    const limit=parseInt(document.getElementById('limit'+i).value)||1;
    if(start && end) slots.push({start,end,interval,limit});
  }
  await setDoc(doc(db,'settings','timeSlots'),{slots},{merge:true});
  alert('時間帯を保存しました');
};
document.getElementById('reloadTimeBtn').onclick = loadTimeSlots;
function loadTimeSlots(){
  getDoc(doc(db,'settings','timeSlots')).then(d=>{
    if(d.exists()){
      const s=d.data().slots||[];
      s.forEach((slot,i)=>{
        document.getElementById('start'+(i+1)).value=slot.start||'';
        document.getElementById('end'+(i+1)).value=slot.end||'';
        document.getElementById('interval'+(i+1)).value=slot.interval||10;
        document.getElementById('limit'+(i+1)).value=slot.limit||1;
      });
    }
  });
}

// 特別パス発券
document.getElementById('specialForm').onsubmit = async e=>{
  e.preventDefault();
  const name=document.getElementById('specialName').value.trim();
  const people=parseInt(document.getElementById('specialPeople').value);
  const start=document.getElementById('specialStartTime').value;
  const end=document.getElementById('specialEndTime').value;
  if(!name||!people||!start||!end) return alert('全て入力してください');
  const id='FP'+String(Math.floor(Math.random()*900+100));
  await addDoc(collection(db,'passes'),{id,name,people,start,end,type:'special',used:false,created:serverTimestamp()});
  alert('特別パスを発券しました');
};

// パス一覧表示
function startPassesListener(){
  const tbody=document.querySelector('#passesTable tbody');
  onSnapshot(collection(db,'passes'),snap=>{
    tbody.innerHTML='';
    snap.docs.sort((a,b)=>a.data().created?.toMillis()-b.data().created?.toMillis()).forEach(doc=>{
      const d=doc.data();
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${d.id}</td><td>${d.name}</td><td>${d.people}</td><td>${d.start}-${d.end}</td><td>${d.type}</td>
        <td><span class="badge ${d.used?'used':'unused'}">${d.used?'使用済み':'未使用'}</span></td>
        <td class="inline w-auto">
          <button class="success w-auto" onclick="toggleUsed('${doc.id}')">切替</button>
          <button class="danger w-auto" onclick="deletePass('${doc.id}')">削除</button>
        </td>`;
      tbody.appendChild(tr);
    });
  });
}
window.toggleUsed = id=>{
  requireNFCAuth('使用済み切替').then(ok=>{
    if(ok){
      const ref=doc(db,'passes',id);
      getDoc(ref).then(d=>{
        if(d.exists()) updateDoc(ref,{used:!d.data().used});
      });
    }
  });
};
window.deletePass=id=>{
  requireNFCAuth('削除').then(ok=>{ if(ok) deleteDoc(doc(db,'passes',id)); });
};
document.getElementById('deleteAllBtn').onclick = ()=>{
  requireNFCAuth('全削除').then(ok=>{
    if(ok) onSnapshot(collection(db,'passes'),snap=>{
      snap.docs.forEach(doc=>deleteDoc(doc.ref));
    });
  });
};

// アクセスログ
function logAccess(admin,action,type='action'){
  addDoc(collection(db,'logs'),{admin,action,type,time:serverTimestamp()});
}
function startLogListener(){
  const tbody=document.querySelector('#logTable tbody');
  onSnapshot(query(collection(db,'logs'),orderBy('time','desc')),(snap)=>{
    tbody.innerHTML='';
    snap.docs.forEach(doc=>{
      const d=doc.data();
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${d.time?.toDate().toLocaleString()||''}</td><td>${d.action}</td><td>${d.admin}</td>`;
      tbody.appendChild(tr);
    });
    document.getElementById('logTable').style.display='table';
  });
}

// NFCサーバロード
function loadSocketIfNeeded(cb){ if(typeof io!=='undefined'){ cb(); } else { const s=document.createElement('script'); s.src='https://cdn.socket.io/4.7.2/socket.io.min.js'; s.onload=cb; document.body.appendChild(s); } }
</script>
</body>
</html>
