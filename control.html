<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ファストパス管理（NFC対応・操作保護版）</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#007bff">
<style>
:root { --primary:#007bff; --success:#28a745; --danger:#dc3545; --bg:#f5f7fa; --text:#333; }
*{box-sizing:border-box}
body { font-family:"Segoe UI", sans-serif; background:var(--bg); margin:0; color:var(--text); }
.container { max-width:980px; margin:auto; padding:14px; }
h1 { text-align:center; margin:10px 0 4px; }
#clock { text-align:center; font-weight:600; color:#555; margin-bottom:10px; }
.status-badge { display:inline-block; padding:6px 14px; border-radius:16px; font-weight:700; font-size:0.95rem; margin-top:6px; }
.active { background-color:var(--success); color:white; }
.inactive { background-color:var(--danger); color:white; }
.card { background:white; border-radius:12px; padding:16px; margin-top:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
label { font-weight:600; display:block; margin-top:10px; font-size:0.9rem; }
input, select { width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid #ccc; font-size:1rem; }
button { padding:12px; margin:6px 0; border:none; border-radius:10px; font-weight:700; cursor:pointer; width:100%; font-size:1rem; }
button.primary { background:var(--primary); color:white; }
button.success { background:var(--success); color:white; }
button.danger { background:var(--danger); color:white; }
.row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
@media(max-width:640px){ .row { grid-template-columns:1fr; } }
.tabs { display:flex; gap:6px; flex-wrap:wrap; margin:10px 0; }
.tab { flex:1; padding:12px; text-align:center; cursor:pointer; background:#e7e9ee; border-radius:10px; font-weight:700; }
.tab.active-tab { background:var(--primary); color:#fff; }
.tab-content { display:none; }
.tab-content.active { display:block; }
table { width:100%; border-collapse: collapse; margin-top:10px; background:white; border-radius:10px; overflow:hidden; }
th, td { border:1px solid #e5e7eb; padding:10px; text-align:center; color:#111; font-size:0.95rem; }
th { background:#f0f3ff; }
.badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:0.8rem; font-weight:700; }
.used { color:#0a7b26; }
.unused { color:#b91c1c; }
.expired { color:#b45309; }
#loginDiv { max-width:420px; margin:30px auto; padding:20px; background:#fff; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,0.12); }
#loginDiv input { width:100%; padding:10px; margin:8px 0; }
#loginDiv button { margin-top:6px; }
#errorMsg, #logAuthMsg, #nfcPromptOp { color:#e11d48; margin-top:10px; text-align:center; font-weight:700; }
#nfcPrompt { display:none; text-align:center; color:#e11d48; font-weight:700; }
.inline { display:inline-flex; gap:8px; align-items:center; }
.w-auto { width:auto; }
</style>
</head>
<body>

<!-- ログイン画面 -->
<div id="loginDiv">
  <h1>管理者ログイン</h1>
  <input type="text" id="adminId" placeholder="管理者ID" />
  <input type="password" id="adminPass" placeholder="パスワード" />
  <button id="loginSubmit" class="primary">パスワードでログイン</button>
  <button id="cardLoginBtn" class="success">NFCカードでログイン</button>
  <div id="errorMsg"></div>
  <div id="nfcPrompt">カードをかざしてください…</div>
</div>

<!-- 管理コンテンツ -->
<div class="container" id="mainContent" style="display:none;">
  <h1>ファストパス管理</h1>
  <div id="clock"></div>
  <div style="text-align:center;">
    <span id="statusBadge" class="status-badge inactive">停止中</span>
  </div>

  <div class="tabs">
    <div class="tab active-tab" data-tab="controlTab">発券制御</div>
    <div class="tab" data-tab="timeTab">時間帯設定</div>
    <div class="tab" data-tab="specialTab">特別パス発券</div>
    <div class="tab" data-tab="passesTab">パス一覧</div>
    <div class="tab" data-tab="logTab">アクセスログ</div>
  </div>

  <!-- 発券制御 -->
  <div class="tab-content active" id="controlTab">
    <div class="card">
      <div class="row">
        <button id="startBtn" class="success">発券開始</button>
        <button id="stopBtn" class="danger">発券停止</button>
      </div>
      <button id="logoutBtn" class="danger">ログアウト</button>
    </div>
  </div>

  <!-- 時間帯設定 -->
  <div class="tab-content" id="timeTab">
    <div class="card">
      <form id="setTimeSlots">
        <p style="margin:0 0 6px;">開始・終了、間隔(分)・上限人数を各枠で設定</p>
        <div class="row">
          <div>
            <label>1枠目</label>
            <div class="row"><input type="time" id="start1"><input type="time" id="end1"></div>
            <div class="row"><input type="number" id="interval1" value="10" min="1" placeholder="間隔(分)"><input type="number" id="limit1" value="1" min="1" placeholder="上限人数"></div>
          </div>
          <div>
            <label>2枠目</label>
            <div class="row"><input type="time" id="start2"><input type="time" id="end2"></div>
            <div class="row"><input type="number" id="interval2" value="10" min="1" placeholder="間隔(分)"><input type="number" id="limit2" value="1" min="1" placeholder="上限人数"></div>
          </div>
        </div>
        <div class="row">
          <div>
            <label>3枠目</label>
            <div class="row"><input type="time" id="start3"><input type="time" id="end3"></div>
            <div class="row"><input type="number" id="interval3" value="10" min="1" placeholder="間隔(分)"><input type="number" id="limit3" value="1" min="1" placeholder="上限人数"></div>
          </div>
          <div>
            <label>既存設定の読み込み</label>
            <button type="button" id="reloadTimeBtn" class="w-auto primary">読み込み</button>
          </div>
        </div>
        <button type="submit" class="primary">時間設定を保存</button>
      </form>
    </div>
  </div>

  <!-- 特別パス発券 -->
  <div class="tab-content" id="specialTab">
    <div class="card">
      <form id="specialForm">
        <div class="row">
          <input type="text" id="specialName" placeholder="名前" required>
          <input type="number" id="specialPeople" placeholder="人数" min="1" required>
        </div>
        <div class="row">
          <input type="time" id="specialStartTime" required>
          <input type="time" id="specialEndTime" required>
        </div>
        <button type="submit" class="success">特別パス発券</button>
      </form>
    </div>
  </div>

  <!-- パス一覧 -->
  <div class="tab-content" id="passesTab">
    <div class="card">
      <div id="nfcPromptOp"></div>
      <table id="passesTable">
        <thead>
          <tr><th>ID</th><th>名前</th><th>人数</th><th>案内時間</th><th>状態</th><th>操作</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- アクセスログ -->
  <div class="tab-content" id="logTab">
    <div class="card">
      <div id="nfcPromptLog"></div>
      <table id="logTable">
        <thead><tr><th>日時</th><th>操作</th><th>管理者</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, addDoc, collection, serverTimestamp, getDoc, query, orderBy, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ================= Firebase ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
  authDomain: "fastpass-system.firebaseapp.com",
  projectId: "fastpass-system",
  storageBucket: "fastpass-system.appspot.com",
  messagingSenderId: "858745521872",
  appId: "1:858745521872:web:29289b673855097e1200d5"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* =============== 管理者リスト =============== */
const allowedAdmins = [
  {id:"Sakoty", password:"3214"},
  {id:"seseguchi914", password:"0914"}
];

/* ================= DOM ================= */
const loginDiv = document.getElementById("loginDiv");
const mainContent = document.getElementById("mainContent");
const errorMsg = document.getElementById("errorMsg");
const nfcPrompt = document.getElementById("nfcPrompt");
const nfcPromptOp = document.getElementById("nfcPromptOp");
const nfcPromptLog = document.getElementById("nfcPromptLog");

/* ================= ログイン ================= */
document.getElementById('loginSubmit').onclick = () => {
  const id = document.getElementById('adminId').value.trim();
  const pass = document.getElementById('adminPass').value.trim();
  if(allowedAdmins.some(a=>a.id===id && a.password===pass)){
    loginSuccess(id);
  } else { errorMsg.textContent = 'IDまたはパスワードが違います'; }
};
document.getElementById('cardLoginBtn').onclick = () => loadSocketIfNeeded(() => initNFC(true));

function loginSuccess(adminId){
  localStorage.setItem('adminId', adminId);
  loginDiv.style.display='none';
  mainContent.style.display='block';
  logAccess(adminId,'ログイン成功','login');
  updateStatusDisplay();
  loadTimeSlots();
  startPassesListener();
}

/* ================= Logout ================= */
document.getElementById('logoutBtn').onclick = () => {
  const id = localStorage.getItem('adminId')||'不明';
  logAccess(id,'ログアウト','admin');
  localStorage.removeItem('adminId');
  mainContent.style.display='none';
  loginDiv.style.display='block';
};

/* ================= タブ切替 ================= */
document.querySelectorAll('.tab').forEach(t => {
  t.onclick = ()=> {
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active-tab'));
    document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
    t.classList.add('active-tab');
    const tabId = t.dataset.tab;
    document.getElementById(tabId).classList.add('active');
    // アクセスログはNFC認証
    if(tabId==='logTab') { requireNFCAuth('log'); }
  };
});

/* ================= NFC (Socket.IO) ================= */
let nfcSocket = null;
function loadSocketIfNeeded(cb){
  if(window.io){ cb(); return; }
  const s=document.createElement('script');
  s.src='https://cdn.socket.io/4.7.1/socket.io.min.js';
  s.onload=cb; document.body.appendChild(s);
}
function initNFC(isLogin=false, opCallback=null){
  try{
    if(!nfcSocket) nfcSocket = io('http://localhost:3000');
    if(isLogin) nfcPrompt.style.display='block';
    if(opCallback) nfcPromptOp.style.display='block';
    nfcSocket.on('adminAuthenticated', (data)=>{
      if(isLogin){
        nfcPrompt.style.display='none';
        loginSuccess('NFC:'+ (data?.uid || 'unknown'));
        alert('カード認証成功: '+ (data?.uid || 'unknown'));
      }
      if(opCallback) {
        nfcPromptOp.style.display='none';
        opCallback();
      }
      if(opCallback==='log') {
        nfcPromptLog.style.display='none';
        loadAccessLogs();
      }
    });
    nfcSocket.on('connect_error', ()=>{
      if(isLogin){ nfcPrompt.textContent='NFCサーバに接続できません'; setTimeout(()=>{ nfcPrompt.style.display='none'; },1800); }
      if(opCallback) { nfcPromptOp.textContent='NFCサーバに接続できません'; setTimeout(()=>{ nfcPromptOp.style.display='none'; },1800); }
      if(opCallback==='log'){ nfcPromptLog.textContent='NFCサーバに接続できません'; setTimeout(()=>{ nfcPromptLog.style.display='none'; },1800); }
    });
  }catch(e){ console.error('NFC初期化失敗', e); }
}

function requireNFCAuth(op){
  if(op==='log'){
    nfcPromptLog.textContent='NFCカードをかざしてください…';
    nfcPromptLog.style.display='block';
    initNFC(false,'log');
  }
}

/* ================= Firestore操作 ================= */
function logAccess(admin, action, type){
  addDoc(collection(db,'accessLogs'),{
    admin: admin,
    action: action,
    type: type,
    time: serverTimestamp()
  });
}

/* ================= 発券ステータス ================= */
async function updateStatusDisplay(){
  const docRef = doc(db,'settings','issueStatus');
  const snap = await getDoc(docRef);
  const badge = document.getElementById('statusBadge');
  if(snap.exists() && snap.data().active){ badge.textContent='稼働中'; badge.className='status-badge active'; }
  else{ badge.textContent='停止中'; badge.className='status-badge inactive'; }
}
document.getElementById('startBtn').onclick = ()=>setIssueStatus(true);
document.getElementById('stopBtn').onclick = ()=>setIssueStatus(false);

async function setIssueStatus(active){
  await setDoc(doc(db,'settings','issueStatus'),{active:active});
  updateStatusDisplay();
  logAccess(localStorage.getItem('adminId'),'発券'+(active?'開始':'停止'),'admin');
}

/* ================= 時間帯設定 ================= */
document.getElementById('setTimeSlots').onsubmit=async(e)=>{
  e.preventDefault();
  const slots=[];
  for(let i=1;i<=3;i++){
    const start=document.getElementById('start'+i).value;
    const end=document.getElementById('end'+i).value;
    const interval=document.getElementById('interval'+i).value;
    const limit=document.getElementById('limit'+i).value;
    if(start&&end){ slots.push({start,end,interval:parseInt(interval),limit:parseInt(limit)}); }
  }
  await setDoc(doc(db,'settings','timeSlots'),{slots:slots});
  alert('保存しました');
};
document.getElementById('reloadTimeBtn').onclick=loadTimeSlots;
async function loadTimeSlots(){
  const snap=await getDoc(doc(db,'settings','timeSlots'));
  if(!snap.exists()) return;
  const slots=snap.data().slots||[];
  for(let i=1;i<=3;i++){
    if(slots[i-1]){
      document.getElementById('start'+i).value=slots[i-1].start||'';
      document.getElementById('end'+i).value=slots[i-1].end||'';
      document.getElementById('interval'+i).value=slots[i-1].interval||10;
      document.getElementById('limit'+i).value=slots[i-1].limit||1;
    }
  }
}

/* ================= 特別パス発券 ================= */
document.getElementById('specialForm').onsubmit=async(e)=>{
  e.preventDefault();
  const name=document.getElementById('specialName').value.trim();
  const people=parseInt(document.getElementById('specialPeople').value);
  const start=document.getElementById('specialStartTime').value;
  const end=document.getElementById('specialEndTime').value;
  const id='FP'+Math.floor(Math.random()*900+100);
  await setDoc(doc(db,'passes',id),{
    id,id,name,people,start,end,status:'未使用',special:true,timeCreated:serverTimestamp()
  });
  alert('発券完了: '+id);
  document.getElementById('specialForm').reset();
  logAccess(localStorage.getItem('adminId'),'特別パス発券:'+id,'admin');
};

/* ================= パス一覧 ================= */
function startPassesListener(){
  const q=query(collection(db,'passes'),orderBy('timeCreated','desc'));
  onSnapshot(q,(snap)=>{
    const tbody=document.querySelector('#passesTable tbody');
    tbody.innerHTML='';
    snap.forEach(docSnap=>{
      const p=docSnap.data();
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${p.id}</td>
        <td>${p.name}</td>
        <td>${p.people}</td>
        <td>${p.start}～${p.end}</td>
        <td class="badge ${p.status==='使用済'?'used':'unused'}">${p.status}</td>
        <td class="inline">
          <button class="success w-auto">使用済切替</button>
          <button class="danger w-auto">削除</button>
        </td>`;
      // 使用済切替
      tr.querySelectorAll('button')[0].onclick = ()=>requireNFCAuthForOp(async ()=>{
        const newStatus=p.status==='使用済'?'未使用':'使用済';
        await updateDoc(doc(db,'passes',p.id),{status:newStatus});
        logAccess(localStorage.getItem('adminId'),'パス状態変更:'+p.id,'admin');
      });
      // 削除
      tr.querySelectorAll('button')[1].onclick = ()=>requireNFCAuthForOp(async ()=>{
        if(confirm('削除しますか? '+p.id)){
          await deleteDoc(doc(db,'passes',p.id));
          logAccess(localStorage.getItem('adminId'),'パス削除:'+p.id,'admin');
        }
      });
      tbody.appendChild(tr);
    });
  });
}

function requireNFCAuthForOp(callback){
  nfcPromptOp.textContent='操作にはNFCカード認証が必要です…';
  nfcPromptOp.style.display='block';
  initNFC(false,callback);
}

/* ================= アクセスログ ================= */
async function loadAccessLogs(){
  const q=query(collection(db,'accessLogs'),orderBy('time','desc'));
  onSnapshot(q,(snap)=>{
    const tbody=document.querySelector('#logTable tbody');
    tbody.innerHTML='';
    snap.forEach(docSnap=>{
      const l=docSnap.data();
      const tr=document.createElement('tr');
      const t=new Date(l.time?.seconds*1000||Date.now()).toLocaleString();
      tr.innerHTML=`<td>${t}</td><td>${l.action}</td><td>${l.admin}</td>`;
      tbody.appendChild(tr);
    });
  });
}

/* ================= 時計 ================= */
setInterval(()=>{ document.getElementById('clock').textContent=new Date().toLocaleString(); },1000);

</script>
</body>
</html>
