<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ファストパス管理（NFC対応・統合版）</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#007bff">
<style>
  :root {
    --primary:#007bff; --success:#28a745; --danger:#dc3545; --bg:#f5f7fa; --text:#333;
  }
  *{box-sizing:border-box}
  body { font-family:"Segoe UI", sans-serif; background:var(--bg); margin:0; color:var(--text); }
  .container { max-width:980px; margin:auto; padding:14px; }
  h1 { text-align:center; margin:10px 0 4px; }
  #clock { text-align:center; font-weight:600; color:#555; margin-bottom:10px; }
  .status-badge { display:inline-block; padding:6px 14px; border-radius:16px; font-weight:700; font-size:0.95rem; margin-top:6px; }
  .active { background-color:var(--success); color:white; }
  .inactive { background-color:var(--danger); color:white; }
  .card { background:white; border-radius:12px; padding:16px; margin-top:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
  label { font-weight:600; display:block; margin-top:10px; font-size:0.9rem; }
  input, select { width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid #ccc; font-size:1rem; }
  button { padding:12px; margin:6px 0; border:none; border-radius:10px; font-weight:700; cursor:pointer; width:100%; font-size:1rem; }
  button.primary { background:var(--primary); color:white; }
  button.success { background:var(--success); color:white; }
  button.danger { background:var(--danger); color:white; }
  .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  @media(max-width:640px){ .row { grid-template-columns:1fr; } }
  .tabs { display:flex; gap:6px; flex-wrap:wrap; margin:10px 0; }
  .tab { flex:1; padding:12px; text-align:center; cursor:pointer; background:#e7e9ee; border-radius:10px; font-weight:700; }
  .tab.active-tab { background:var(--primary); color:#fff; }
  .tab-content { display:none; }
  .tab-content.active { display:block; }
  table { width:100%; border-collapse: collapse; margin-top:10px; background:white; border-radius:10px; overflow:hidden; }
  th, td { border:1px solid #e5e7eb; padding:10px; text-align:center; color:#111; font-size:0.95rem; }
  th { background:#f0f3ff; }
  .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:0.8rem; font-weight:700; }
  .used { color:#0a7b26; }
  .unused { color:#b91c1c; }
  .expired { color:#b45309; }
  #loginDiv { max-width:420px; margin:30px auto; padding:20px; background:#fff; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,0.12); }
  #loginDiv input { width:100%; padding:10px; margin:8px 0; }
  #loginDiv button { margin-top:6px; }
  #errorMsg, #logAuthMsg { color:#e11d48; margin-top:10px; text-align:center; font-weight:700; }
  #nfcPrompt { display:none; text-align:center; color:#e11d48; font-weight:700; }
  .inline { display:inline-flex; gap:8px; align-items:center; }
  .w-auto { width:auto; }
</style>
</head>
<body>

<!-- ログイン画面 -->
<div id="loginDiv">
  <h1>管理者ログイン</h1>
  <input type="text" id="adminId" placeholder="管理者ID" />
  <input type="password" id="adminPass" placeholder="パスワード" />
  <button id="loginSubmit" class="primary">パスワードでログイン</button>
  <button id="cardLoginBtn" class="success">NFCカードでログイン</button>
  <div id="errorMsg"></div>
  <div id="nfcPrompt">カードをかざしてください…</div>
</div>

<!-- 管理コンテンツ -->
<div class="container" id="mainContent" style="display:none;">
  <h1>ファストパス管理</h1>
  <div id="clock"></div>
  <div style="text-align:center;">
    <span id="statusBadge" class="status-badge inactive">停止中</span>
  </div>

  <div class="tabs">
    <div class="tab active-tab" data-tab="controlTab">発券制御</div>
    <div class="tab" data-tab="timeTab">時間帯設定</div>
    <div class="tab" data-tab="specialTab">特別パス発券</div>
    <div class="tab" data-tab="passesTab">パス一覧</div>
    <div class="tab" data-tab="logTab">アクセスログ</div>
  </div>

  <!-- 発券制御 -->
  <div class="tab-content active" id="controlTab">
    <div class="card">
      <div class="row">
        <button id="startBtn" class="success">発券開始</button>
        <button id="stopBtn" class="danger">発券停止</button>
      </div>
      <button id="logoutBtn" class="danger">ログアウト</button>
    </div>
  </div>

  <!-- 時間帯設定 -->
  <div class="tab-content" id="timeTab">
    <div class="card">
      <form id="setTimeSlots">
        <p style="margin:0 0 6px;">開始・終了、間隔(分)・上限人数を各枠で設定</p>
        <div class="row">
          <div>
            <label>1枠目</label>
            <div class="row"><input type="time" id="start1"><input type="time" id="end1"></div>
            <div class="row"><input type="number" id="interval1" value="10" min="1" placeholder="間隔(分)"><input type="number" id="limit1" value="1" min="1" placeholder="上限人数"></div>
          </div>
          <div>
            <label>2枠目</label>
            <div class="row"><input type="time" id="start2"><input type="time" id="end2"></div>
            <div class="row"><input type="number" id="interval2" value="10" min="1" placeholder="間隔(分)"><input type="number" id="limit2" value="1" min="1" placeholder="上限人数"></div>
          </div>
        </div>
        <div class="row">
          <div>
            <label>3枠目</label>
            <div class="row"><input type="time" id="start3"><input type="time" id="end3"></div>
            <div class="row"><input type="number" id="interval3" value="10" min="1" placeholder="間隔(分)"><input type="number" id="limit3" value="1" min="1" placeholder="上限人数"></div>
          </div>
          <div>
            <label>既存設定の読み込み</label>
            <button type="button" id="reloadTimeBtn" class="w-auto primary">読み込み</button>
          </div>
        </div>
        <button type="submit" class="primary">時間設定を保存</button>
      </form>
    </div>
  </div>

  <!-- 特別パス発券 -->
  <div class="tab-content" id="specialTab">
    <div class="card">
      <form id="specialForm">
        <div class="row">
          <input type="text" id="specialName" placeholder="名前" required>
          <input type="number" id="specialPeople" placeholder="人数" min="1" required>
        </div>
        <div class="row">
          <input type="time" id="specialStartTime" required>
          <input type="time" id="specialEndTime" required>
        </div>
        <button type="submit" class="success">特別パス発行</button>
      </form>
    </div>
  </div>

  <!-- パス一覧 -->
  <div class="tab-content" id="passesTab">
    <div class="card">
      <div class="inline" style="margin-bottom:8px;">
        <button id="deleteAllBtn" class="danger w-auto">全件削除（NFC認証）</button>
        <span id="nfcInlineMsg" class="w-auto" style="font-weight:700;color:#b91c1c;display:none;">カードをかざしてください…</span>
      </div>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>発券ID</th>
              <th>名前</th>
              <th>人数</th>
              <th>案内時間</th>
              <th>種別</th>
              <th>状態</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="passesTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- アクセスログ -->
  <div class="tab-content" id="logTab">
    <div class="card" id="logAuthCard">
      <div class="row">
        <input type="password" id="logPass" placeholder="ログ閲覧パスワード">
        <button id="logAuthBtn" class="primary w-auto">認証</button>
      </div>
      <div id="logAuthMsg"></div>
    </div>
    <div class="card" id="logContent" style="display:none;">
      <button id="clearLogsBtn" class="danger">ログ全削除</button>
      <div id="accessLogs" style="border:1px solid #e5e7eb;border-radius:8px;padding:10px;max-height:360px;overflow:auto;background:#fff;color:#111;margin-top:10px;"></div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, addDoc, collection, serverTimestamp, getDocs, query, orderBy, deleteDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ================= Firebase ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
  authDomain: "fastpass-system.firebaseapp.com",
  projectId: "fastpass-system",
  storageBucket: "fastpass-system.appspot.com",
  messagingSenderId: "858745521872",
  appId: "1:858745521872:web:29289b673855097e1200d5"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* =============== ローカル管理者（簡易） =============== */
const allowedAdmins = [
  {id:"Sakoty", password:"3214"},
  {id:"seseguchi914", password:"0914"}
];

/* ================= DOM ================= */
const loginDiv = document.getElementById("loginDiv");
const mainContent = document.getElementById("mainContent");
const errorMsg = document.getElementById("errorMsg");
const nfcPrompt = document.getElementById("nfcPrompt");

// 時計
setInterval(()=>{ const d=new Date(); document.getElementById("clock").textContent = d.toLocaleString(); },1000);

// タブ切替
Array.from(document.querySelectorAll('.tab')).forEach(tab=>{
  tab.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active-tab'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    tab.classList.add('active-tab');
    document.getElementById(tab.dataset.tab).classList.add('active');
  });
});

/* ================= ログイン処理 ================= */
const passLoginBtn = document.getElementById('loginSubmit');
passLoginBtn.onclick = () => {
  const id = document.getElementById('adminId').value.trim();
  const pass = document.getElementById('adminPass').value.trim();
  if(allowedAdmins.some(a=>a.id===id && a.password===pass)){
    loginSuccess(id);
  } else {
    errorMsg.textContent = 'IDまたはパスワードが違います';
  }
};

// NFCログイン
const cardLoginBtn = document.getElementById('cardLoginBtn');
cardLoginBtn.onclick = () => { loadSocketIfNeeded(() => initNFC(true)); };

function loginSuccess(adminId){
  localStorage.setItem('adminId', adminId);
  loginDiv.style.display = 'none';
  mainContent.style.display = 'block';
  logAccess(adminId, 'ログイン成功', 'login');
  updateStatusDisplay();
  loadTimeSlots();
  startPassesListener();
}

function logout(){
  const id = localStorage.getItem('adminId')||'不明';
  logAccess(id, 'ログアウト', 'admin');
  localStorage.removeItem('adminId');
  mainContent.style.display='none';
  loginDiv.style.display='block';
}

document.getElementById('logoutBtn').onclick = logout;

/* ================= 発券ステータス ================= */
async function setIssueStatus(status){
  await setDoc(doc(db,'settings','issueStatus'), { enabled: status, updatedAt: serverTimestamp() });
  updateStatusDisplay();
}

async function updateStatusDisplay(){
  const snap = await getDoc(doc(db,'settings','issueStatus'));
  const val = snap.exists() ? snap.data().enabled : false;
  const badge = document.getElementById('statusBadge');
  badge.textContent = val?'稼働中':'停止中';
  badge.className = val?'status-badge active':'status-badge inactive';
}

document.getElementById('startBtn').onclick = ()=>setIssueStatus(true);
document.getElementById('stopBtn').onclick = ()=>setIssueStatus(false);

/* ================= 時間帯設定 ================= */
async function saveTimeSlots(e){
  e.preventDefault();
  const slots = [];
  for(let i=1;i<=3;i++){
    const start = document.getElementById('start'+i).value;
    const end = document.getElementById('end'+i).value;
    const interval = parseInt(document.getElementById('interval'+i).value)||10;
    const limit = parseInt(document.getElementById('limit'+i).value)||1;
    if(start && end){ slots.push({start,end,interval,limit}); }
  }
  await setDoc(doc(db,'settings','timeSlots'),{slots,updatedAt:serverTimestamp()});
  alert('時間帯設定を保存しました');
}

document.getElementById('setTimeSlots').onsubmit = saveTimeSlots;

async function loadTimeSlots(){
  const snap = await getDoc(doc(db,'settings','timeSlots'));
  if(!snap.exists()) return;
  const { slots } = snap.data();
  slots.forEach((s,i)=>{
    document.getElementById('start'+(i+1)).value = s.start;
    document.getElementById('end'+(i+1)).value = s.end;
    document.getElementById('interval'+(i+1)).value = s.interval;
    document.getElementById('limit'+(i+1)).value = s.limit;
  });
}

document.getElementById('reloadTimeBtn').onclick = loadTimeSlots;

/* ================= 特別パス発券 ================= */
document.getElementById('specialForm').onsubmit = async (e)=>{
  e.preventDefault();
  const name = document.getElementById('specialName').value.trim();
  const people = parseInt(document.getElementById('specialPeople').value)||1;
  const start = document.getElementById('specialStartTime').value;
  const end = document.getElementById('specialEndTime').value;
  if(!name || !start || !end) { alert('必須項目を入力してください'); return; }
  const id = await generatePassId();
  await setDoc(doc(db,'passes',id),{
    id,name,people,start,end,type:'special',status:'unused',createdAt:serverTimestamp()
  });
  alert('特別パス発券しました: '+id);
  e.target.reset();
}

/* ================= パス一覧 ================= */
const passesTableBody = document.getElementById('passesTableBody');
let passesListener=null;

function startPassesListener(){
  if(passesListener) passesListener(); // 前リスナー解除
  passesListener = onSnapshot(collection(db,'passes'), snap=>{
    passesTableBody.innerHTML='';
    snap.docs.sort((a,b)=>a.data().id.localeCompare(b.data().id)).forEach(docSnap=>{
      const d = docSnap.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${d.id}</td>
        <td>${d.name}</td>
        <td>${d.people}</td>
        <td>${d.start}〜${d.end}</td>
        <td>${d.type}</td>
        <td class="${d.status==='used'?'used':'unused'}">${d.status}</td>
        <td><button class="js-del w-auto danger">削除(NFC)</button></td>
      `;
      const btn = tr.querySelector('.js-del');
      btn.onclick = ()=>{
        showInlineNFC(true);
        initNFC(false, async (ok)=>{
          if(ok){
            await deleteDoc(doc(db,'passes',d.id));
            showInlineNFC(false);
          } else { inlineNFCFailOnce(); }
        });
      }
      passesTableBody.appendChild(tr);
    });
  });
}

// 全件削除
const deleteAllBtn = document.getElementById('deleteAllBtn');
deleteAllBtn.onclick = ()=>{
  if(!confirm('本当に全件削除しますか？')) return;
  showInlineNFC(true);
  initNFC(false, async (ok)=>{
    if(ok){
      const snap = await getDocs(collection(db,'passes'));
      for(const d of snap.docs){ await deleteDoc(doc(db,'passes',d.id)); }
      showInlineNFC(false);
    } else { inlineNFCFailOnce(); }
  });
}

function showInlineNFC(show){ document.getElementById('nfcInlineMsg').style.display = show?'inline-flex':'none'; }
function inlineNFCFailOnce(){ alert('NFC認証失敗'); }

/* ================= ログ記録 ================= */
async function logAccess(admin, message, type){
  await addDoc(collection(db,'accessLogs'),{
    admin,message,type,time:serverTimestamp()
  });
}

/* ================= NFC関連 ================= */
function loadSocketIfNeeded(cb){
  if(window.io){ cb(); return; }
  const s=document.createElement('script');
  s.src='https://cdn.socket.io/4.7.1/socket.io.min.js';
  s.onload=cb; document.body.appendChild(s);
}

function initNFC(isLogin=false, callback=null){
  try{
    const socket = io('http://localhost:3000'); // NFCサーバURL
    if(isLogin) nfcPrompt.style.display='block';
    socket.on('connect_error', ()=>{
      if(isLogin){ nfcPrompt.textContent='NFCサーバ接続不可'; setTimeout(()=>nfcPrompt.style.display='none',1800);}
    });
    socket.on('nfc-auth', (data)=>{
      if(data.success){
        if(isLogin){
          nfcPrompt.style.display='none';
          loginSuccess('NFC:'+data.uid);
          alert('カード認証成功: '+data.uid);
        } else if(callback) callback(true);
      }
      if(data.removed){
        if(isLogin){ nfcPrompt.style.display='none'; }
        if(callback) callback(false);
      }
    });
  }catch(e){ console.error('NFC初期化失敗', e); if(callback) callback(false);}
}

/* ================= 発券ID生成 ================= */
async function generatePassId(){
  const snap = await getDocs(collection(db,'passes'));
  const ids = snap.docs.map(d=>parseInt(d.id.replace('FP',''))||0);
  const next = (Math.max(0,...ids)+1).toString().padStart(3,'0');
  return 'FP'+next;
}

</script>
</body>
</html>
