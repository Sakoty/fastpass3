<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ファストパス管理（NFC対応）</title>
<style>
:root{--primary:#007bff;--success:#28a745;--danger:#dc3545;--bg:#f5f7fa;--text:#333;}
*{box-sizing:border-box;}
body{margin:0;font-family:"Segoe UI",sans-serif;background:var(--bg);color:var(--text);}
.container{max-width:980px;margin:auto;padding:14px;}
h1{text-align:center;margin:10px 0 4px;}
#clock{text-align:center;font-weight:600;color:#555;margin-bottom:10px;}
.status-badge{display:inline-block;padding:6px 14px;border-radius:16px;font-weight:700;font-size:0.95rem;margin-top:6px;}
.active{background-color:var(--success);color:white;}
.inactive{background-color:var(--danger);color:white;}
.card{background:white;border-radius:12px;padding:16px;margin-top:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);}
label{font-weight:600;display:block;margin-top:10px;font-size:0.9rem;}
input,select{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #ccc;font-size:1rem;}
button{padding:12px;margin:6px 0;border:none;border-radius:10px;font-weight:700;cursor:pointer;width:100%;font-size:1rem;}
button.primary{background:var(--primary);color:white;}
button.success{background:var(--success);color:white;}
button.danger{background:var(--danger);color:white;}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
@media(max-width:640px){.row{grid-template-columns:1fr;}}
.tabs{display:flex;gap:6px;flex-wrap:wrap;margin:10px 0;}
.tab{flex:1;padding:12px;text-align:center;cursor:pointer;background:#e7e9ee;border-radius:10px;font-weight:700;}
.tab.active-tab{background:var(--primary);color:#fff;}
.tab-content{display:none;}
.tab-content.active{display:block;}
table{width:100%;border-collapse: collapse;margin-top:10px;background:white;border-radius:10px;overflow:hidden;}
th,td{border:1px solid #e5e7eb;padding:10px;text-align:center;color:#111;font-size:0.95rem;}
th{background:#f0f3ff;}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:0.8rem;font-weight:700;}
.used{color:#0a7b26;}
.unused{color:#b91c1c;}
#loginDiv{max-width:420px;margin:30px auto;padding:20px;background:#fff;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.12);}
#loginDiv input{width:100%;padding:10px;margin:8px 0;}
#loginDiv button{margin-top:6px;}
#errorMsg,#logAuthMsg{color:#e11d48;margin-top:10px;text-align:center;font-weight:700;}
#nfcPrompt{display:none;text-align:center;color:#e11d48;font-weight:700;}
.inline{display:inline-flex;gap:8px;align-items:center;}
.w-auto{width:auto;}
</style>
</head>
<body>

<!-- ログイン画面 -->
<div id="loginDiv">
  <h1>管理者ログイン</h1>
  <input type="text" id="adminId" placeholder="管理者ID" />
  <input type="password" id="adminPass" placeholder="パスワード" />
  <button id="loginSubmit" class="primary">パスワードでログイン</button>
  <button id="cardLoginBtn" class="success">NFCカードでログイン</button>
  <div id="errorMsg"></div>
  <div id="nfcPrompt">カードをかざしてください…</div>
</div>

<!-- 管理コンテンツ -->
<div class="container" id="mainContent" style="display:none;">
  <h1>ファストパス管理</h1>
  <div id="clock"></div>
  <div style="text-align:center;">
    <span id="statusBadge" class="status-badge inactive">停止中</span>
  </div>

  <div class="tabs">
    <div class="tab active-tab" data-tab="controlTab">発券制御</div>
    <div class="tab" data-tab="timeTab">時間帯設定</div>
    <div class="tab" data-tab="specialTab">特別パス発券</div>
    <div class="tab" data-tab="passesTab">パス一覧</div>
    <div class="tab" data-tab="logTab">アクセスログ</div>
  </div>

  <!-- 発券制御 -->
  <div class="tab-content active" id="controlTab">
    <div class="card">
      <div class="row">
        <button id="startBtn" class="success">発券開始</button>
        <button id="stopBtn" class="danger">発券停止</button>
      </div>
      <button id="logoutBtn" class="danger">ログアウト</button>
    </div>
  </div>

  <!-- 時間帯設定 -->
  <div class="tab-content" id="timeTab">
    <div class="card">
      <form id="setTimeSlots">
        <p style="margin:0 0 6px;">開始・終了、間隔(分)・上限人数を各枠で設定</p>
        <div class="row">
          <div>
            <label>1枠目</label>
            <div class="row"><input type="time" id="start1"><input type="time" id="end1"></div>
            <div class="row"><input type="number" id="interval1" value="10" min="1"><input type="number" id="limit1" value="1" min="1"></div>
          </div>
          <div>
            <label>2枠目</label>
            <div class="row"><input type="time" id="start2"><input type="time" id="end2"></div>
            <div class="row"><input type="number" id="interval2" value="10" min="1"><input type="number" id="limit2" value="1" min="1"></div>
          </div>
        </div>
        <div class="row">
          <div>
            <label>3枠目</label>
            <div class="row"><input type="time" id="start3"><input type="time" id="end3"></div>
            <div class="row"><input type="number" id="interval3" value="10" min="1"><input type="number" id="limit3" value="1" min="1"></div>
          </div>
          <div>
            <label>既存設定の読み込み</label>
            <button type="button" id="reloadTimeBtn" class="w-auto primary">読み込み</button>
          </div>
        </div>
        <button type="submit" class="primary">時間設定を保存</button>
      </form>
    </div>
  </div>

  <!-- 特別パス発券 -->
  <div class="tab-content" id="specialTab">
    <div class="card">
      <form id="specialForm">
        <div class="row">
          <input type="text" id="specialName" placeholder="名前" required>
          <input type="number" id="specialPeople" placeholder="人数" min="1" required>
        </div>
        <div class="row">
          <input type="time" id="specialStartTime" required>
          <input type="time" id="specialEndTime" required>
        </div>
        <button type="submit" class="success">特別パス発行</button>
      </form>
    </div>
  </div>

  <!-- パス一覧 -->
  <div class="tab-content" id="passesTab">
    <div class="card">
      <div class="inline" style="margin-bottom:8px;">
        <button id="deleteAllBtn" class="danger w-auto">全件削除（NFC認証）</button>
        <span id="nfcInlineMsg" class="w-auto" style="font-weight:700;color:#b91c1c;display:none;">カードをかざしてください…</span>
      </div>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>発券ID</th>
              <th>名前</th>
              <th>人数</th>
              <th>案内時間</th>
              <th>種別</th>
              <th>状態</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="passesTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- アクセスログ -->
  <div class="tab-content" id="logTab">
    <div class="card" id="logAuthCard">
      <div class="row">
        <input type="password" id="logPass" placeholder="ログ閲覧パスワード">
        <button id="logAuthBtn" class="primary w-auto">認証</button>
      </div>
      <div id="logAuthMsg"></div>
    </div>
    <div class="card" id="logContent" style="display:none;">
      <button id="clearLogsBtn" class="danger">ログ全削除</button>
      <div id="accessLogs" style="border:1px solid #e5e7eb;border-radius:8px;padding:10px;max-height:360px;overflow:auto;background:#fff;color:#111;margin-top:10px;"></div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, addDoc, collection, serverTimestamp, onSnapshot, query, orderBy, deleteDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
  authDomain: "fastpass-system.firebaseapp.com",
  projectId: "fastpass-system",
  storageBucket: "fastpass-system.appspot.com",
  messagingSenderId: "858745521872",
  appId: "1:858745521872:web:29289b673855097e1200d5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================== タブ切替 ================== */
document.querySelectorAll('.tab').forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active-tab'));
    tab.classList.add('active-tab');
    const target=tab.dataset.tab;
    document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));
    document.getElementById(target).classList.add('active');
  };
});

/* ================== 管理者ログイン ================== */
const loginDiv = document.getElementById('loginDiv');
const mainContent = document.getElementById('mainContent');
const errorMsg = document.getElementById('errorMsg');
document.getElementById('loginSubmit').onclick = ()=>{
  const id = document.getElementById('adminId').value.trim();
  const pass = document.getElementById('adminPass').value;
  if(id==='admin' && pass==='0914'){
    localStorage.setItem('adminId',id);
    loginSuccess(id);
  } else { errorMsg.textContent='IDまたはパスワードが違います'; }
};
document.getElementById('cardLoginBtn').onclick = ()=>initNFC(true,false);
function loginSuccess(id){
  loginDiv.style.display='none';
  mainContent.style.display='block';
  startClock();
  startPassesListener();
  loadTimeSlots();
}

/* ================== 発券ステータス ================== */
const statusBadge = document.getElementById('statusBadge');
document.getElementById('startBtn').onclick=()=>{ statusBadge.textContent='発券中'; statusBadge.classList.add('active'); statusBadge.classList.remove('inactive'); };
document.getElementById('stopBtn').onclick=()=>{ statusBadge.textContent='停止中'; statusBadge.classList.add('inactive'); statusBadge.classList.remove('active'); };
document.getElementById('logoutBtn').onclick=()=>{
  localStorage.removeItem('adminId');
  location.reload();
};

/* ================== 時計 ================== */
function startClock(){ setInterval(()=>{document.getElementById('clock').textContent=new Date().toLocaleTimeString();},1000); }

/* ================== 時間帯設定 ================== */
async function loadTimeSlots(){
  const snap = await getDoc(doc(db,'settings','timeSlots'));
  if(snap.exists()){
    const data = snap.data();
    for(let i=1;i<=3;i++){
      if(data[`slot${i}`]){
        document.getElementById(`start${i}`).value = data[`slot${i}`].start;
        document.getElementById(`end${i}`).value = data[`slot${i}`].end;
        document.getElementById(`interval${i}`).value = data[`slot${i}`].interval;
        document.getElementById(`limit${i}`).value = data[`slot${i}`].limit;
      }
    }
  }
}
document.getElementById('reloadTimeBtn').onclick = loadTimeSlots;
document.getElementById('setTimeSlots').onsubmit=async e=>{
  e.preventDefault();
  const slots={};
  for(let i=1;i<=3;i++){
    slots[`slot${i}`]={start:document.getElementById(`start${i}`).value,end:document.getElementById(`end${i}`).value,interval:parseInt(document.getElementById(`interval${i}`).value)||10,limit:parseInt(document.getElementById(`limit${i}`).value)||1};
  }
  await setDoc(doc(db,'settings','timeSlots'),slots);
  alert('時間帯設定を保存しました');
};

/* ================== 特別パス発券 ================== */
document.getElementById('specialForm').onsubmit = async e=>{
  e.preventDefault();
  const name=document.getElementById('specialName').value.trim();
  const people=parseInt(document.getElementById('specialPeople').value);
  const start=document.getElementById('specialStartTime').value;
  const end=document.getElementById('specialEndTime').value;
  if(!name||!people||!start||!end){ alert('全て入力してください'); return; }
  const newPass={id:`FP${Math.floor(Math.random()*900+100)}`,name,people,startTime:start,endTime:end,type:'特別',used:false,createdAt:serverTimestamp()};
  await addDoc(collection(db,'passes'),newPass);
  alert(`特別パス ${newPass.id} を発券しました`);
  document.getElementById('specialForm').reset();
};

/* ================== パス一覧 ================== */
async function startPassesListener(){
  const tbody=document.getElementById('passesTableBody');
  const q=query(collection(db,'passes'),orderBy('createdAt','desc'));
  onSnapshot(q,snap=>{
    tbody.innerHTML='';
    snap.forEach(docSnap=>{
      const d=docSnap.data();
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${d.id}</td>
        <td>${d.name}</td>
        <td>${d.people}</td>
        <td>${d.startTime}〜${d.endTime}</td>
        <td>${d.type||'通常'}</td>
        <td class="${d.used?'used':'unused'}">${d.used?'使用済':'未使用'}</td>
        <td>
          <button class="success btn-use" data-id="${docSnap.id}">${d.used?'未使用に':'使用済に'}</button>
          <button class="danger btn-del" data-id="${docSnap.id}">削除</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    Array.from(document.querySelectorAll('.btn-use')).forEach(btn=>{
      btn.onclick=async ()=>{
        const id=btn.dataset.id;
        const docRef=doc(db,'passes',id);
        const snap=await getDoc(docRef);
        if(snap.exists()){ await updateDoc(docRef,{used:!snap.data().used}); }
      };
    });
    Array.from(document.querySelectorAll('.btn-del')).forEach(btn=>{
      btn.onclick=async ()=>{
        if(confirm('削除してよいですか？')){
          const id=btn.dataset.id;
          await deleteDoc(doc(db,'passes',id));
        }
      };
    });
  });
}

/* ================== NFC全件削除 ================== */
const deleteAllBtn=document.getElementById('deleteAllBtn');
const nfcInlineMsg=document.getElementById('nfcInlineMsg');
deleteAllBtn.onclick=()=>{ nfcInlineMsg.style.display='inline'; initNFC(false,true); };
async function deleteAllPasses(){
  const snap=await getDocs(collection(db,'passes'));
  snap.forEach(async docSnap=>{ await deleteDoc(doc(db,'passes',docSnap.id)); });
  alert('全パスを削除しました');
}

/* ================== NFC共通 ================== */
async function initNFC(isLogin=false,isDelete=false){
  if(!('NDEFReader' in window)){ alert('NFC非対応'); return; }
  try{
    const ndef=new NDEFReader();
    await ndef.scan();
    ndef.onreading=async (e)=>{
      const cardId=Array.from(new Uint8Array(e.message.records[0].data.buffer||e.message.records[0].data)).map(b=>b.toString(16).padStart(2,'0')).join('');
      if(isLogin){ loginSuccess(cardId); document.getElementById('nfcPrompt').style.display='none'; }
      else if(isDelete){ await deleteAllPasses(); nfcInlineMsg.style.display='none'; }
    };
  }catch(err){ alert('NFC読み取りエラー:'+err); }
}

/* ================== アクセスログ ================== */
const logDiv=document.getElementById('accessLogs');
document.getElementById('logAuthBtn').onclick=()=>{
  const pw=document.getElementById('logPass').value;
  if(pw==='0914'){ document.getElementById('logContent').style.display='block'; loadLogs(); document.getElementById('logAuthMsg').textContent=''; }
  else{ document.getElementById('logAuthMsg').textContent='パスワード違反'; }
};
async function loadLogs(){
  const snap=await getDocs(query(collection(db,'logs'),orderBy('time','desc')));
  logDiv.innerHTML='';
  snap.forEach(docSnap=>{
    const d=docSnap.data();
    const time=d.time?.toDate().toLocaleString()||'-';
    logDiv.innerHTML+=`[${time}] ${d.user} - ${d.action} (${d.type})<br>`;
  });
}
document.getElementById('clearLogsBtn').onclick=async()=>{
  if(confirm('ログを全削除しますか？')){
    const snap=await getDocs(collection(db,'logs'));
    snap.forEach(async docSnap=>{ await deleteDoc(doc(db,'logs',docSnap.id)); });
    loadLogs();
  }
}
</script>

</body>
</html>
