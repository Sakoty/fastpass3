<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>IDãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç®¡ç†</title>

<style>
body{
    font-family:sans-serif;
    background:#0f172a;
    color:white;
    padding:20px;
}

input,button{
    padding:8px;
    margin:5px;
}

table{
    width:100%;
    border-collapse:collapse;
    margin-top:20px;
}

td,th{
    border:1px solid #444;
    padding:8px;
    text-align:center;
}

.valid{ background:#064e3b; }
.notyet{ background:#1e3a8a; }
.expired{ background:#7f1d1d; }
</style>
</head>

<body>

<h2>ğŸ” IDç™ºè¡Œ</h2>

<input id="loginId" placeholder="ID">
<input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"><br>

<label>æœ‰åŠ¹é–‹å§‹æ—¥æ™‚</label>
<input type="datetime-local" id="validFrom">

<label>æœ‰åŠ¹çµ‚äº†æ—¥æ™‚</label>
<input type="datetime-local" id="validUntil">

<br>
<button onclick="createUser()">IDä½œæˆ</button>

<hr>

<h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h2>
<button onclick="loadUsers()">æ›´æ–°</button>

<table>
<thead>
<tr>
<th>ID</th>
<th>é–‹å§‹æ—¥æ™‚</th>
<th>çµ‚äº†æ—¥æ™‚</th>
<th>çŠ¶æ…‹</th>
<th>å‰Šé™¤</th>
</tr>
</thead>
<tbody id="userTable"></tbody>
</table>

<script type="module">

import { initializeApp }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
 getFirestore,
 collection,
 addDoc,
 getDocs,
 deleteDoc,
 doc,
 serverTimestamp,
 Timestamp
}
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


const firebaseConfig = {
  apiKey:"AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
  authDomain:"fastpass-system.firebaseapp.com",
  projectId:"fastpass-system"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);


// ======================
// çŠ¶æ…‹åˆ¤å®š
// ======================
function getStatus(from, until){

 const now = new Date();

 if(from && now < from.toDate())
   return "notyet";

 if(until && now > until.toDate())
   return "expired";

 return "valid";
}


// ======================
// IDä½œæˆ
// ======================
window.createUser = async function(){

 const id = loginId.value.trim();
 const pw = password.value;

 if(!id || !pw){
   alert("IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›");
   return;
 }

 const from = validFrom.value
   ? Timestamp.fromDate(new Date(validFrom.value))
   : null;

 const until = validUntil.value
   ? Timestamp.fromDate(new Date(validUntil.value))
   : null;

 if(from && until && from.toDate() > until.toDate()){
   alert("é–‹å§‹æ—¥æ™‚ãŒçµ‚äº†æ—¥æ™‚ã‚ˆã‚Šå¾Œã§ã™");
   return;
 }

 await addDoc(collection(db,"users"),{
   loginId:id,
   password:pw,
   validFrom:from,
   validUntil:until,
   createdAt:serverTimestamp()
 });

 alert("Firestoreã¸ä¿å­˜å®Œäº†");

 loginId.value="";
 password.value="";
 validFrom.value="";
 validUntil.value="";

 loadUsers();
};


// ======================
// å‰Šé™¤
// ======================
window.deleteUser = async function(docId){
 await deleteDoc(doc(db,"users",docId));
 loadUsers();
};


// ======================
// ä¸€è¦§è¡¨ç¤º
// ======================
window.loadUsers = async function(){

 const table=document.getElementById("userTable");
 table.innerHTML="";

 const snap = await getDocs(collection(db,"users"));

 snap.forEach(docSnap=>{

   const u = docSnap.data();

   const status = getStatus(u.validFrom,u.validUntil);

   const tr=document.createElement("tr");
   tr.className = status;

   const from =
     u.validFrom?.toDate()?.toLocaleString() || "-";

   const until =
     u.validUntil?.toDate()?.toLocaleString() || "-";

   let statusText="æœ‰åŠ¹";
   if(status==="notyet") statusText="é–‹å§‹å‰";
   if(status==="expired") statusText="æœŸé™åˆ‡ã‚Œ";

   tr.innerHTML=`
     <td>${u.loginId}</td>
     <td>${from}</td>
     <td>${until}</td>
     <td>${statusText}</td>
     <td>
       <button onclick="deleteUser('${docSnap.id}')">
       å‰Šé™¤
       </button>
     </td>
   `;

   table.appendChild(tr);
 });

};

loadUsers();

</script>

</body>
</html>
