<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>IDãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç®¡ç†</title>

<style>
body{
    font-family:sans-serif;
    background:#0f172a;
    color:white;
    padding:20px;
}

input,button{
    padding:8px;
    margin:5px;
}

table{
    width:100%;
    border-collapse:collapse;
    margin-top:20px;
}

td,th{
    border:1px solid #444;
    padding:8px;
    text-align:center;
}

.valid{ background:#064e3b; }
.expired{ background:#7f1d1d; }
</style>
</head>

<body>

<h2>ğŸ” IDç™ºè¡Œ</h2>

<input id="loginId" placeholder="ID">
<input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"><br>

<label>IDæœ‰åŠ¹æœŸé™</label>
<input type="datetime-local" id="idExpire">

<label>PWæœ‰åŠ¹æœŸé™</label>
<input type="datetime-local" id="pwExpire">

<br>
<button onclick="createUser()">IDä½œæˆ</button>

<hr>

<h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h2>
<button onclick="loadUsers()">æ›´æ–°</button>

<table>
<thead>
<tr>
<th>ID</th>
<th>IDæœŸé™</th>
<th>PWæœŸé™</th>
<th>çŠ¶æ…‹</th>
<th>å‰Šé™¤</th>
</tr>
</thead>
<tbody id="userTable"></tbody>
</table>

<!-- Firebase -->
<script type="module">

import { initializeApp }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
 getFirestore,
 collection,
 addDoc,
 getDocs,
 deleteDoc,
 doc,
 serverTimestamp,
 Timestamp
}
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


// ======================
// ğŸ”¥ è‡ªåˆ†ã®è¨­å®šã«å¤‰æ›´
// ======================
const firebaseConfig = {
  apiKey:"AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
  authDomain:"fastpass-system.firebaseapp.com",
  projectId:"fastpass-system"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);


// ======================
// æœŸé™ãƒã‚§ãƒƒã‚¯
// ======================
function isExpired(date){
 if(!date) return false;
 return date.toDate() < new Date();
}


// ======================
// IDä½œæˆï¼ˆFirestoreä¿å­˜ï¼‰
// ======================
window.createUser = async function(){

 const id = document.getElementById("loginId").value.trim();
 const pw = document.getElementById("password").value;

 if(!id || !pw){
   alert("IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›");
   return;
 }

 await addDoc(collection(db,"users"),{
   loginId:id,
   password:pw,
   idExpire: idExpire.value
      ? Timestamp.fromDate(new Date(idExpire.value))
      : null,
   passwordExpire: pwExpire.value
      ? Timestamp.fromDate(new Date(pwExpire.value))
      : null,
   createdAt: serverTimestamp()
 });

 alert("Firestoreã¸ä¿å­˜å®Œäº†");

 loginId.value="";
 password.value="";

 loadUsers();
};


// ======================
// å‰Šé™¤
// ======================
window.deleteUser = async function(docId){
 await deleteDoc(doc(db,"users",docId));
 loadUsers();
};


// ======================
// ä¸€è¦§è¡¨ç¤º
// ======================
window.loadUsers = async function(){

 const table=document.getElementById("userTable");
 table.innerHTML="";

 const snap = await getDocs(collection(db,"users"));

 snap.forEach(docSnap=>{

   const u = docSnap.data();

   const expired =
     isExpired(u.idExpire) ||
     isExpired(u.passwordExpire);

   const tr=document.createElement("tr");
   tr.className = expired ? "expired":"valid";

   const idExpire =
     u.idExpire?.toDate()?.toLocaleString() || "-";

   const pwExpire =
     u.passwordExpire?.toDate()?.toLocaleString() || "-";

   tr.innerHTML=`
     <td>${u.loginId}</td>
     <td>${idExpire}</td>
     <td>${pwExpire}</td>
     <td>${expired ? "æœŸé™åˆ‡ã‚Œ":"æœ‰åŠ¹"}</td>
     <td>
       <button onclick="deleteUser('${docSnap.id}')">
       å‰Šé™¤
       </button>
     </td>
   `;

   table.appendChild(tr);
 });

};

loadUsers();

</script>

</body>
</html>
