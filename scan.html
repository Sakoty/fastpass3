<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ãƒ—ãƒ©ã‚¤ã‚ªãƒªãƒ†ã‚£ãƒ‘ã‚¹ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆãƒ­ã‚°è¡¨ç¤ºä»˜ãï¼‰</title>
<style>
  body { font-family: sans-serif; text-align: center; padding: 10px; background-color: #f0f8ff; }
  video { width: 100%; max-width: 480px; height: auto; border: 1px solid #ccc; }
  #result { margin-top: 16px; font-size: 1.2em; font-weight: bold; color: green; }
  .error { color: red; }
  #modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 9999; }
  .modal-content { background:white; padding:20px; border-radius:12px; max-width:300px; text-align:center; }
  .modal-content button { margin:10px; padding:10px 20px; font-size:1em; cursor:pointer; }
  #loginDiv { max-width:400px; margin:auto; padding:20px; background:#fff; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
  #loginDiv input { width:100%; padding:10px; margin:8px 0; box-sizing:border-box; }
  #loginDiv button { width:100%; padding:10px; background:#007bff; color:white; border:none; border-radius:5px; font-size:16px; cursor:pointer; }
  #errorMsg { color:red; margin-top:10px; text-align:center; }
  #mainContent { display:none; }
  #logoutBtn { margin-top:10px; padding:8px 16px; background:#e74c3c; color:white; border:none; border-radius:5px; cursor:pointer; }
  #logs { max-width:480px; margin:auto; margin-top:20px; background:#fff; padding:10px; border-radius:8px; text-align:left; font-size:0.9em; color:black; max-height:200px; overflow-y:auto; border:1px solid #ccc; }
</style>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, updateDoc, doc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebaseè¨­å®š
const firebaseConfig = {
  apiKey: "AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
  authDomain: "fastpass-system.firebaseapp.com",
  projectId: "fastpass-system",
  storageBucket: "fastpass-system.appspot.com",
  messagingSenderId: "858745521872",
  appId: "1:858745521872:web:29289b673855097e1200d5"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ç®¡ç†è€…IDãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
const allowedAdmins = [
  { id: "Sakoty", password: "3214" },
  { id: "seseguchi914", password: "0914" },
  { id: "2", password: "1928mickeymouse" },
  { id: "3", password: "1928mickeymouse" },
  { id: "4", password: "1928mickeymouse" }
];

const loginDiv = document.getElementById("loginDiv");
const mainContent = document.getElementById("mainContent");
const errorMsg = document.getElementById("errorMsg");
const loginForm = document.getElementById("loginForm");
const logoutBtn = document.getElementById("logoutBtn");

// ãƒ­ã‚°è¡¨ç¤ºç”¨
const logsDiv = document.createElement("div");
logsDiv.id = "logs";
mainContent?.appendChild(logsDiv);

let currentAdmin = null;
let lastScannedCode = "";
let lastScanTime = 0;

// ---- ãƒ­ã‚°è¡¨ç¤º ----
function showLog(message){
  const p = document.createElement("div");
  p.textContent = message;
  logsDiv.prepend(p);
}

// ---- Firestoreã«ãƒ­ã‚°æ›¸ãè¾¼ã¿ ----
async function logAccess(action, page = "scan"){
  try{
    if(!currentAdmin) currentAdmin="æœªãƒ­ã‚°ã‚¤ãƒ³";
    await addDoc(collection(db,"accessLogs"),{
      adminId: currentAdmin,
      msg: action,
      type: page,
      timestamp: serverTimestamp()
    });
    showLog(`${new Date().toLocaleString()} | ${currentAdmin} | ${page} | ${action}`);
  }catch(e){ 
    console.error("ãƒ­ã‚°è¨˜éŒ²å¤±æ•—:", e); 
    showLog(`ãƒ­ã‚°è¨˜éŒ²å¤±æ•—: ${e.message}`);
  }
}

// ---- ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† ----
window.addEventListener("DOMContentLoaded", ()=>{
  const storedId = localStorage.getItem("adminId");
  const storedPass = localStorage.getItem("adminPass");
  if(storedId && storedPass && allowedAdmins.some(a=>a.id===storedId && a.password===storedPass)){
    currentAdmin = storedId;
    loginDiv.style.display="none";
    mainContent.style.display="block";
    startScan();
    logAccess("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼ˆè‡ªå‹•ï¼‰");
  }
});

loginForm.onsubmit = e => {
  e.preventDefault();
  const inputId = document.getElementById("adminId").value.trim();
  const inputPass = document.getElementById("adminPass").value;
  if(allowedAdmins.some(a=>a.id===inputId && a.password===inputPass)){
    localStorage.setItem("adminId", inputId);
    localStorage.setItem("adminPass", inputPass);
    currentAdmin = inputId;
    loginDiv.style.display="none";
    mainContent.style.display="block";
    errorMsg.textContent="";
    startScan();
    logAccess("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ");
  } else {
    errorMsg.textContent="IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
    currentAdmin = inputId;
    logAccess("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—");
  }
};

logoutBtn.onclick = ()=>{
  logAccess("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ");
  localStorage.removeItem("adminId");
  localStorage.removeItem("adminPass");
  currentAdmin = null;
  loginDiv.style.display="block";
  mainContent.style.display="none";
};

// ---- QRã‚¹ã‚­ãƒ£ãƒ³å‡¦ç† ----
function startScan(){
  const resultEl = document.getElementById("result");
  const modal = document.getElementById("modal");
  const modalText = document.getElementById("modalText");
  const confirmBtn = document.getElementById("confirmBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const sound = document.getElementById("sound");

  let isReading = false;
  let pendingDoc = null;
  let pendingCode = "";

  function showResult(msg, isError=false){
    resultEl.textContent=msg;
    resultEl.className=isError?"error":"";
  }

  const codeReader = new ZXing.BrowserQRCodeReader();
  codeReader.decodeFromVideoDevice(null,"video", async (res,_)=>{
    if(!res||isReading) return;
    const code=res.text;

    // é€£ç¶šã‚¹ã‚­ãƒ£ãƒ³é˜²æ­¢
    const nowTime = Date.now();
    if(code===lastScannedCode && nowTime - lastScanTime < 1000){
      return;
    }
    lastScannedCode = code;
    lastScanTime = nowTime;

    isReading=true;
    try{
      const q=query(collection(db,"passes"), where("id","==",code));
      const snapshot = await getDocs(q);
      if(snapshot.empty){
        showResult("è©²å½“ã™ã‚‹ãƒ‘ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“",true);
        logAccess(`ç„¡åŠ¹ã‚¹ã‚­ãƒ£ãƒ³: ${code}`);
        isReading=false;
      } else {
        const docSnap = snapshot.docs[0];
        const data = docSnap.data();

        const now = new Date();

        // ğŸ”½ ã“ã“ã‚’ä¿®æ­£ï¼š startTime/endTime ãŒ "HH:mm" æ–‡å­—åˆ—ã§ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å‰æ
        function buildDateFromTimeStr(timeStr){
          if(!timeStr) return null;
          const [h,m] = timeStr.split(":").map(Number);
          const d = new Date();
          d.setHours(h, m, 0, 0);
          return d;
        }
        const start = buildDateFromTimeStr(data.startTime);
        const end   = buildDateFromTimeStr(data.endTime);

        if(start && now < start){
          pendingDoc = docSnap; pendingCode=code;
          modalText.textContent=`æ¡ˆå†…æ™‚é–“å‰ã§ã™ã€‚ä½¿ç”¨æ¸ˆã¿ã«ã—ã¾ã™ã‹ï¼Ÿï¼ˆ${code}ï¼‰`;
          modal.style.display="flex";
        } else if(end && now > end){
          showResult(`ãƒ‘ã‚¹ ${code} ã¯æ¡ˆå†…æ™‚é–“ã‚’éãã¦ã„ã¾ã™`,true);
          logAccess(`æ™‚é–“å¤–ã‚¹ã‚­ãƒ£ãƒ³: ${code}`);
          isReading=false;
        } else if(data.used){
          showResult(`ãƒ‘ã‚¹ ${code} ã¯ã™ã§ã«ä½¿ç”¨æ¸ˆã¿ã§ã™`,true);
          logAccess(`å†ã‚¹ã‚­ãƒ£ãƒ³: ${code}`);
          isReading=false;
        } else {
          await updateDoc(doc(db,"passes",docSnap.id),{used:true});
          showResult(`ãƒ‘ã‚¹ ${code} ã‚’ä½¿ç”¨æ¸ˆã¿ã«ã—ã¾ã—ãŸ`);
          logAccess(`ä½¿ç”¨æ¸ˆã¿ã«ã—ãŸ: ${code}`);
          sound.currentTime=0; sound.play().catch(()=>{});
          isReading=false;
        }
      }
    } catch(e){ 
      console.error(e); 
      showResult("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ",true); 
      logAccess(`ã‚¨ãƒ©ãƒ¼: ${code} ${e.message}`); 
      isReading=false; 
    }
  });

  confirmBtn.onclick=async()=>{
    if(pendingDoc){
      await updateDoc(doc(db,"passes",pendingDoc.id),{used:true});
      showResult(`ãƒ‘ã‚¹ ${pendingCode} ã‚’ä½¿ç”¨æ¸ˆã¿ã«ã—ã¾ã—ãŸ`);
      logAccess(`ä½¿ç”¨æ¸ˆã¿ã«ã—ãŸï¼ˆå‰å€’ã—ï¼‰: ${pendingCode}`);
      sound.currentTime=0; sound.play().catch(()=>{});
    }
    modal.style.display="none";
    isReading=false;
  };

  cancelBtn.onclick=()=>{
    showResult("ã‚¹ã‚­ãƒ£ãƒ³ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ",true);
    logAccess("ã‚¹ã‚­ãƒ£ãƒ³ã‚­ãƒ£ãƒ³ã‚»ãƒ«");
    modal.style.display="none";
    isReading=false;
  };
}
</script>
</head>
<body>
  <div id="loginDiv">
    <h1>ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h1>
    <form id="loginForm">
      <input type="text" id="adminId" placeholder="ç®¡ç†è€…ID" required>
      <input type="password" id="adminPass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required>
      <button type="submit">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div id="errorMsg"></div>
    </form>
  </div>

  <div id="mainContent">
    <h1>ãƒ—ãƒ©ã‚¤ã‚ªãƒªãƒ†ã‚£ãƒ‘ã‚¹ã‚¹ã‚­ãƒ£ãƒ³</h1>
    <video id="video" autoplay muted playsinline></video>
    <div id="result">QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„</div>
    <div id="modal" style="display: none;">
      <div class="modal-content">
        <p id="modalText"></p>
        <button id="confirmBtn">ä½¿ç”¨æ¸ˆã¿ã«ã™ã‚‹</button>
        <button id="cancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
    <audio id="sound" src="ãƒ•ã‚¡ã‚¹ãƒˆãƒ‘ã‚¹èª­ã¿å–ã‚Šæ™‚éŸ³æº.mp3" preload="auto"></audio>
    <button id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</body>
</html>
