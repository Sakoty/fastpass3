<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ファストパスQRスキャン</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #e0fff4; }
    video { width: 100%; max-width: 400px; margin: 0 auto; }
    #result { margin-top: 20px; font-size: 1.2em; font-weight: bold; color: green; }
  </style>
</head>
<body>
  <h1>ファストパスQRスキャン</h1>
  <video id="preview"></video>
  <div id="result">QRコードを読み取ってください</div>

  <!-- 音声ファイル -->
  <audio id="sound" src="ファストパス読み取り時音源.mp3" preload="auto"></audio>

  <!-- QRスキャンライブラリ -->
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, query, where, getDocs, updateDoc, doc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
      authDomain: "fastpass-system.firebaseapp.com",
      projectId: "fastpass-system",
      storageBucket: "fastpass-system.appspot.com",
      messagingSenderId: "858745521872",
      appId: "1:858745521872:web:29289b673855097e1200d5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const resultEl = document.getElementById("result");
    const sound = document.getElementById("sound");

    function showResult(message, color = "green") {
      resultEl.textContent = message;
      resultEl.style.color = color;
    }

    // QRコードの読み取りと処理
    const html5QrCode = new Html5Qrcode("preview");
    const qrConfig = { fps: 10, qrbox: 250 };

    Html5Qrcode.getCameras()
      .then(cameras => {
        if (cameras && cameras.length) {
          html5QrCode.start(
            { facingMode: "environment" },
            qrConfig,
            async (decodedText) => {
              if (!decodedText.startsWith("FP")) return;

              try {
                const q = query(collection(db, "passes"), where("id", "==", decodedText));
                const snap = await getDocs(q);
                if (snap.empty) {
                  showResult("該当するファストパスが見つかりません", "red");
                  return;
                }

                const passDoc = snap.docs[0];
                const passData = passDoc.data();

                if (passData.used) {
                  showResult(`ファストパス ${decodedText} はすでに使用済みです`, "red");
                  return;
                }

                const ref = doc(db, "passes", passDoc.id);
                await updateDoc(ref, { used: true });

                showResult(`ファストパス ${decodedText} を使用済みにしました`, "green");
                sound.currentTime = 0;
                sound.play();

              } catch (error) {
                console.error(error);
                showResult("エラーが発生しました", "red");
              }
            },
            (errMsg) => {
              // 読み取りエラーは無視してOK
            }
          );
        } else {
          showResult("カメラが見つかりません", "red");
        }
      })
      .catch(err => {
        console.error("カメラ初期化失敗:", err);
        showResult("カメラが使用できません。設定をご確認ください。", "red");
      });
  </script>
</body>
</html>
