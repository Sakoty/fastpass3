<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    query,
    where,
    getDocs,
    updateDoc,
    doc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
    authDomain: "fastpass-system.firebaseapp.com",
    projectId: "fastpass-system",
    storageBucket: "fastpass-system.firebasestorage.app",
    messagingSenderId: "858745521872",
    appId: "1:858745521872:web:29289b673855097e1200d5",
    measurementId: "G-SLPKMCNY53"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const result = document.getElementById("result");
  const input = document.getElementById("ticketIdInput");
  const submitBtn = document.getElementById("submitBtn");

  // URLパラメータからidを取得する関数
  function getIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get("id");
  }

  async function markUsed(ticketId) {
    if (!ticketId) {
      result.textContent = "整理券IDが指定されていません。";
      return;
    }
    result.textContent = "処理中...";

    try {
      const q = query(collection(db, "tickets"), where("id", "==", ticketId));
      const snapshot = await getDocs(q);

      if (snapshot.empty) {
        result.textContent = "該当する整理券が見つかりません。";
        return;
      }

      const docRef = snapshot.docs[0].ref;
      await updateDoc(docRef, {
        status: "used",
        isCalling: false
      });

      result.textContent = `整理券「${ticketId}」を使用済みにしました。`;
    } catch (err) {
      console.error(err);
      result.textContent = "エラーが発生しました。";
    }
  }

  submitBtn.onclick = () => {
    const ticketId = input.value.trim();
    markUsed(ticketId);
  };

  // ページ読み込み時にURLにidパラメータがあれば自動実行
  window.addEventListener("DOMContentLoaded", () => {
    const id = getIdFromUrl();
    if (id) {
      input.value = id;
      markUsed(id);
    }
  });
</script>
