<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>プライオリティパススキャン（改良版）</title>
<style>
  body { font-family: sans-serif; text-align: center; padding: 10px; background-color: #f0f8ff; }
  video { width: 100%; max-width: 480px; height: auto; border: 1px solid #ccc; margin-bottom:10px;}
  #result { margin-top: 16px; font-size: 1.2em; font-weight: bold; color: green; }
  .error { color: red; }
  #modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 9999; }
  .modal-content { background:white; padding:20px; border-radius:12px; max-width:300px; text-align:center; }
  .modal-content button { margin:10px; padding:10px 20px; font-size:1em; cursor:pointer; }
  #loginDiv { max-width:400px; margin:auto; padding:20px; background:#fff; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
  #loginDiv input { width:100%; padding:10px; margin:8px 0; box-sizing:border-box; }
  #loginDiv button { width:100%; padding:10px; background:#007bff; color:white; border:none; border-radius:5px; font-size:16px; cursor:pointer; }
  #errorMsg { color:red; margin-top:10px; text-align:center; }
  #mainContent { display:none; }
  #logoutBtn { margin-top:10px; padding:8px 16px; background:#e74c3c; color:white; border:none; border-radius:5px; cursor:pointer; }
  #logs { max-width:480px; margin:auto; margin-top:20px; background:#fff; padding:10px; border-radius:8px; text-align:left; font-size:0.9em; color:black; max-height:200px; overflow-y:auto; border:1px solid #ccc; }
</style>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, updateDoc, doc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebase設定
const firebaseConfig = {
  apiKey: "AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
  authDomain: "fastpass-system.firebaseapp.com",
  projectId: "fastpass-system",
  storageBucket: "fastpass-system.appspot.com",
  messagingSenderId: "858745521872",
  appId: "1:858745521872:web:29289b673855097e1200d5"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// 管理者ID・パスワード
const allowedAdmins = [
  { id: "Sakoty", password: "3214" },
  { id: "seseguchi914", password: "0914" },
  { id: "2", password: "1928mickeymouse" },
  { id: "3", password: "1928mickeymouse" },
  { id: "4", password: "1928mickeymouse" }
];

const loginDiv = document.getElementById("loginDiv");
const mainContent = document.getElementById("mainContent");
const errorMsg = document.getElementById("errorMsg");
const loginForm = document.getElementById("loginForm");
const logoutBtn = document.getElementById("logoutBtn");
const logsDiv = document.getElementById("logs");

let currentAdmin = null; 
let lastScannedCode = null; // 直前にスキャンしたパスID

function showLog(message){
  const p = document.createElement("div");
  p.textContent = message;
  logsDiv.prepend(p);
}

async function logAccess(action, page = "scan"){
  try{
    if(!currentAdmin) currentAdmin="未ログイン";
    await addDoc(collection(db,"accessLogs"),{
      adminId: currentAdmin,
      msg: action,
      type: page,
      timestamp: serverTimestamp()
    });
    showLog(`${new Date().toLocaleString()} | ${currentAdmin} | ${page} | ${action}`);
  }catch(e){ 
    console.error("ログ記録失敗:", e); 
    showLog(`ログ記録失敗: ${e.message}`);
  }
}

async function logScan(passId, action){
  try{
    if(!currentAdmin) currentAdmin="未ログイン";
    await addDoc(collection(db,"scanLogs"),{
      adminId: currentAdmin,
      passId,
      action,
      scannedAt: serverTimestamp()
    });
    showLog(`${new Date().toLocaleString()} | ${currentAdmin} | ${passId} | ${action}`);
  }catch(e){
    console.error("スキャンログ保存失敗:",e);
    showLog(`スキャンログ保存失敗: ${e.message}`);
  }
}

// ---- ログイン処理 ----
window.addEventListener("DOMContentLoaded", ()=>{
  const storedId = localStorage.getItem("adminId");
  const storedPass = localStorage.getItem("adminPass");
  if(storedId && storedPass && allowedAdmins.some(a=>a.id===storedId && a.password===storedPass)){
    currentAdmin = storedId;
    loginDiv.style.display="none";
    mainContent.style.display="block";
    startScan();
    logAccess("ログイン成功（自動）");
  }
});

loginForm.onsubmit = e => {
  e.preventDefault();
  const inputId = document.getElementById("adminId").value.trim();
  const inputPass = document.getElementById("adminPass").value;
  if(allowedAdmins.some(a=>a.id===inputId && a.password===inputPass)){
    localStorage.setItem("adminId", inputId);
    localStorage.setItem("adminPass", inputPass);
    currentAdmin = inputId;
    loginDiv.style.display="none";
    mainContent.style.display="block";
    errorMsg.textContent="";
    startScan();
    logAccess("ログイン成功");
  } else {
    errorMsg.textContent="IDまたはパスワードが違います";
    currentAdmin = inputId;
    logAccess("ログイン失敗");
  }
};

logoutBtn.onclick = ()=>{
  logAccess("ログアウト");
  localStorage.removeItem("adminId");
  localStorage.removeItem("adminPass");
  currentAdmin = null;
  loginDiv.style.display="block";
  mainContent.style.display="none";
};

// ---- QRスキャン処理 ----
function startScan(){
  const resultEl = document.getElementById("result");
  const modal = document.getElementById("modal");
  const modalText = document.getElementById("modalText");
  const confirmBtn = document.getElementById("confirmBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const sound = document.getElementById("sound");

  let isReading = false;
  let pendingDoc = null;
  let pendingCode = "";

  function showResult(msg, isError=false){
    resultEl.textContent=msg;
    resultEl.className=isError?"error":"";
  }

  const codeReader = new ZXing.BrowserQRCodeReader();
  codeReader.decodeFromVideoDevice(null,"video", async (res,_)=>{
    if(!res||isReading) return;
    const code=res.text.trim();
    if(code === lastScannedCode) return; // 同じパス連続スキップ
    lastScannedCode = code;
    isReading=true;

    try{
      const q=query(collection(db,"passes"), where("id","==",code));
      const snapshot = await getDocs(q);
      if(snapshot.empty){
        showResult("該当するパスが見つかりません",true);
        await logScan(code,"無効スキャン");
        isReading=false;
      } else {
        const docSnap = snapshot.docs[0];
        const data = docSnap.data();
        const now = new Date();
        const start = data.startTime ? new Date(`${now.toDateString()}T${data.startTime}:00`) : now;
        const end = data.endTime ? new Date(`${now.toDateString()}T${data.endTime}:00`) : now;

        if(now < start){
          pendingDoc = docSnap; pendingCode=code;
          modalText.textContent=`案内時間前ですが使用済みにしますか？（${code}）`;
          modal.style.display="flex";
          await logScan(code,"前倒し確認表示");
        } else if(now > end){
          showResult(`パス ${code} は案内時間を過ぎています`,true);
          await logScan(code,"時間外スキャン");
          isReading=false;
        } else if(data.used){
          showResult(`パス ${code} はすでに使用済みです`,true);
          await logScan(code,"再スキャン");
          isReading=false;
        } else {
          await updateDoc(doc(db,"passes",docSnap.id),{used:true});
          showResult(`パス ${code} を使用済みにしました`);
          await logScan(code,"使用済みにした");
          sound.currentTime=0; sound.play().catch(()=>{});
          isReading=false;
        }
      }
    } catch(e){ 
      console.error(e); 
      showResult("エラーが発生しました",true); 
      await logScan(code,`エラー: ${e.message}`);
      isReading=false; 
    }
  });

  confirmBtn.onclick=async()=>{
    if(pendingDoc){
      await updateDoc(doc(db,"passes",pendingDoc.id),{used:true});
      showResult(`パス ${pendingCode} を使用済みにしました`);
      await logScan(pendingCode,"使用済みにした（前倒し確認）");
      sound.currentTime=0; sound.play().catch(()=>{});
    }
    modal.style.display="none";
    pendingDoc = null;
    pendingCode = "";
    isReading=false;
  };

  cancelBtn.onclick=async()=>{
    showResult("スキャンをキャンセルしました",true);
    await logScan(pendingCode,"前倒しスキャンキャンセル");
    modal.style.display="none";
    pendingDoc = null;
    pendingCode = "";
    isReading=false;
  };
}
</script>
</head>
<body>
  <div id="loginDiv">
    <h1>管理者ログイン</h1>
    <form id="loginForm">
      <input type="text" id="adminId" placeholder="管理者ID" required>
      <input type="password" id="adminPass" placeholder="パスワード" required>
      <button type="submit">ログイン</button>
      <div id="errorMsg"></div>
    </form>
  </div>

  <div id="mainContent">
    <h1>プライオリティパススキャン</h1>
    <video id="video" autoplay muted playsinline></video>
    <div id="result">QRコードを読み取ってください</div>
    <div id="modal" style="display: none;">
      <div class="modal-content">
        <p id="modalText"></p>
        <button id="confirmBtn">使用済みにする</button>
        <button id="cancelBtn">キャンセル</button>
      </div>
    </div>
    <audio id="sound" src="ファストパス読み取り時音源.mp3" preload="auto"></audio>
    <button id="logoutBtn">ログアウト</button>
    <div id="logs"></div>
  </div>
</body>
</html>
