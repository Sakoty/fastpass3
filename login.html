<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>コントロールログイン</title>
</head>

<body>

<h2>Control Login</h2>

<input id="loginId" placeholder="ID"><br>
<input id="password" type="password" placeholder="パスワード"><br>

<button id="loginBtn">ログイン</button>

<p id="msg"></p>

<script type="module">

import { initializeApp }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
 getFirestore,
 collection,
 query,
 where,
 getDocs
}
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


// ======================
// Firebase設定
// ======================
const firebaseConfig = {
  apiKey:"AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
  authDomain:"fastpass-system.firebaseapp.com",
  projectId:"fastpass-system"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);


// ======================
// 要素取得（安全版）
// ======================
const idInput = document.getElementById("loginId");
const pwInput = document.getElementById("password");
const msg = document.getElementById("msg");
const loginBtn = document.getElementById("loginBtn");


// ======================
// 期限チェック（Firestore対応版）
// ======================
function expiredCheck(timestamp){

 if(!timestamp) return false;

 // Timestamp型のみ処理
 if(typeof timestamp.toDate === "function"){
   return timestamp.toDate() < new Date();
 }

 return false;
}


// ======================
// ログイン処理
// ======================
loginBtn.onclick = async () => {

 msg.textContent = "確認中...";

 const id = idInput.value.trim();
 const pw = pwInput.value;

 if(!id || !pw){
   msg.textContent = "IDとパスワードを入力してください";
   return;
 }

 try{

   const q = query(
     collection(db,"users"),
     where("loginId","==",id)
   );

   const snap = await getDocs(q);

   if(snap.empty){
     msg.textContent="IDが存在しません";
     return;
   }

   const userDoc = snap.docs[0];
   const user = userDoc.data();

   // ===== パスワード確認 =====
   if(user.password !== pw){
     msg.textContent="パスワードが違います";
     return;
   }

   // ===== 有効期限確認 =====
   if(expiredCheck(user.idExpire)){
     msg.textContent="ID期限切れ";
     return;
   }

   if(expiredCheck(user.passwordExpire)){
     msg.textContent="パスワード期限切れ";
     return;
   }

   // ===== ログイン成功 =====
   sessionStorage.setItem("controlLogin", id);
   sessionStorage.setItem("controlDocId", userDoc.id);

   location.href="control.html";

 }catch(e){
   console.error(e);
   msg.textContent="通信エラー";
 }

};

</script>

</body>
</html>
