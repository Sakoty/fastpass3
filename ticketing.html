<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ãƒ—ãƒ©ã‚¤ã‚ªãƒªãƒ†ã‚£ãƒ‘ã‚¹ç™ºåˆ¸</title>
<style>
/* ï¼ˆCSSã¯ãã®ã¾ã¾æ®‹ã™ï¼‰ */
body { font-family: "Segoe UI", sans-serif; background:#f0f4f8; margin:0; padding:20px; }
h1 { text-align:center; color:#004080; margin-bottom:20px; }
form {
  max-width:340px; margin:0 auto 20px auto; padding:20px;
  background:#fff; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.15);
}
input, select, button {
  width:100%; font-size:16px; padding:10px; margin:8px 0;
  border-radius:6px; border:1px solid #ccc; box-sizing:border-box;
}
button {
  background:#0066cc; color:#fff; border:none; cursor:pointer; font-weight:bold;
}
button:hover { background:#0052a3; }
#info { text-align:center; margin:20px auto; font-size:18px; }

.ticket-card {
  max-width:360px; margin:20px auto; padding:20px;
  background:#fff; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.2);
  text-align:center;
}
.ticket-card h2 { margin:0 0 10px; font-size:22px; color:#004080; }
.ticket-card p { margin:6px 0; font-size:16px; }
.ticket-card .status { font-size:18px; font-weight:bold; margin-bottom:12px; }
.ticket-card.used { border:2px solid #999; }
.ticket-card.expired { border:2px solid #cc0000; }
.ticket-card.active { border:2px solid #009933; }

#qrcode { margin:20px auto; }
.ended,.notset { color:red; font-weight:bold; }

/* ğŸ”„ ãƒªãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ï¼ˆä¸­å¤®ä¸‹ã«å›ºå®šï¼‰ */
#reloadBtn {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #0066cc;
  color: #fff;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
#reloadBtn:hover {
  background: #0052a3;
}

/* ğŸ”½ åŒæ„ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal {
  display:none;
  position:fixed;
  z-index:1000;
  left:0; top:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.5);
  overflow:auto;
}
.modal-content {
  background:#fff;
  margin:10% auto;
  padding:20px;
  border-radius:10px;
  max-width:400px;
  max-height:80vh;   /* âœ… é«˜ã•åˆ¶é™ */
  overflow-y:auto;   /* âœ… ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ */
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
}
.modal-buttons {
  margin-top:20px;
  display:flex;
  flex-direction:column; /* âœ… ç¸¦é…ç½® */
  gap:14px;
}
.modal-buttons button {
  width:100%;
  padding:16px;
  font-size:17px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
#agreeBtn { background:#0066cc; color:#fff; font-weight:bold; }
#cancelBtn.cancel { background:#eee; color:#333; }

/* ğŸ”½ ç™ºåˆ¸ä¸å¯ãƒ¢ãƒ¼ãƒ€ãƒ« */
#notifyModal {
  display:none;
  position:fixed;
  z-index:1100;
  left:0; top:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.5);
}
#notifyModal .modal-content {
  background:#fff;
  margin:20% auto;
  padding:20px;
  border-radius:10px;
  max-width:350px;
  text-align:center;
}
#notifyCloseBtn {
  margin-top:20px;
  padding:12px;
  font-size:16px;
  border:none;
  border-radius:8px;
  background:#0066cc;
  color:#fff;
  cursor:pointer;
}
#notifyCloseBtn:hover { background:#0052a3; }

</style>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebaseè¨­å®š
const firebaseConfig = {
  apiKey:"AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
  authDomain:"fastpass-system.firebaseapp.com",
  projectId:"fastpass-system",
  storageBucket:"fastpass-system.appspot.com",
  messagingSenderId:"858745521872",
  appId:"1:858745521872:web:29289b673855097e1200d5"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- localStorage --- 
function getTodayString() {
  const now = new Date();
  return `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,"0")}-${now.getDate().toString().padStart(2,"0")}`;
}
function savePassToLocal(pass) { localStorage.setItem("fp_pass", JSON.stringify({...pass,date:getTodayString()})); }
function loadPassFromLocal() {
  const saved = localStorage.getItem("fp_pass");
  if(!saved) return null;
  const data = JSON.parse(saved);
  return data.date===getTodayString()?data:null;
}

// --- æ™‚é–“ãƒ–ãƒ­ãƒƒã‚¯ç”Ÿæˆ ---
function generateTimeBlocks(start,end,interval=10){
  const blocks=[];
  const [sh,sm] = start.split(":").map(Number);
  const [eh,em] = end.split(":").map(Number);
  let s = new Date(); s.setHours(sh,sm,0,0);
  const e = new Date(); e.setHours(eh,em,0,0);
  while(s<e){
    const next=new Date(s.getTime()+interval*60000);
    if(next>e) break;
    const pad=n=>n.toString().padStart(2,"0");
    blocks.push(`${pad(s.getHours())}:${pad(s.getMinutes())}ã€œ${pad(next.getHours())}:${pad(next.getMinutes())}`);
    s.setMinutes(s.getMinutes()+interval);
  }
  return blocks;
}

// --- QRã‚³ãƒ¼ãƒ‰ ---
function drawQRCode(id){
  const qrContainer=document.getElementById("qrcode");
  qrContainer.innerHTML="";
  QRCode.toCanvas(document.createElement("canvas"),id,{width:200},(err,canvas)=>{ if(!err) qrContainer.appendChild(canvas); });
}

// --- UIæ›´æ–° ---
async function updateUI(latestPasses,slots,limits,issueActive){
  const info=document.getElementById("info");
  const form=document.getElementById("form");
  const saved=loadPassFromLocal();
  const now=new Date();

  if(!issueActive && !saved){
    form.style.display="none";
    info.innerHTML='<p class="ended">ç¾åœ¨ãƒ—ãƒ©ã‚¤ã‚ªãƒªãƒ†ã‚£ãƒ‘ã‚¹ã®ç™ºåˆ¸ã¯ä¸€æ™‚ä¸­æ­¢ä¸­ã§ã™</p>';
    return;
  }

  if(!slots || slots.length===0){
    info.innerHTML='<p class="notset">æ¡ˆå†…æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
    form.style.display="none";
    return;
  }

  if(saved){
    const passInDb=latestPasses.find(p=>p.id===saved.id);
    const used=passInDb?.used||false;
    saved.used=used;

    const [sh,sm]=saved.time.split("ã€œ")[0].split(":").map(Number);
    const [eh,em]=saved.time.split("ã€œ")[1].split(":").map(Number);
    const startDate=new Date(); startDate.setHours(sh,sm,0,0);
    const endDate=new Date(); endDate.setHours(eh,em,0,0);

    let statusText="ç¾åœ¨æ¡ˆå†…ä¸­", cls="active", newStatus="ä½¿ç”¨å¯èƒ½";
    if(used){ statusText="ä½¿ç”¨æ¸ˆã¿"; cls="used"; newStatus="ä½¿ç”¨æ¸ˆã¿"; }
    else if(now>endDate){ statusText="ç„¡åŠ¹ï¼ˆæ™‚é–“åˆ‡ã‚Œï¼‰"; cls="expired"; newStatus="æœŸé™åˆ‡ã‚Œ"; }
    else if(now<startDate){ statusText="æ¡ˆå†…æ™‚åˆ»å‰ã§ã™"; cls="active"; newStatus="æœªä½¿ç”¨"; }

    if(passInDb && passInDb.status!==newStatus){
      const passDocRef = doc(db,"passes",passInDb._docId || passInDb.id);
      try { await updateDoc(passDocRef,{status:newStatus}); } catch(e){ console.warn("statusæ›´æ–°å¤±æ•—",e); }
    }

    info.innerHTML=`<div class="ticket-card ${cls}">
      <div class="status">${statusText}</div>
      <h2>ç•ªå·ï¼š${saved.id}</h2>
      <p>åå‰ï¼š${saved.name}</p>
      <p>äººæ•°ï¼š${saved.people}</p>
      <p>æ¡ˆå†…æ™‚é–“ï¼š${saved.time}</p>
      <div id="qrcode"></div>
    </div>`;
    drawQRCode(saved.id);
    form.style.display="none";
    return;
  }

  let allFull=true;
  const select=document.getElementById("timeSelect");
  select.innerHTML="";
  slots.forEach((slot,i)=>{
    const [sh,sm]=slot.split("ã€œ")[0].split(":").map(Number);
    const slotStart=new Date(); slotStart.setHours(sh,sm,0,0);
    if(slotStart<now) return;

    const count=latestPasses.filter(p=>p.time===slot).length;
    const left=limits[i]-count;
    const opt=document.createElement("option");
    opt.value=slot;
    opt.textContent=`${slot}ï¼ˆæ®‹ã‚Š${left}æ ï¼‰`;
    if(left<=0){ opt.disabled=true; opt.textContent+="ã€æº€å“¡ã€‘"; } else { allFull=false; }
    select.appendChild(opt);
  });

  if(allFull){
    form.style.display="none";
    info.innerHTML='<p class="ended">æœ¬æ—¥ã®ãƒ—ãƒ©ã‚¤ã‚ªãƒªãƒ†ã‚£ãƒ‘ã‚¹ã¯å…¨ã¦ç™ºåˆ¸çµ‚äº†ã—ã¾ã—ãŸ</p>';
  } else {
    form.style.display="block";
    info.innerHTML="";
  }
}

// --- åˆæœŸå‡¦ç† ---
window.addEventListener("load", ()=>{
  const passesCol=collection(db,"passes");
  const timeSlotsDoc=doc(db,"settings","timeSlots");
  const issueStatusDoc=doc(db,"settings","issueStatus");

  let latestPasses=[]; let slots=[]; let limits=[]; let issueActive=true;
  let isSubmitting=false; let pendingSubmit=null;

  onSnapshot(issueStatusDoc,snap=>{
    const data=snap.data();
    issueActive=data?.enabled ?? true;
    updateUI(latestPasses,slots,limits,issueActive);
  });

  onSnapshot(timeSlotsDoc,snap=>{
    const data=snap.data();
    if(data?.slots){
      slots=[]; limits=[];
      data.slots.forEach(f=>{
        const gen=generateTimeBlocks(f.start,f.end,f.interval||10);
        slots.push(...gen);
        for(let i=0;i<gen.length;i++) limits.push(f.limit||1);
      });
    }
    updateUI(latestPasses,slots,limits,issueActive);
  });

  onSnapshot(passesCol,snap=>{
    latestPasses=snap.docs.map(d=>({...d.data(),_docId:d.id}));
    updateUI(latestPasses,slots,limits,issueActive);
  });

 // --- ç™ºåˆ¸å‡¦ç† ---
document.getElementById("form").addEventListener("submit",(e)=>{
  e.preventDefault();
  if(isSubmitting) return;

  const name=document.getElementById("name").value.trim();
  const num=parseInt(document.getElementById("people").value);
  const time=document.getElementById("timeSelect").value;
  if(!name||isNaN(num)||num<1||!time){
    alert("æ­£ã—ã„æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  pendingSubmit={name,people:num,time};

  document.getElementById("consentModal").style.display="block";
});

document.getElementById("agreeBtn").addEventListener("click", async()=>{
  if(!document.getElementById("consentCheck").checked){
    alert("åŒæ„ã«ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„");
    return;
  }
  if(!pendingSubmit) return;
  isSubmitting=true;

  try {
    // ğŸ”¹ Firestoreãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§ç•ªå·é‡è¤‡é˜²æ­¢
    const counterDoc = doc(db, "counters", "fpNumber");
    const passesCol = collection(db, "passes");

    await db.runTransaction(async (t)=>{
      const counterSnap = await t.get(counterDoc);
      const lastNum = counterSnap.exists() ? counterSnap.data().lastNum : 0;
      const newNum = lastNum + 1;
      const id = `FP${newNum.toString().padStart(3,"0")}`;

      // æ ãƒã‚§ãƒƒã‚¯ï¼ˆæŠ½é¸ï¼‰
      const q = await passesCol.where("time","==",pendingSubmit.time).get();
      const slotPasses = q.docs.map(d=>d.data());
      const slotIndex = slots.indexOf(pendingSubmit.time);
      const limit = limits[slotIndex] || 1;

      let isWinner = true;
      if(slotPasses.length >= limit){
        // æŠ½é¸
        const candidates = [...slotPasses, {...pendingSubmit, id}];
        const shuffled = candidates.sort(()=>Math.random()-0.5);
        const winners = shuffled.slice(0, limit);
        isWinner = winners.some(p => p.id===id);
      }

      if(isWinner){
        const newPass = {
          ...pendingSubmit,
          id,
          number:newNum,
          used:false,
          status:"æœªä½¿ç”¨",
          createdAt:serverTimestamp()
        };
        const docRef = doc(passesCol);
        t.set(docRef, newPass);
        t.set(counterDoc, { lastNum: newNum }, { merge:true });

        savePassToLocal(newPass);
      } else {
        // å¤–ã‚Œã®å ´åˆã¯ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        document.getElementById("notifyModal").style.display="block";
      }
    });

    document.getElementById("consentModal").style.display="none";
    pendingSubmit=null;
  } catch(err){
    alert("ç™ºåˆ¸å¤±æ•—:" + err.message);
    console.error(err);
  }

  isSubmitting=false;
});


  // ğŸ”„ ãƒªãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
  document.getElementById("reloadBtn").addEventListener("click", ()=>{ location.reload(); });
});
</script>
</head>
<body>
<h1>ãƒ—ãƒ©ã‚¤ã‚ªãƒªãƒ†ã‚£ãƒ‘ã‚¹ç™ºåˆ¸</h1>
<form id="form">
  <input type="text" id="name" placeholder="åå‰" required>
  <input type="number" id="people" placeholder="äººæ•°" required min="1">
  <select id="timeSelect" required></select>
  <button type="submit">ğŸŸï¸ ç™ºåˆ¸ã™ã‚‹</button>
</form>
<div id="info"></div>
<div id="qrcode"></div>

<!-- ğŸ”„ ãƒªãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ -->
<button id="reloadBtn">ğŸ”„ æ›´æ–°</button>

<!-- ğŸ”½ åŒæ„ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="consentModal" class="modal">
  <div class="modal-content">
    <h2>åˆ©ç”¨ã«é–¢ã™ã‚‹åŒæ„äº‹é …</h2>
    <p>
      ãƒ»ãƒ—ãƒ©ã‚¤ã‚ªãƒªãƒ†ã‚£ãƒ‘ã‚¹ã¯æŒ‡å®šã®æ™‚é–“ã®ã¿æœ‰åŠ¹ã§ã™ã€‚<br>
      ãƒ»æ¡ˆå†…æ™‚é–“å‰ã‚„æœ‰åŠ¹æœŸé™åˆ‡ã‚Œã®å ´åˆã¯ã”åˆ©ç”¨ã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br>
      ãƒ»ä¸€åº¦ä½¿ç”¨æ¸ˆã¿ã«ãªã£ãŸãƒ‘ã‚¹ã¯å†åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚<br>
      ãƒ»ä½“èª¿ã®ã™ãã‚Œãªã„æ–¹ã‚„ã€æš—é—‡ãŒè‹¦æ‰‹ãªæ–¹ã€éª¨æŠ˜ç­‰ã®ã‘ãŒã‚’ã—ã¦ã„ã‚‹æ–¹ã€å¿ƒè‡“ã«ç–¾æ‚£ã®ã‚ã‚‹æ–¹ã®ã”åˆ©ç”¨ã¯ãŠæ§ãˆãã ã•ã„ã€‚<br>
      ãƒ»å°å­¦ç”Ÿä»¥ä¸‹ã®æ–¹ã¯ã€å¿…ãšä¿è­·è€…ã®æ–¹ã®ç¢ºèªãŒå¿…é ˆã§ã™ã€‚<br>
      ãƒ»ä½“é‡ãƒ»ä½“æ ¼ç­‰ã§å®‰å…¨ãªé‹è¡ŒãŒä¸å¯èƒ½ã ã¨ä¿‚å“¡ãŒåˆ¤æ–­ã—ãŸå ´åˆã€ã”åˆ©ç”¨ã‚’ãŠæ–­ã‚Šã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
    </p>
    <label style="display:block; margin-top:10px;">
      <input type="checkbox" id="consentCheck"> ä¸Šè¨˜å†…å®¹ã«åŒæ„ã—ã¾ã™
    </label>
    <div class="modal-buttons">
      <button id="agreeBtn">åŒæ„ã—ã¦ç™ºåˆ¸</button>
      <button id="cancelBtn" class="cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<!-- ğŸ”½ ç™ºåˆ¸ä¸å¯ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="notifyModal" class="modal">
  <div class="modal-content">
    <p>æ®‹å¿µãªãŒã‚‰ã€ä»Šå›ã®æ™‚é–“å¸¯ã¯ç™ºåˆ¸æ ãŒã„ã£ã±ã„ã§ã™ã€‚</p>
    <button id="notifyCloseBtn">é–‰ã˜ã‚‹</button>
  </div>
</div>
</body>
</html>
