<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>プライオリティパス発券</title>
<style>
body { font-family:sans-serif; text-align:center; padding:20px; background:#e6f2ff; }
h1 { color:#004080; margin-bottom:20px; }
form { margin-bottom:20px; display:inline-block; padding:20px; background:#fff; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.2);}
input { font-size:16px; padding:8px; margin:8px; width:200px; border-radius:6px; border:1px solid #ccc; }
button { font-size:16px; padding:10px 20px; border:none; border-radius:6px; background:#0066cc; color:#fff; cursor:pointer; }
button:hover { background:#0052a3; }
#info { margin:20px auto; font-size:18px; }
#qrcode { margin:20px auto; }
.ended,.used,.expired,.stopped,.notset { color:red; font-weight:bold; font-size:18px; }
.status { font-weight:bold; margin-bottom:10px; font-size:20px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, doc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebase設定
const firebaseConfig = {
  apiKey:"AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
  authDomain:"fastpass-system.firebaseapp.com",
  projectId:"fastpass-system",
  storageBucket:"fastpass-system.appspot.com",
  messagingSenderId:"858745521872",
  appId:"1:858745521872:web:29289b673855097e1200d5"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

function getTodayString() {
  const now = new Date();
  return `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,"0")}-${now.getDate().toString().padStart(2,"0")}`;
}

function savePassToLocal(pass) {
  localStorage.setItem("fp_pass", JSON.stringify({...pass,date:getTodayString()}));
}
function loadPassFromLocal() {
  const saved = localStorage.getItem("fp_pass");
  if(!saved) return null;
  const data = JSON.parse(saved);
  return data.date===getTodayString()?data:null;
}

function generateTimeBlocks(start,end,interval=10){
  const blocks=[];
  const [sh,sm] = start.split(":").map(Number);
  const [eh,em] = end.split(":").map(Number);
  let s = new Date(); s.setHours(sh,sm,0,0);
  const e = new Date(); e.setHours(eh,em,0,0);
  while(s<e){
    const next=new Date(s.getTime()+interval*60000);
    if(next>e) break;
    const pad=n=>n.toString().padStart(2,"0");
    blocks.push(`${pad(s.getHours())}:${pad(s.getMinutes())}〜${pad(next.getHours())}:${pad(next.getMinutes())}`);
    s.setMinutes(s.getMinutes()+interval);
  }
  return blocks;
}

function getNextAvailableSlot(slots,limits,passes){
  const now = new Date();
  const nowMinutes = now.getHours()*60 + now.getMinutes();
  const counts = slots.map(slot => passes.filter(p => p.time===slot).length);
  const available=[];
  for(let i=0;i<slots.length;i++){
    if(counts[i]<limits[i]){
      const [h,m] = slots[i].split("〜")[0].split(":").map(Number);
      if(h*60+m>=nowMinutes) available.push({slot:slots[i], minutes:h*60+m});
    }
  }
  available.sort((a,b)=>a.minutes-b.minutes);
  return available.length>0?available[0].slot:null;
}

function drawQRCode(id){
  const qrContainer=document.getElementById("qrcode");
  qrContainer.innerHTML="";
  QRCode.toCanvas(document.createElement("canvas"),id,{width:200},(err,canvas)=>{
    if(!err) qrContainer.appendChild(canvas);
  });
}

function updateUI(latestPasses, slots, limits){
  const info=document.getElementById("info");
  const form=document.getElementById("form");
  if(!slots || slots.length===0 || !limits || limits.length===0){
    info.innerHTML='<p class="notset">案内時間が設定されていません</p>'; 
    form.style.display="none";
    return;
  }

  let saved = loadPassFromLocal();
  if(saved){
    const passInDb = latestPasses.find(p=>p.id===saved.id);
    if(passInDb) saved.time = passInDb.time;

    const used = passInDb?.used||false;
    saved.used = used;

    form.style.display='none'; // 発券済みならフォーム非表示

    const [sh,sm] = saved.time.split("〜")[0].split(":").map(Number);
    const [eh,em] = saved.time.split("〜")[1].split(":").map(Number);
    const startDate = new Date(); startDate.setHours(sh,sm,0,0);
    const endDate = new Date(); endDate.setHours(eh,em,0,0);
    const now = new Date();

    info.innerHTML=`<div class="status ${used?'used':now>endDate?'expired':''}">
      ${used?'使用済み':now>endDate?'無効（時間切れ）':now<startDate?'案内時刻前です':'現在案内中'}
    </div>
    <p>番号：${saved.id}</p>
    <p>名前：${saved.name}</p>
    <p>人数：${saved.people}</p>
    <p>案内時間：${saved.time}</p>`;
    drawQRCode(saved.id);
    return;
  }

  // 未発券ならフォーム表示
  form.style.display='block';
  const nextTime = getNextAvailableSlot(slots,limits,latestPasses);
  if(!nextTime){
    info.innerHTML='<p class="ended">本日のプライオリティパスは全て発券終了しました</p>';
  } else {
    info.innerHTML=`<p>次の案内時刻：<strong>${nextTime}</strong></p>`;
  }
}

window.addEventListener("load", async ()=>{
  const passesCol = collection(db,"passes");
  const timeSlotsDoc = doc(db,"settings","timeSlots");

  let latestPasses = [];
  let slots = [];
  let limits = [];

  onSnapshot(timeSlotsDoc,snap=>{
    const data = snap.data();
    if(data?.slots){
      slots=[]; limits=[];
      data.slots.forEach(f=>{
        const gen = generateTimeBlocks(f.start,f.end,f.interval||10);
        slots.push(...gen);
        for(let i=0;i<gen.length;i++) limits.push(f.limit||1);
      });
    }
    updateUI(latestPasses,slots,limits);
  });

  onSnapshot(passesCol,snap=>{
    latestPasses = snap.docs.map(d => ({...d.data(), docId:d.id}));
    updateUI(latestPasses,slots,limits);
  });

  let isSubmitting=false;
  document.getElementById("form").addEventListener("submit", async(e)=>{
    e.preventDefault();
    if(isSubmitting) return;
    isSubmitting=true;

    const name=document.getElementById("name").value.trim();
    const num=parseInt(document.getElementById("people").value);
    if(!name||isNaN(num)||num<1){ alert("正しい名前と人数を入力してください"); isSubmitting=false; return; }
    if(!slots || slots.length===0 || !limits || limits.length===0){ alert("案内時間が設定されていません"); isSubmitting=false; return; }

    const nextTime = getNextAvailableSlot(slots,limits,latestPasses);
    if(!nextTime){ alert("本日の発券は終了しました"); isSubmitting=false; return; }

    const lastNum = latestPasses.length>0?Math.max(...latestPasses.map(p=>p.number||0)):0;
    const number = lastNum+1;
    const id = `FP${number.toString().padStart(3,"0")}`;
    const newPass = {id,number,name,people:num,time:nextTime,used:false,createdAt:serverTimestamp()};

    try{
      await addDoc(passesCol,newPass);
      savePassToLocal(newPass);
    } catch(err){ alert("発券失敗:"+err.message); }

    isSubmitting=false;
  });
});
</script>
</head>
<body>
<h1>プライオリティパス発券</h1>
<form id="form">
<input type="text" id="name" placeholder="名前" required><br>
<input type="number" id="people" placeholder="人数" required min="1"><br>
<button type="submit">発券する</button>
</form>
<div id="info"></div>
<div id="qrcode"></div>
</body>
</html>
