<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>プライオリティパス発券</title>
<style>
body { font-family:sans-serif; text-align:center; padding:20px; background:#f0f8ff; }
h1 { color:#0066cc; }
#qrcode { margin:20px auto; }
.ended,.used,.expired,.stopped,.notset { color:red; font-weight:bold; }
input { font-size:16px; padding:5px; margin:5px; width:200px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, doc, getDoc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebase初期化
const firebaseConfig = {
  apiKey:"AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
  authDomain:"fastpass-system.firebaseapp.com",
  projectId:"fastpass-system",
  storageBucket:"fastpass-system.appspot.com",
  messagingSenderId:"858745521872",
  appId:"1:858745521872:web:29289b673855097e1200d5"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// 今日の日付
function getTodayString() {
  const now = new Date();
  return `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,"0")}-${now.getDate().toString().padStart(2,"0")}`;
}

// ローカル保存
function savePassToLocal(pass) { localStorage.setItem("fp_pass", JSON.stringify({...pass,date:getTodayString()})); }
function loadPassFromLocal() {
  const saved = localStorage.getItem("fp_pass");
  if(!saved) return null;
  const data = JSON.parse(saved);
  return data.date===getTodayString()?data:null;
}

// 10分刻み生成
function generateTimeBlocks(start,end,interval=10){
  const blocks=[];
  const [sh,sm] = start.split(":").map(Number);
  const [eh,em] = end.split(":").map(Number);
  let s = new Date(); s.setHours(sh,sm,0,0);
  const e = new Date(); e.setHours(eh,em,0,0);
  while(s<e){
    const next=new Date(s.getTime()+interval*60000);
    if(next>e) break;
    const pad=n=>n.toString().padStart(2,"0");
    blocks.push(`${pad(s.getHours())}:${pad(s.getMinutes())}〜${pad(next.getHours())}:${pad(next.getMinutes())}`);
    s.setMinutes(s.getMinutes()+interval);
  }
  return blocks;
}

// 次の空きスロット
function getNextAvailableSlot(slots,limits,passes){
  const now = new Date();
  const nowMinutes = now.getHours()*60 + now.getMinutes();
  const counts = slots.map(slot => passes.filter(p => p.time===slot).length);
  const available=[];
  for(let i=0;i<slots.length;i++){
    if(counts[i]<limits[i]){
      const [h,m] = slots[i].split("〜")[0].split(":").map(Number);
      if(h*60+m>=nowMinutes) available.push({slot:slots[i], index:i, minutes:h*60+m});
    }
  }
  available.sort((a,b)=>a.minutes-b.minutes);
  return available.length>0?available[0].slot:null;
}

// QR描画
function drawQRCode(id){
  const qrContainer=document.getElementById("qrcode");
  qrContainer.innerHTML="";
  QRCode.toCanvas(document.createElement("canvas"),id,{width:200},(err,canvas)=>{
    if(!err) qrContainer.appendChild(canvas);
  });
}

// UI更新
function updateUI(latestPasses,slots,limits){
  const info=document.getElementById("info");
  const saved = loadPassFromLocal();
  if(!slots || slots.length===0 || !limits || limits.length===0){
    info.innerHTML='<p class="notset">案内時間が設定されていません</p>'; return;
  }
  if(saved){
    const passInDb = latestPasses.find(p=>p.id===saved.id);
    const used = passInDb?.used||false;
    saved.used=used;
    if(used) savePassToLocal(saved);

    const [sh,sm] = saved.time.split("〜")[0].split(":").map(Number);
    const [eh,em] = saved.time.split("〜")[1].split(":").map(Number);
    const startDate = new Date(); startDate.setHours(sh,sm,0,0);
    const endDate = new Date(); endDate.setHours(eh,em,0,0);
    const now = new Date();

    info.innerHTML=`<h2 class="${used?'used':now>endDate?'expired':''}">${used?'使用済み':now>endDate?'無効（時間切れ）':now<startDate?'案内時刻前です':'現在案内中'}</h2>
      <p>番号：${saved.id}</p>
      <p>名前：${saved.name}</p>
      <p>人数：${saved.people}</p>
      <p>案内時間：${saved.time}</p>`;
    drawQRCode(saved.id);
    return;
  }

  const nextTime = getNextAvailableSlot(slots,limits,latestPasses);
  if(!nextTime){
    info.innerHTML='<p class="ended">本日のプライオリティパスは全て発券終了しました</p>';
  } else {
    info.innerHTML=`<p>次の案内時刻：<strong>${nextTime}</strong></p>`;
  }
}

// 初期処理
window.addEventListener("load", async ()=>{
  const passesCol = collection(db,"passes");
  const timeSlotsDoc = doc(db,"settings","timeSlots");
  const issueStatusDoc = doc(db,"settings","issueStatus");

  let latestPasses = [];
  let slots = [];
  let limits = [];

  // 時間帯取得
  onSnapshot(timeSlotsDoc,snap=>{
    const data = snap.data();
    if(data?.slots){
      slots = []; limits = [];
      data.slots.forEach(f=>{
        const gen = generateTimeBlocks(f.start,f.end,f.interval||10);
        slots.push(...gen);
        for(let i=0;i<gen.length;i++) limits.push(f.limit||1);
      });
    }
    updateUI(latestPasses,slots,limits);
  });

  // 発券状況監視
  onSnapshot(passesCol,snap=>{
    latestPasses = snap.docs.map(d=>d.data());
    updateUI(latestPasses,slots,limits);
  });

  // 発券処理
  let isSubmitting=false;
  document.getElementById("form").addEventListener("submit", async(e)=>{
    e.preventDefault();
    if(isSubmitting) return;
    isSubmitting=true;

    const name=document.getElementById("name").value.trim();
    const num=parseInt(document.getElementById("people").value);
    if(!name||isNaN(num)||num<1){ alert("正しい名前と人数を入力してください"); isSubmitting=false; return; }
    if(!slots || slots.length===0 || !limits || limits.length===0){ alert("案内時間が設定されていません"); isSubmitting=false; return; }

    const nextTime = getNextAvailableSlot(slots,limits,latestPasses);
    if(!nextTime){ alert("本日の発券は終了しました"); isSubmitting=false; return; }

    const lastNum = latestPasses.length>0?Math.max(...latestPasses.map(p=>p.number||0)):0;
    const number = lastNum+1;
    const id = `FP${number.toString().padStart(3,"0")}`;
    const newPass = {id,number,name,people:num,time:nextTime,used:false,createdAt:serverTimestamp()};

    try{ await addDoc(passesCol,newPass); savePassToLocal(newPass); } 
    catch(err){ alert("発券失敗:"+err.message); }
    isSubmitting=false;
  });
});
</script>
</head>
<body>
<h1>プライオリティパス発券</h1>
<div id="info"></div>
<form id="form">
<input type="text" id="name" placeholder="名前" required>
<input type="number" id="people" placeholder="人数" required min="1">
</form>
<div id="qrcode"></div>
</body>
</html>
