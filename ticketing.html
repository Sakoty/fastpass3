<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ãƒ—ãƒ©ã‚¤ã‚ªãƒªãƒ†ã‚£ãƒ‘ã‚¹ç™ºåˆ¸</title>
<style>
body { font-family: "Segoe UI", sans-serif; background:#f0f4f8; margin:0; padding:20px; }
h1 { text-align:center; color:#004080; margin-bottom:20px; }
form {
  max-width:340px; margin:0 auto 20px auto; padding:20px;
  background:#fff; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.15);
}
input, select, button {
  width:100%; font-size:16px; padding:10px; margin:8px 0;
  border-radius:6px; border:1px solid #ccc; box-sizing:border-box;
}
button {
  background:#0066cc; color:#fff; border:none; cursor:pointer; font-weight:bold;
}
button:hover { background:#0052a3; }
#info { text-align:center; margin:20px auto; font-size:18px; }

.ticket-card {
  max-width:360px; margin:20px auto; padding:20px;
  background:#fff; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.2);
  text-align:center;
}
.ticket-card h2 { margin:0 0 10px; font-size:22px; color:#004080; }
.ticket-card p { margin:6px 0; font-size:16px; }
.ticket-card .status {
  font-size:18px; font-weight:bold; margin-bottom:12px;
}
.ticket-card.used { border:2px solid #999; }
.ticket-card.expired { border:2px solid #cc0000; }
.ticket-card.active { border:2px solid #009933; }

#qrcode { margin:20px auto; }
.ended,.notset { color:red; font-weight:bold; }
</style>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, doc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebaseè¨­å®š
const firebaseConfig = {
  apiKey:"AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
  authDomain:"fastpass-system.firebaseapp.com",
  projectId:"fastpass-system",
  storageBucket:"fastpass-system.appspot.com",
  messagingSenderId:"858745521872",
  appId:"1:858745521872:web:29289b673855097e1200d5"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

function getTodayString() {
  const now = new Date();
  return `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,"0")}-${now.getDate().toString().padStart(2,"0")}`;
}
function savePassToLocal(pass) { localStorage.setItem("fp_pass", JSON.stringify({...pass,date:getTodayString()})); }
function loadPassFromLocal() {
  const saved = localStorage.getItem("fp_pass");
  if(!saved) return null;
  const data = JSON.parse(saved);
  return data.date===getTodayString()?data:null;
}

function generateTimeBlocks(start,end,interval=10){
  const blocks=[];
  const [sh,sm] = start.split(":").map(Number);
  const [eh,em] = end.split(":").map(Number);
  let s = new Date(); s.setHours(sh,sm,0,0);
  const e = new Date(); e.setHours(eh,em,0,0);
  while(s<e){
    const next=new Date(s.getTime()+interval*60000);
    if(next>e) break;
    const pad=n=>n.toString().padStart(2,"0");
    blocks.push(`${pad(s.getHours())}:${pad(s.getMinutes())}ã€œ${pad(next.getHours())}:${pad(next.getMinutes())}`);
    s.setMinutes(s.getMinutes()+interval);
  }
  return blocks;
}

function drawQRCode(id){
  const qrContainer=document.getElementById("qrcode");
  qrContainer.innerHTML="";
  QRCode.toCanvas(document.createElement("canvas"),id,{width:200},(err,canvas)=>{
    if(!err) qrContainer.appendChild(canvas);
  });
}

// UIæ›´æ–°
function updateUI(latestPasses,slots,limits){
  const info=document.getElementById("info");
  info.innerHTML="";
  const form = document.getElementById("form");
  const saved = loadPassFromLocal();

  if(!slots || slots.length===0){
    info.innerHTML='<p class="notset">æ¡ˆå†…æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
    form.style.display="none";
    return;
  }

  // ç™ºåˆ¸æ¸ˆã¿ãƒ‘ã‚¹ãŒã‚ã‚‹å ´åˆ
  if(saved){
    const passInDb = latestPasses.find(p=>p.id===saved.id);
    const used = passInDb?.used||false;
    saved.used=used;
    if(used) savePassToLocal(saved);

    const [sh,sm] = saved.time.split("ã€œ")[0].split(":").map(Number);
    const [eh,em] = saved.time.split("ã€œ")[1].split(":").map(Number);
    const startDate = new Date(); startDate.setHours(sh,sm,0,0);
    const endDate = new Date(); endDate.setHours(eh,em,0,0);
    const now = new Date();

    let statusText="ç¾åœ¨æ¡ˆå†…ä¸­", cls="active";
    if(used){ statusText="ä½¿ç”¨æ¸ˆã¿"; cls="used"; }
    else if(now>endDate){ statusText="ç„¡åŠ¹ï¼ˆæ™‚é–“åˆ‡ã‚Œï¼‰"; cls="expired"; }
    else if(now<startDate){ statusText="æ¡ˆå†…æ™‚åˆ»å‰ã§ã™"; cls="active"; }

    info.innerHTML=`<div class="ticket-card ${cls}">
        <div class="status">${statusText}</div>
        <h2>ç•ªå·ï¼š${saved.id}</h2>
        <p>åå‰ï¼š${saved.name}</p>
        <p>äººæ•°ï¼š${saved.people}</p>
        <p>æ¡ˆå†…æ™‚é–“ï¼š${saved.time}</p>
        <div id="qrcode"></div>
      </div>`;
    drawQRCode(saved.id);
    form.style.display="none";
    return;
  }

  // ç©ºãæ ãƒªã‚¹ãƒˆã‚’ä½œæˆ & æ®‹ã‚Šæ ãƒã‚§ãƒƒã‚¯
  let allFull = true;
  const select=document.getElementById("timeSelect");
  select.innerHTML="";
  slots.forEach((slot,i)=>{
    const count=latestPasses.filter(p=>p.time===slot).length;
    const left=limits[i]-count;
    const opt=document.createElement("option");
    opt.value=slot;
    opt.textContent=`${slot}ï¼ˆæ®‹ã‚Š${left}æ ï¼‰`;
    if(left<=0){ opt.disabled=true; opt.textContent+= "ã€æº€å“¡ã€‘"; } else { allFull=false; }
    select.appendChild(opt);
  });

  if(allFull){
    form.style.display="none";
    info.innerHTML='<p class="ended">æœ¬æ—¥ã®ãƒ—ãƒ©ã‚¤ã‚ªãƒªãƒ†ã‚£ãƒ‘ã‚¹ã¯å…¨ã¦ç™ºåˆ¸çµ‚äº†ã—ã¾ã—ãŸ</p>';
  } else {
    form.style.display="block";
  }
}

window.addEventListener("load", ()=>{
  const passesCol = collection(db,"passes");
  const timeSlotsDoc = doc(db,"settings","timeSlots");

  let latestPasses = [];
  let slots = [];
  let limits = [];

  onSnapshot(timeSlotsDoc,snap=>{
    const data = snap.data();
    if(data?.slots){
      slots = []; limits = [];
      data.slots.forEach(f=>{
        const gen = generateTimeBlocks(f.start,f.end,f.interval||10);
        slots.push(...gen);
        for(let i=0;i<gen.length;i++) limits.push(f.limit||1);
      });
    }
    updateUI(latestPasses,slots,limits);
  });

  onSnapshot(passesCol,snap=>{
    latestPasses = snap.docs.map(d=>d.data());
    updateUI(latestPasses,slots,limits);
  });

  let isSubmitting=false;
  document.getElementById("form").addEventListener("submit",async(e)=>{
    e.preventDefault();
    if(isSubmitting) return;
    isSubmitting=true;

    const name=document.getElementById("name").value.trim();
    const num=parseInt(document.getElementById("people").value);
    const time=document.getElementById("timeSelect").value;
    if(!name||isNaN(num)||num<1||!time){ alert("æ­£ã—ã„æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); isSubmitting=false; return; }

    const lastNum = latestPasses.length>0?Math.max(...latestPasses.map(p=>p.number||0)):0;
    const number = lastNum+1;
    const id = `FP${number.toString().padStart(3,"0")}`;
    const newPass = {id,number,name,people:num,time,used:false,createdAt:serverTimestamp()};

    try{ await addDoc(passesCol,newPass); savePassToLocal(newPass); }
    catch(err){ alert("ç™ºåˆ¸å¤±æ•—:"+err.message); }
    isSubmitting=false;
  });
});
</script>
</head>
<body>
<h1>ãƒ—ãƒ©ã‚¤ã‚ªãƒªãƒ†ã‚£ãƒ‘ã‚¹ç™ºåˆ¸</h1>
<form id="form">
  <input type="text" id="name" placeholder="åå‰" required>
  <input type="number" id="people" placeholder="äººæ•°" required min="1">
  <select id="timeSelect" required></select>
  <button type="submit">ğŸŸï¸ ç™ºåˆ¸ã™ã‚‹</button>
</form>
<div id="info"></div>
</body>
</html>
