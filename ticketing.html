<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>プライオリティパス発券</title>
<style>
/* （CSSはそのまま残す） */
body { font-family: "Segoe UI", sans-serif; background:#f0f4f8; margin:0; padding:20px; }
h1 { text-align:center; color:#004080; margin-bottom:20px; }
form {
  max-width:340px; margin:0 auto 20px auto; padding:20px;
  background:#fff; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.15);
}
input, select, button {
  width:100%; font-size:16px; padding:10px; margin:8px 0;
  border-radius:6px; border:1px solid #ccc; box-sizing:border-box;
}
button {
  background:#0066cc; color:#fff; border:none; cursor:pointer; font-weight:bold;
}
button:hover { background:#0052a3; }
#info { text-align:center; margin:20px auto; font-size:18px; }

.ticket-card {
  max-width:360px; margin:20px auto; padding:20px;
  background:#fff; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.2);
  text-align:center;
}
.ticket-card h2 { margin:0 0 10px; font-size:22px; color:#004080; }
.ticket-card p { margin:6px 0; font-size:16px; }
.ticket-card .status { font-size:18px; font-weight:bold; margin-bottom:12px; }
.ticket-card.used { border:2px solid #999; }
.ticket-card.expired { border:2px solid #cc0000; }
.ticket-card.active { border:2px solid #009933; }

#qrcode { margin:20px auto; }
.ended,.notset { color:red; font-weight:bold; }

/* 🔄 リロードボタン（中央下に固定） */
#reloadBtn {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #0066cc;
  color: #fff;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
#reloadBtn:hover {
  background: #0052a3;
}

/* 🔽 同意モーダル */
.modal {
  display:none;
  position:fixed;
  z-index:1000;
  left:0; top:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.5);
  overflow:auto;
}
.modal-content {
  background:#fff;
  margin:10% auto;
  padding:20px;
  border-radius:10px;
  max-width:400px;
  max-height:80vh;   /* ✅ 高さ制限 */
  overflow-y:auto;   /* ✅ スクロール可能 */
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
}
.modal-buttons {
  margin-top:20px;
  display:flex;
  flex-direction:column; /* ✅ 縦配置 */
  gap:14px;
}
.modal-buttons button {
  width:100%;
  padding:16px;
  font-size:17px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
#agreeBtn { background:#0066cc; color:#fff; font-weight:bold; }
#cancelBtn.cancel { background:#eee; color:#333; }

/* 🔽 発券不可モーダル */
#notifyModal {
  display:none;
  position:fixed;
  z-index:1100;
  left:0; top:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.5);
}
#notifyModal .modal-content {
  background:#fff;
  margin:20% auto;
  padding:20px;
  border-radius:10px;
  max-width:350px;
  text-align:center;
}
#notifyCloseBtn {
  margin-top:20px;
  padding:12px;
  font-size:16px;
  border:none;
  border-radius:8px;
  background:#0066cc;
  color:#fff;
  cursor:pointer;
}
#notifyCloseBtn:hover { background:#0052a3; }

</style>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebase設定
const firebaseConfig = {
  apiKey:"AIzaSyDibHDpFtKBSCScK0QmB5xjKdBniS2EI1Y",
  authDomain:"fastpass-system.firebaseapp.com",
  projectId:"fastpass-system",
  storageBucket:"fastpass-system.appspot.com",
  messagingSenderId:"858745521872",
  appId:"1:858745521872:web:29289b673855097e1200d5"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- localStorage --- 
function getTodayString() {
  const now = new Date();
  return `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,"0")}-${now.getDate().toString().padStart(2,"0")}`;
}
function savePassToLocal(pass) { localStorage.setItem("fp_pass", JSON.stringify({...pass,date:getTodayString()})); }
function loadPassFromLocal() {
  const saved = localStorage.getItem("fp_pass");
  if(!saved) return null;
  const data = JSON.parse(saved);
  return data.date===getTodayString()?data:null;
}

// --- 時間ブロック生成 ---
function generateTimeBlocks(start,end,interval=10){
  const blocks=[];
  const [sh,sm] = start.split(":").map(Number);
  const [eh,em] = end.split(":").map(Number);
  let s = new Date(); s.setHours(sh,sm,0,0);
  const e = new Date(); e.setHours(eh,em,0,0);
  while(s<e){
    const next=new Date(s.getTime()+interval*60000);
    if(next>e) break;
    const pad=n=>n.toString().padStart(2,"0");
    blocks.push(`${pad(s.getHours())}:${pad(s.getMinutes())}〜${pad(next.getHours())}:${pad(next.getMinutes())}`);
    s.setMinutes(s.getMinutes()+interval);
  }
  return blocks;
}

// --- QRコード ---
function drawQRCode(id){
  const qrContainer=document.getElementById("qrcode");
  qrContainer.innerHTML="";
  QRCode.toCanvas(document.createElement("canvas"),id,{width:200},(err,canvas)=>{ if(!err) qrContainer.appendChild(canvas); });
}

// --- UI更新 ---
async function updateUI(latestPasses,slots,limits,issueActive){
  const info=document.getElementById("info");
  const form=document.getElementById("form");
  const saved=loadPassFromLocal();
  const now=new Date();

  if(!issueActive && !saved){
    form.style.display="none";
    info.innerHTML='<p class="ended">現在プライオリティパスの発券は一時中止中です</p>';
    return;
  }

  if(!slots || slots.length===0){
    info.innerHTML='<p class="notset">案内時間が設定されていません</p>';
    form.style.display="none";
    return;
  }

  if(saved){
    const passInDb=latestPasses.find(p=>p.id===saved.id);
    const used=passInDb?.used||false;
    saved.used=used;

    const [sh,sm]=saved.time.split("〜")[0].split(":").map(Number);
    const [eh,em]=saved.time.split("〜")[1].split(":").map(Number);
    const startDate=new Date(); startDate.setHours(sh,sm,0,0);
    const endDate=new Date(); endDate.setHours(eh,em,0,0);

    let statusText="現在案内中", cls="active", newStatus="使用可能";
    if(used){ statusText="使用済み"; cls="used"; newStatus="使用済み"; }
    else if(now>endDate){ statusText="無効（時間切れ）"; cls="expired"; newStatus="期限切れ"; }
    else if(now<startDate){ statusText="案内時刻前です"; cls="active"; newStatus="未使用"; }

    if(passInDb && passInDb.status!==newStatus){
      const passDocRef = doc(db,"passes",passInDb._docId || passInDb.id);
      try { await updateDoc(passDocRef,{status:newStatus}); } catch(e){ console.warn("status更新失敗",e); }
    }

    info.innerHTML=`<div class="ticket-card ${cls}">
      <div class="status">${statusText}</div>
      <h2>番号：${saved.id}</h2>
      <p>名前：${saved.name}</p>
      <p>人数：${saved.people}</p>
      <p>案内時間：${saved.time}</p>
      <div id="qrcode"></div>
    </div>`;
    drawQRCode(saved.id);
    form.style.display="none";
    return;
  }

  let allFull=true;
  const select=document.getElementById("timeSelect");
  select.innerHTML="";
  slots.forEach((slot,i)=>{
    const [sh,sm]=slot.split("〜")[0].split(":").map(Number);
    const slotStart=new Date(); slotStart.setHours(sh,sm,0,0);
    if(slotStart<now) return;

    const count=latestPasses.filter(p=>p.time===slot).length;
    const left=limits[i]-count;
    const opt=document.createElement("option");
    opt.value=slot;
    opt.textContent=`${slot}（残り${left}枠）`;
    if(left<=0){ opt.disabled=true; opt.textContent+="【満員】"; } else { allFull=false; }
    select.appendChild(opt);
  });

  if(allFull){
    form.style.display="none";
    info.innerHTML='<p class="ended">本日のプライオリティパスは全て発券終了しました</p>';
  } else {
    form.style.display="block";
    info.innerHTML="";
  }
}

// --- 初期処理 ---
window.addEventListener("load", ()=>{
  const passesCol=collection(db,"passes");
  const timeSlotsDoc=doc(db,"settings","timeSlots");
  const issueStatusDoc=doc(db,"settings","issueStatus");

  let latestPasses=[]; let slots=[]; let limits=[]; let issueActive=true;
  let isSubmitting=false; let pendingSubmit=null;

  onSnapshot(issueStatusDoc,snap=>{
    const data=snap.data();
    issueActive=data?.enabled ?? true;
    updateUI(latestPasses,slots,limits,issueActive);
  });

  onSnapshot(timeSlotsDoc,snap=>{
    const data=snap.data();
    if(data?.slots){
      slots=[]; limits=[];
      data.slots.forEach(f=>{
        const gen=generateTimeBlocks(f.start,f.end,f.interval||10);
        slots.push(...gen);
        for(let i=0;i<gen.length;i++) limits.push(f.limit||1);
      });
    }
    updateUI(latestPasses,slots,limits,issueActive);
  });

  onSnapshot(passesCol,snap=>{
    latestPasses=snap.docs.map(d=>({...d.data(),_docId:d.id}));
    updateUI(latestPasses,slots,limits,issueActive);
  });

 // --- 発券処理 ---
document.getElementById("form").addEventListener("submit",(e)=>{
  e.preventDefault();
  if(isSubmitting) return;

  const name=document.getElementById("name").value.trim();
  const num=parseInt(document.getElementById("people").value);
  const time=document.getElementById("timeSelect").value;
  if(!name||isNaN(num)||num<1||!time){
    alert("正しい情報を入力してください");
    return;
  }

  pendingSubmit={name,people:num,time};

  document.getElementById("consentModal").style.display="block";
});

document.getElementById("agreeBtn").addEventListener("click", async()=>{
  if(!document.getElementById("consentCheck").checked){
    alert("同意にチェックしてください");
    return;
  }
  if(!pendingSubmit) return;
  isSubmitting=true;

  try {
    // 🔹 Firestoreトランザクションで番号重複防止
    const counterDoc = doc(db, "counters", "fpNumber");
    const passesCol = collection(db, "passes");

    await db.runTransaction(async (t)=>{
      const counterSnap = await t.get(counterDoc);
      const lastNum = counterSnap.exists() ? counterSnap.data().lastNum : 0;
      const newNum = lastNum + 1;
      const id = `FP${newNum.toString().padStart(3,"0")}`;

      // 枠チェック（抽選）
      const q = await passesCol.where("time","==",pendingSubmit.time).get();
      const slotPasses = q.docs.map(d=>d.data());
      const slotIndex = slots.indexOf(pendingSubmit.time);
      const limit = limits[slotIndex] || 1;

      let isWinner = true;
      if(slotPasses.length >= limit){
        // 抽選
        const candidates = [...slotPasses, {...pendingSubmit, id}];
        const shuffled = candidates.sort(()=>Math.random()-0.5);
        const winners = shuffled.slice(0, limit);
        isWinner = winners.some(p => p.id===id);
      }

      if(isWinner){
        const newPass = {
          ...pendingSubmit,
          id,
          number:newNum,
          used:false,
          status:"未使用",
          createdAt:serverTimestamp()
        };
        const docRef = doc(passesCol);
        t.set(docRef, newPass);
        t.set(counterDoc, { lastNum: newNum }, { merge:true });

        savePassToLocal(newPass);
      } else {
        // 外れの場合はモーダル表示
        document.getElementById("notifyModal").style.display="block";
      }
    });

    document.getElementById("consentModal").style.display="none";
    pendingSubmit=null;
  } catch(err){
    alert("発券失敗:" + err.message);
    console.error(err);
  }

  isSubmitting=false;
});


  // 🔄 リロードボタン
  document.getElementById("reloadBtn").addEventListener("click", ()=>{ location.reload(); });
});
</script>
</head>
<body>
<h1>プライオリティパス発券</h1>
<form id="form">
  <input type="text" id="name" placeholder="名前" required>
  <input type="number" id="people" placeholder="人数" required min="1">
  <select id="timeSelect" required></select>
  <button type="submit">🎟️ 発券する</button>
</form>
<div id="info"></div>
<div id="qrcode"></div>

<!-- 🔄 リロードボタン -->
<button id="reloadBtn">🔄 更新</button>

<!-- 🔽 同意モーダル -->
<div id="consentModal" class="modal">
  <div class="modal-content">
    <h2>利用に関する同意事項</h2>
    <p>
      ・プライオリティパスは指定の時間のみ有効です。<br>
      ・案内時間前や有効期限切れの場合はご利用できない場合があります。<br>
      ・一度使用済みになったパスは再利用できません。<br>
      ・体調のすぐれない方や、暗闇が苦手な方、骨折等のけがをしている方、心臓に疾患のある方のご利用はお控えください。<br>
      ・小学生以下の方は、必ず保護者の方の確認が必須です。<br>
      ・体重・体格等で安全な運行が不可能だと係員が判断した場合、ご利用をお断りする場合があります。
    </p>
    <label style="display:block; margin-top:10px;">
      <input type="checkbox" id="consentCheck"> 上記内容に同意します
    </label>
    <div class="modal-buttons">
      <button id="agreeBtn">同意して発券</button>
      <button id="cancelBtn" class="cancel">キャンセル</button>
    </div>
  </div>
</div>

<!-- 🔽 発券不可モーダル -->
<div id="notifyModal" class="modal">
  <div class="modal-content">
    <p>残念ながら、今回の時間帯は発券枠がいっぱいです。</p>
    <button id="notifyCloseBtn">閉じる</button>
  </div>
</div>
</body>
</html>
